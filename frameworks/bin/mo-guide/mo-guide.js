var mo;!function(e){var t;!function(t){var n=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var n=(__define,t),r=n.prototype;return r._initProp=function(){e.prototype._initProp.call(this);var t=this;t.type=1,t.npcIndex=0,t.toSave=!0,t.option={}},r.set=function(e,t,n){var r=this;null!=t&&(r[e]=n?!!t:t)},t}(egret.Emitter);t.CmdCfg=n,egret.registerClass(n,"mo.GUIDE.CmdCfg");var r=function(n){function r(){n.apply(this,arguments)}__extends(r,n);var i=__define,a=r,o=a.prototype;return i(o,"id",function(){return this.cfg.id}),i(o,"grpId",function(){var e=this.id.split("_");return parseInt(e[0])}),i(o,"cmdIndex",function(){var e=this.id.split("_");return parseInt(e[1])}),o._doBaseCondition=function(){return!0},o.canExec=function(e){var n=this;if(n.mgr.paused||!e||!e.activated||!n.mgr.doBaseCondition(n))return!1;if(n.layer=e,t.handlerMgr.handle(n.cfg,"condition",n)&&n._handleActions())return!0;if(n._execing){var r=n.mgr,i=n.cfg;n.close(),n._execing=!1,r.initCmd(i.id,!1),n.doDtor()}return!1},o._onAction=function(){var e=this;e.actionState=2,e.exec(e.mgr.getLayer(e.cfg.layer))},o._handleActions=function(){var n=this;if(2==n.actionState)return!0;if(1==n.actionState)return!1;var r=t.handlerMgr.handle(n.cfg,"actions",n,!1);return r===!0||null==r?!0:(n.actionState=1,n._actionListened||(n._actionListened=r,e.emitter.on(r,n._onAction,n)),!1)},o._show=function(){var n=this;n._execing||(n._doingStopTouch||(e.utils.stopTouch(),n._doingStopTouch=!0),t.handlerMgr.handleAsync(n.cfg,"beforeShow",n,function(r){if(r){"string"==typeof r&&(r=[r]);var i=n.mgr;if(n.close(),r instanceof Array)for(var a=0;a<r.length;++a)i.initCmd(r[a],!1)}else if(!n._handlePause()&&!n._execing){n._execing=!0;var o=n.mgr.getUIClass(n.cfg.type);n.ui=o.create().setData({cmd:n}).show(),n._doingStopTouch&&(e.utils.resumeTouch(),n._doingStopTouch=!1),t.handlerMgr.handle(n.cfg,"afterShow",n)}}))},o._handlePause=function(){var e=this,t=e.mgr,n=e.id;if(t.paused){e.close();var r=t._recovers;return r.indexOf(n)<0&&r.push(n),!0}return!1},o.exec=function(e){var t=this;t.canExec(e)&&t._show()},o.doNext=function(){var e=this;if(e._execing){var n=e.cfg;t.handlerMgr.handleAsync(n,"beforeNext",e,function(){if(!e._handlePause()&&e._execing){e._execing=!1;var r=n.route,i=e.ui;if(r){i.visible=!1;var a=e.mgr.net,o=function(){a.unRouteSuccess(r,o,null),a.unRouteError(r,s,null),i.close(),e.mgr.gotoNext(e),t.handlerMgr.handle(n,"afterNext",e)},s=function(){a.unRouteSuccess(r,o,null),a.unRouteError(r,s,null),e.close(),e.mgr.initCmd(e.id)};a.onRouteSuccess(r,o,null),a.onRouteError(r,s,null)}else i.close(),e.mgr.gotoNext(e),t.handlerMgr.handle(n,"afterNext",e)}})}},o.close=function(){var e=this,t=e.ui;t&&t.close(),delete e.mgr.cmdMap[e.id],e.doDtor()},o._onActivated=function(t){var n=this,r=n.cfg.layer,i=n._onInactivated,a=e.inactivatedEmitter;a.un(r,i,n),a.on(r,i,n),n.exec(t)},o._onInactivated=function(t){var n=this,r=n.cfg.layer;if(e.inactivatedEmitter.un(r,n._onInactivated,n),n._execing){var i=n.mgr,a=n.cfg;n.close(),n._execing=!1,i.initCmd(a.id,!1),n.doDtor()}},o._onRefreshEvent=function(){this.exec(this.mgr.getLayer(this.cfg.layer))},o.initEvents=function(){var t=this,n=t.cfg.layer,r=t.cfg.refreshEvent;e.activatedEmitter.on(n,t._onActivated,t),!t._refreshEventListened&&r&&(t._refreshEventListened=!0,e.emitter.on(r,t._onRefreshEvent,t))},o.rmEvents=function(){var t=this,n=t.cfg.layer,r=t.cfg.refreshEvent;t._actionListened&&e.emitter.un(t._actionListened,t._onAction,t),e.activatedEmitter.un(n,t._onActivated,t),r&&(e.emitter.un(r,t._onRefreshEvent,t),t._refreshEventListened=!1)},o._onBeforeLayerVisible=function(){},o._onAfterLayerVisible=function(e){e.sender},o.dtor=function(){n.prototype.dtor.call(this);var t=this;t.rmEvents(),t._doingStopTouch&&(e.utils.resumeTouch(),t._doingStopTouch=!1)},o.getNode=function(){var n=this,r=n.cfg,i=t.handlerMgr.handle(r,"node",n,!1);return i?"object"==typeof i?i:e.gui.helper.getChild(n.layer,i):null},o.getRectNode=function(){var n=this,r=n.cfg,i=t.handlerMgr.handle(r,"rectNode",n,!1);return i?"object"==typeof i?i:e.gui.helper.getChild(n.layer,i):n.getNode()},r}(egret.Emitter);t.Cmd=r,egret.registerClass(r,"mo.GUIDE.Cmd")}(t=e.GUIDE||(e.GUIDE={}))}(mo||(mo={}));var mo;!function(e){var t;!function(t){var n=function(t){function n(){t.apply(this,arguments)}__extends(n,t);var r=(__define,n),i=r.prototype;return i._initProp=function(){t.prototype._initProp.call(this);var e=this;e._handlers={}},i._getInfo=function(t,n){var r=this._handlers[n];if(r){var i=t.split(":"),a=r._map[i[0]];if(a){var o=[],s=i[1];if(null!=s)for(var u=s.split(","),c=0,l=u.length;l>c;c++)o.push(e.STR.parseNumOrStr(u[c]));return{func:a.func,ctx:a.ctx,params:o}}}return null},i.handle=function(e,t,n,r){void 0===r&&(r=!0);var i=this,a=e[t];if(!a)return r?!0:null;var o=i._getInfo(a,t);return o?o.func.call(o.ctx,o.params,n):r?!0:a},i.handleAsync=function(e,t,n,r){var i=this,a=e[t];if(!a)return r();var o=i._getInfo(a,t);return o?o.func.call(o.ctx,o.params,n,r):void 0},i.set=function(e,t){this._handlers[e]=t},n}(egret.Emitter);t.HandlerMgr=n,egret.registerClass(n,"mo.GUIDE.HandlerMgr"),t.handlerMgr=new n;var r=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var n=(__define,t),r=n.prototype;return r._initProp=function(){e.prototype._initProp.call(this),this._map={}},r.set=function(e,t,n){this._map[e]={func:t,ctx:n}},r.get=function(e){return this._map[e]},r.handle=function(e,t){var n=this,r=n._map[e];return r?r.func.call(r.ctx,t):!0},t}(egret.Emitter);t.CfgHandler=r,egret.registerClass(r,"mo.GUIDE.CfgHandler")}(t=e.GUIDE||(e.GUIDE={}))}(mo||(mo={}));var mo;!function(e){var t;!function(t){var n=function(t){function n(){t.apply(this,arguments)}__extends(n,t);var r=(__define,n),i=r.prototype;return i._initProp=function(){t.prototype._initProp.call(this);var e=this;e._trayName="guide",e.penetrable=!1,e.touchEnabled=!1,e._touchNames=[],e._layerOpt.activateUnderDisabled=!0},i._childrenCreated=function(){t.prototype._childrenCreated.call(this);var n=this,r=n._layerOpt.rect;r.touchEnabled=!1,r.touchChildren=!1;var i=n.data.cmd;n._onTouch({name:"mask",ui:n,targetGetter:n._getRect,targetGetterCtx:n,listeners:null,isMask:!0});var a=n.grp_btn;a&&(n._initEvents_btn(),a.x=a.y=-1e4),i.cfg.isHook&&e.tick(n._setBtnPos,n)},i._setBtnPos=function(){var e=this,t=e.data.cmd,n=t.getRectNode();if(n){var r=n.localToGlobal(n.width/2,n.height/2);e.grp_btn.x=r.x,e.grp_btn.y=r.y}},i._getRect=function(){return this._layerOpt.rect},i.dataChanged=function(){t.prototype.dataChanged.call(this);var e=this;e._setBtnPos()},i._initEvents_btn=function(){var e=this,t=egret.TouchEvent,n=e.data.cmd,r=e.grp_btn;r.hitTestPoint=function(){return!1},r.hitTest=function(){return null};var i={};i[t.TOUCH_BEGIN]=e._onTargetBegin,i[t.TOUCH_END]=e._onTargetEnd,e._onTouch({name:"tap",ui:e,targetGetter:n.getRectNode,targetGetterCtx:n,listeners:i,isMask:!1})},i._onTargetTap=function(){var e=this,t=e.data.cmd,n=e._target;n&&(e._target=null,n.removeEventListener(egret.TouchEvent.TOUCH_TAP,e._onTargetTap,e)),t.doNext()},i._onTargetBegin=function(){var e=this,t=e.data.cmd,n=t.getNode();e._isTargetBegin=!0,n&&(e._target=n,n.addEventListener(egret.TouchEvent.TOUCH_TAP,e._onTargetTap,e))},i._onTargetEnd=function(){var e=this,t=e._target,n=e._isTargetBegin;e._isTargetBegin=!1,n&&(t||e.data.cmd.doNext(),process.nextTick(function(){var t=e._target;t&&(t.removeEventListener(egret.TouchEvent.TOUCH_TAP,e._onTargetTap,e),e._target=null)}))},i._onTouch=function(t){var n=t.name,r=this._touchNames;r.indexOf(n)<0&&r.push(n),e.GUIDE.onTouch(t)},i.dtor=function(){t.prototype.dtor.call(this);for(var n=this,r=n._touchNames,i=0,a=r.length;a>i;i++)e.GUIDE.unTouch({name:r[i],ui:n});var o=n._target;o&&(o.removeEventListener(egret.TouchEvent.TOUCH_TAP,n._onTargetTap,n),n._target=null),e.clearTick(n._setBtnPos,n)},n}(e.gui.Layer);t.GuideLayer=n,egret.registerClass(n,"mo.GUIDE.GuideLayer")}(t=e.GUIDE||(e.GUIDE={}))}(mo||(mo={}));var egret;!function(e){var t;!function(e){e.guideEnabled=!0,e.registerValueHandler(function(t){e.setValue(t,"guideEnabled",!0)})}(t=e.project||(e.project={}))}(egret||(egret={}));var mo;!function(e){var t;!function(t){function n(n){for(var r=0,a=t._touchOpts.length;a>r;r++){var o=t._touchOpts[r];if(o.name==n.name&&o.ui==n.ui){t._touchOpts.splice(r,1);break}}if(t._touchOpts.push(n),!i){i=!0;var s=egret.MainContext.instance.stage,u=egret.TouchEvent,c=function(n){for(var r=n.type,i=t._touchOpts,a=!1,o=i.length-1;o>=0;o--){var s=i[o];if(!s.isMask){var c=s.types;if(!(c&&c.indexOf(r)<0)){var l=s.targetGetter.call(s.targetGetterCtx);if(r!=u.TOUCH_MOVE||s.movable||n.stopImmediatePropagation(),l&&e.gui.helper.isIn(l,n.stageX,n.stageY)){a=!0,e.debug("isIn");var d=s.listeners||{},g=d[r];g&&g.call(s.ui);break}}}}if(!a)for(var o=i.length-1;o>=0;o--){var s=i[o];if(s.isMask){var c=s.types;if(!(c&&c.indexOf(r)<0)){var l=s.targetGetter.call(s.targetGetterCtx);if(l){var f=s.ui,h=f.get("cmd");if(!h.cfg.penetrable&&e.gui.helper.isIn(l,n.stageX,n.stageY)){n.stopImmediatePropagation(),e.debug("stopPropagation");var d=s.listeners||{},g=d[r];g&&g.call(s.ui);break}}}}}};s.addEventListener(u.TOUCH_BEGIN,c,null,!0),s.addEventListener(u.TOUCH_MOVE,c,null,!0),s.addEventListener(u.TOUCH_END,c,null,!0),s.addEventListener(u.TOUCH_TAP,c,null,!0)}}function r(e){for(var n=0,r=t._touchOpts.length;r>n;n++){var i=t._touchOpts[n];if(i.name==e.name&&i.ui==e.ui)return void t._touchOpts.splice(n,1)}}var i=!1;t._touchMap={},t._touchOpts=[],t.onTouch=n,t.unTouch=r;var a=function(n){function r(){n.apply(this,arguments)}__extends(r,n);var i=(__define,r),a=i.prototype;return a._initProp=function(){n.prototype._initProp.call(this);var t=this;t._uiClassMap={},t.cmdMap={},t._recovers=[],e.emitter.on("pauseGuide",t._onPause,t),e.emitter.on("resumeGuide",t._onResume,t)},a.registerUI=function(e,t){this._uiClassMap[e]=t},a.getUIClass=function(e){return this._uiClassMap[e]},a.initCmd=function(e,n){void 0===n&&(n=!0);var r=this;if(!r.finished&&!r.cmdMap[e]){var i=r.parser.parse(e);if(i){var a=null,o=i.revert;if(n){if("n"==o)return r.setCmd(i);if(!o){var s=e.split("_")[0]+"_0";return e==s?r.setCmd(i):void r.initCmd(s)}a=t.handlerMgr.handle(i,"revert",null,!1),a?r.initCmd(a,!1):r.setCmd(i)}else r.setCmd(i)}}},a.setCmd=function(e){var n=this;if(!n.cmdMap[e.id]){var r=t.handlerMgr.handle(e,"judge",null,!1);if(r===!0||null==r){var i=new t.Cmd;i.mgr=n,i.cfg=e,n.cmdMap[e.id]=i;var a=n.getLayer(e.layer);i.initEvents(),i.exec(a)}else r===!1||r!=e.id&&n.initCmd(r,!1)}},a.gotoNext=function(e){var n,r=this,i=e.cfg,a=e.grpId,o=e.cmdIndex,s=i.next;delete r.cmdMap[i.id],e.doDtor(),s&&(s=t.handlerMgr.handle(i,"next",null,!1)),s&&(n=r.parser.parse(s),n||(s=t.handlerMgr.handle(i,"next",e,!1),s&&(n=r.parser.parse(s)))),n||(s=a+"_"+(o+1),n=r.parser.parse(s)),n||(s=a+1+"_0",n=r.parser.parse(s));var u;if(n?(r.setCmd(n),n.toSave&&(u=s)):i.toSave&&(u=i.id.split("_")[0]+"_10000"),u){var c={};c[r.route_arg_key]=u,r.net.request4Server(r.route,c,function(){},null)}},a._getLayer=function(t,n){var r=e.utils.getChildren(n);if(0==r.length)return null;for(var i=0,a=r.length;a>i;i++){var o=r[i];if(o.__className==t)return o}for(var i=0,a=r.length;a>i;i++){var s=this._getLayer(t,r[i]);if(s)return s}return null},a.getLayer=function(t){return this._getLayer(t,e.gui.uiScene)||this._getLayer(t,e.gui.infoScene)},a.onBaseCondition=function(e){this._onBaseCondition=e},a.doBaseCondition=function(e){return this._onBaseCondition?this._onBaseCondition(e):!0},a._onPause=function(){var e=this;e.paused=!0;var t=e.cmdMap,n=Object.keys(t),r=e._recovers;r.length=0;for(var i=0,a=n.length;a>i;++i){var o=n[i],s=t[o];s._execing&&(s.close(),r.push(o))}},a._onResume=function(){var e=this,t=e._recovers;e.paused=!1;for(var n=0,r=t.length;r>n;++n)e.initCmd(t[n],!1);var i=e.cmdMap;for(var a in i)if(t.indexOf(a)<0){var o=i[a];o.exec(e.getLayer(o.cfg.layer))}t.length=0},a.dtor=function(){n.prototype.dtor.call(this);var t=this;e.emitter.un("pauseGuide",t._onPause,t),e.emitter.un("resumeGuide",t._onResume,t)},r}(egret.Emitter);t.Mgr=a,egret.registerClass(a,"mo.GUIDE.Mgr"),t.mgr=new a}(t=e.GUIDE||(e.GUIDE={}))}(mo||(mo={}));