var g_fight;!function(e){e.isShowOffline=!1;var t=function(t){function i(){t.apply(this,arguments),this.isTreasureViewsShowing=!1,this.isTreasureViewsNeedRebuild=-1,this.getEnemyListLeftMillisecond=-1,this.sendTime=0}__extends(i,t);var n=(__define,i),o=n.prototype;return o._initProp=function(){t.prototype._initProp.call(this);var e=this;e.registerClassByKey(gd.FightCtrl,gd.FightCtrl.ON_START_PVP_FIGHT,e.onStartPvpFight),e.registerClassByKey(gd.FightCtrl,gd.FightCtrl.ON_ENTER_COPY,e.onEnterCopy),e.registerClassByKey(gd.HeroCtrl,gd.HeroCtrl.ON_CALL_HERO,e.onCallHero),e.registerClassByKey(gd.UserCtrl,gc.dsConsts.UserEntity.redPointData.toString(),e.checkRedPoint),e.registerClassByKey(gd.UserCtrl,gc.dsConsts.UserEntity.lvl.toString(),e.lvlChange),e.registerClassByKey(gd.UserCtrl,gc.dsConsts.UserEntity.exData.toString(),e.autoFightChange),e.registerClassByKey(gd.UserCtrl,gc.dsConsts.UserEntity.medalTitle.toString(),e.onMedalChange),e.registerClassByKey(gd.BossFightEntityCtrl,gc.dsConsts.BossData.curHp.toString(),e.worldBossCurHpChange),e.registerClassByKey(gd.BossFightEntityCtrl,gc.dsConsts.BossData.myHurt.toString(),e.worldBossMyHurtChange),e.registerClassByKey(gd.BossFightEntityCtrl,gc.dsConsts.BossData.inspireEndTime.toString(),e.worldBossGWTimeChange),e.registerClassByKey(gd.BossFightEntityCtrl,gd.BossFightEntityCtrl.ON_WORLD_BOSS_OPEN_CHANGE,e.onWorldBossOpenChanged),e.registerClassByKey(gd.RedEnvelopeCtrl,gd.RedEnvelopeCtrl.ON_REDENVELOPE_UPDATE,e.onRedEnvelopeChanged),e.registerClassByKey(gd.KingCtrl,gd.KingCtrl.ON_KING_BUFF_CHANGE,e.onKingBuffChanged),mo.emitter.on(gd.HeroCtrl.ON_FIGHT_HERO_CHANGE,e.onFightHeroChange,e),mo.emitter.on(gd.FightCtrl.ON_NEXT_LOOT,e.onNextLoot,e)},o.checkRedPoint=function(){var e=this;e.ico_red.visible=gd.pointCtrl.isShow(gc.c_prop.pointRedKey.pkout1),e.ico_bePkRed.visible=gd.pointCtrl.isShow(gc.c_prop.pointRedKey.bePkKill)},o.lvlChange=function(){var e,t=this,i=mo.getJSONWithFileName(gc.cfg_c_open);e=i[gc.id_c_open.autoFight][gc.c_open_lvlRequired],gd.userCtrl.getLvl()>=e?(gd.userCtrl.isAutoFight()&&mo.setLocalStorageItem("hasTapAuto",1),mo.getLocalStorageItem("hasTapAuto")?t.ico_autoLight.visible=!1:(t.ico_autoLight.visible=!0,egret.Tween.get(t.ico_autoLight,{loop:!0}).to({alpha:0},800).to({alpha:1},800))):t.ico_autoLight.visible=!1,t.label_noActive.visible=!gd.userCtrl.isAutoFight()},o.autoFightChange=function(){var e=this;e.ico_auto.source=gd.userCtrl.isAutoFight()?"ico_autofight_enable":"ico_autofight_disable",e.label_noActive.visible=!gd.userCtrl.isAutoFight()},o.onMedalChange=function(){e.mapView.onMedalChange()},o._childrenCreated=function(){t.prototype._childrenCreated.call(this);var i=this;if(gd.fightLayer=i,i.fightProfit=e.FightProfit.create().show(),i.baseMidBar=g_mid.BaseMidBar.create().show(),null==e.mapView){e.mapView=new e.MapView,e.mapView.y=42;var n=mo.getJSONWithFileNameAndID(gc.cfg_t_copy,gd.copyCtrl.getNormalCurCopyId()),o=n[gc.t_copy_displayID];e.mapView.enterMap(o,!0),e.mapView.checkNextWave();var r=new egret.gui.UIComponent;r.addChild(e.mapView)}i.resetPvpEnemyView(),i.onNextLoot(),i.checkRedPoint(),i.lvlChange(),i.autoFightChange(),i.onRedEnvelopeChanged(),i.onMedalChange(),i.grp_findPk&&(i.grp_findPk.visible=!1),i.ico_autoLight.touchEnabled=!1,i.eff_findingMonster.visible=e.mapView.isFindingMonster,e.mapView.addEventListener(e.MAP_EVENT_HPMP_CHANGE,i.updateHP,i),e.mapView.addEventListener(e.MAP_EVENT_IS_FINDING_MONSTER_CHANGE,i.isFindingMonsterChange,i),e.mapView.addEventListener(e.MAP_EVENT_WINCOUNT_CHANGE,i.onWinCountChange,i),e.mapView.addEventListener(e.MAP_EVENT_TOTAL_HURT_CHANGE,i.onTotalHurtChange,i),i.isFindingMonsterChange(),i.onWorldBossOpenChanged(),i.onKingBuffChanged(),i.onTotalHurtChange(),i.px_hp.labelFunction=i.barLabelFunction,i.ico_expBuff.source=resHelper.getBuffIconPath(1)},o.barLabelFunction=function(e,t){return mo.STR.format("%s/%s",utils.formatByWan(e),utils.formatByWan(t))},o._tap_icon_pkInfo=function(){var e=this;e.showOrHideTreasureView(!0)},o.onEnter=function(){t.prototype.onEnter.call(this);var i=this;i.addElement(e.mapView.parent),i.ico_auto.source=gd.userCtrl.isAutoFight()?"ico_autofight_enable":"ico_autofight_disable",e.mapView.pveType==gc.c_prop.fightTypeKey.worldBoss&&e.bossData&&i.checkBossView(),clearInterval(i.mpUpdateTimer),i.mpUpdateTimer=setInterval(function(){var t=gd.demonLotusCtrl.calGenuineQi();e.baseBottomBar.updateMP(t)},100),i.secondTimer=setInterval(function(){i.checkUIVisible()},1e3),i.checkUIVisible()},o.onExit=function(){var i=this;clearInterval(i.mpUpdateTimer);var n=e.mapView.parent.owner;n&&n==i&&n.removeElement(e.mapView.parent),t.prototype.onExit.call(this),i.timeTrigger&&(tm.timer.remove(i.timeTrigger),i.timeTrigger=null),i.gwTimeTrigger&&(tm.timer.remove(i.gwTimeTrigger),i.gwTimeTrigger=null),i.blTimeTrigger&&(tm.timer.remove(i.blTimeTrigger),i.blTimeTrigger=null),clearInterval(i.secondTimer),e.mapView.removeEventListener(e.MAP_EVENT_HPMP_CHANGE,i.updateHP,i),e.mapView.removeEventListener(e.MAP_EVENT_IS_FINDING_MONSTER_CHANGE,i.isFindingMonsterChange,i)},o.resetPvpEnemyView=function(){var e=this;gd.pkOutCtrl.checkOpen(function(t){t?gd.pkOutCtrl.getEnemyList(function(t){if(e.grp_pkEnemy){for(;e.grp_pkEnemy.numElements;)e.grp_pkEnemy.removeElementAt(0);e.setCDTime(gd.pkOutCtrl.getReRefreshSeconds()),0==t.length?(e.grp_pkEnemy.visible=!1,e.grp_leftTime.visible=!0):e.resetPvpEnemyViewOnlyDraw(t)}},e):e.grp_pkEnemy&&(e.icon_pkInfo.visible=!1,e.ico_enemy.visible=!1,e.grp_pkEnemy.visible=!1,e.grp_leftTime.visible=!1)},e)},o.resetPvpEnemyViewOnlyDraw=function(t){var i=this;for(i.grp_pkEnemy.visible=!0,i.grp_leftTime.visible=!1;i.grp_pkEnemy.numElements;)i.grp_pkEnemy.removeElementAt(0);for(var n=0;n<t.length;++n){t[n][gc.dsConsts.PkOutUserData.iconId];var o=new e.FightEnemyCell;o.setData(t[n]),i.grp_pkEnemy.addElement(o)}},o.setCDTime=function(e){var t=this;if(e>0){t.timeTrigger&&(tm.timer.remove(t.timeTrigger),t.timeTrigger=null);var i=Date.newDate(Date.newDate().getTime()+1e3*e),n=t.timeTrigger=new tm.Trigger(i);n.on(tm.Trigger.ON_SECOND,t.timeSec,t),n.on(tm.Trigger.ON_END,t.timeOut,t),tm.timer.add(n)}},o.timeSec=function(e,t,i){var n=this,o=Date.newDate().getTime(),r=Date.newDate(i).getTime();n.getEnemyListLeftMillisecond=r-o,n.getEnemyListLeftMillisecond<0&&(n.getEnemyListLeftMillisecond=0),n.label_leftTime.text=mo.getTimeStr(n.getEnemyListLeftMillisecond)},o.timeOut=function(e,t,i){var n=this;n.getEnemyListLeftMillisecond=-1,n.resetPvpEnemyView()},o.onStartPvpFight=function(t){var i=this;e.mapView.startPvpFight(t.my,t.enemy,t.isPkOut,t.name),i.resetPvpEnemyView(),i.quitOrRebuildTreasureView(!1),i.checkUIVisible()},o.onNextLoot=function(){var t=this;return t.quitOrRebuildTreasureView(!0),t.checkUIVisible(),e.baseTopBar&&e.baseTopBar.showCopyName(e.mapView.copyId,e.mapView.monsterId),gd.fightCtrl.isSpFighting?(t.grp_winCount.visible=!1,void(t.grp_boss.visible=!1)):void t.onWinCountChange()},o.onWinCountChange=function(){var e=this,t=gd.copyCtrl.getWinningStreak(),i=t[0],n=t[1];if(e.label_winCount.text=i+"/"+n,i>=n)e.grp_winCount.visible=!1,process.nextTick(function(){process.nextTick(function(){process.nextTick(function(){e.grp_boss.visible=!0})})}),mo.emitter.emit("onBoss"),gd.userCtrl.isAutoFight()&&!gd.bossFightCtrl.isAutoFight()&&e._tap_btn_boss();else{e.grp_winCount.visible=!0,e.grp_boss.visible=!1;var o=e.ico_win_process.width-Math.floor((1-i/n)*e.ico_win_process.width);e.ico_win_process.mask=new egret.Rectangle(0,0,o,e.grp_winCount.height)}},o.onTotalHurtChange=function(){var t=this;t.label_myDamage.text=utils.formatByWan(e.mapView.totalHurt)||"0"},o.onCheckSkipBtn=function(){var e=this;e.checkUIVisible()},o._tap_btn_boss=function(e){void 0===e&&(e=null);var t=this;Date.newDate().getTime()-t.sendTime>500&&!gd.fightCtrl.isSpFighting&&(t.sendTime=Date.newDate().getTime(),gd.fightCtrl.enterCopy(gd.copyCtrl.getNormalCurCopyId()))},o.onEnterCopy=function(t){var i=this;e.mapView.enterCopy(t.pveType,t.copyID,t.loots,t.bossId),i.grp_winCount&&(i.grp_winCount.visible=!1,i.onNextLoot())},o.forceNormalCopy=function(){e.mapView.forceNormalCopy()},o.onEnterWorldBoss=function(t){var i=this;e.bossData=t,e.mapView.pveType!=gc.c_prop.fightTypeKey.worldBoss&&(e.mapView.enterCopy(gc.c_prop.fightTypeKey.worldBoss,null,null,t.bossId),i.stage&&i.checkBossView())},o.checkBossView=function(){var t=this;if(e.mapView.pveType==gc.c_prop.fightTypeKey.worldBoss){var i=mo.getJSONWithFileNameAndID(gc.cfg_t_monster,gd.curBFECtrl.getBossId());t.label_bossName.text=i[gc.t_monster_name]+" Lv."+i[gc.t_monster_level],t.worldBossCurHpChange(),t.worldBossMyHurtChange();var n=gd.curBFECtrl.getReOverSeconds();n&&(t.label_worldBossLeftTime.text=mo.getTimeStr(1e3*n),t.setBLCDTime(n));var o=gd.curBFECtrl.getType()==gc.c_prop.worldBossTypeKey.guild;t.grp_guwu.visible=o,o&&t.worldBossGWTimeChange(gd.curBFECtrl.getInspireReSeconds(),gd.curBFECtrl),t.onNextLoot()}},o.worldBossCurHpChange=function(){var t=this;if(e.mapView.worldBossHpChange(),t.px_hp.maximum=gd.curBFECtrl.getTotalHp(),t.px_hp.setValue(gd.curBFECtrl.getCurHp()),gd.curBFECtrl.isLimitHp()){var i=mo.getJSONWithFileNameAndID(gc.cfg_t_monster,gd.curBFECtrl.getBossId());t.label_bossName.text=i[gc.t_monster_name]+" Lv."+i[gc.t_monster_level]+"(护盾已激活)"}},o.worldBossMyHurtChange=function(){var e=this;e.label_myDamage.text=utils.formatByWan(gd.curBFECtrl.getMyHurt())||"0"},o.onWorldBossOpenChanged=function(){var e=this;e.label_bossPking.visible=gd.bossFightCtrl.getOpenIds().length>0},o.worldBossGWTimeChange=function(e,t){var i=this,n=t.getInspireReSeconds();n>0?(i.grp_guwuLeftTime.visible=!0,i.label_guwuLeftTime.text=mo.getTimeStr(1e3*n),i.setGWCDTime(n)):i.grp_guwuLeftTime.visible=!1},o.onWorldBossOver=function(t){var i=this;t.getBossResult(function(n){var o=n[gc.dsConsts.BossResult.isWin],r=t.getType(),a={result:n,fec:t};o?r==gc.c_prop.worldBossTypeKey.guild?e.GuildBossWin.showCallback(a):e.WBossWin.showCallback(a):r==gc.c_prop.worldBossTypeKey.guild?e.GuildBossFail.showCallback(a):e.WBossFail.showCallback(a),e.mapView.pveType==gc.c_prop.fightTypeKey.worldBoss&&e.mapView.getEnemyRoleAt(0).roleInfo.monsterInfo[gc.t_monster_id]==t.getBossId()&&i.forceNormalCopy()},i)},o.onCallHero=function(){var t=gd.heroCtrl.getFightList(),i=t[t.length-1];e.mapView.createRole(i,!0,t.length-1)},o.onFightHeroChange=function(){e.mapView.roleListChange()},o._tap_grp_leftTime=function(){var e=this;gd.pkOutCtrl.refreshEnemy(!0,function(){e.resetPvpEnemyView()},e)},o._tap_grp_findPk=function(){var e=this;gd.pkOutCtrl.refreshEnemy(!1,function(){e.resetPvpEnemyView()},e)},o.checkUIVisible=function(){var t=this;t.grp_ui&&(t.grp_ui.visible=e.mapView.isNormalCopy),t.btn_skip&&(t.btn_skip.visible=!1,t.label_skipFight.visible=!1),t.grp_worldBoss&&(t.grp_worldBoss.visible=e.mapView.pveType==gc.c_prop.fightTypeKey.worldBoss),t.grp_myHurt&&(t.grp_myHurt.visible=e.mapView.pveType==gc.c_prop.fightTypeKey.worldBoss||e.mapView.pveType==gc.c_prop.fightTypeKey.coffersBoss),t.fightProfit&&t.fightProfit.setVisible(e.mapView.isNormalCopy),t.baseMidBar&&t.baseMidBar.setChatVisible(e.mapView.isNormalCopy)},o._tap_ico_enemy=function(){gd.pkOutCtrl.resetBePkKill(),gd.pkOutCtrl.getRevengeEnemyList(function(t){e.EnemyList.create().setData({list:t}).show()},this)},o.updateHP=function(t){var i=e.mapView.getHpInfos();e.baseBottomBar.updateHP(i)},o.isFindingMonsterChange=function(){this.eff_findingMonster.visible=e.mapView.isFindingMonster},o._tap_ico_auto=function(){var e,t=this,i=mo.getJSONWithFileName(gc.cfg_c_open),n=gd.userCtrl.getVip(),o=mo.getJSONWithFileNameAndID(gc.cfg_c_vip,n);return e=i[gc.id_c_open.autoFight][gc.c_open_lvlRequired],!o[gc.c_vip_copyBossAutoFight]&&gd.userCtrl.getLvl()<e?mo.showMsg(gc.id_c_msgCode.noLvlAuto,1,e):(mo.setLocalStorageItem("hasTapAuto",1),egret.Tween.removeTweens(t.ico_autoLight),t.ico_autoLight.visible=!1,gd.userCtrl.setAutoFight(!gd.userCtrl.isAutoFight()),t.ico_auto.source=gd.userCtrl.isAutoFight()?"ico_zidongtiaozhan1":"ico_zidongtiaozhan",void(t.label_noActive.visible=!gd.userCtrl.isAutoFight()))},o.setBLCDTime=function(e){var t=this;if(e>0){t.blTimeTrigger&&(tm.timer.remove(t.blTimeTrigger),t.blTimeTrigger=null);var i=Date.newDate(Date.newDate().getTime()+1e3*e),n=t.blTimeTrigger=new tm.Trigger(i);n.on(tm.Trigger.ON_SECOND,t.blTimeSec,t),n.on(tm.Trigger.ON_END,t.blTimeOut,t),tm.timer.add(n)}},o.blTimeSec=function(e,t,i){var n=this,o=Date.newDate().getTime(),r=Date.newDate(i).getTime(),a=r-o;n.label_worldBossLeftTime.text=mo.getTimeStr(a)},o.blTimeOut=function(e,t,i){},o.setGWCDTime=function(e){var t=this;if(e>0){t.gwTimeTrigger&&(tm.timer.remove(t.gwTimeTrigger),t.gwTimeTrigger=null);var i=Date.newDate(Date.newDate().getTime()+1e3*e),n=t.gwTimeTrigger=new tm.Trigger(i);n.on(tm.Trigger.ON_SECOND,t.gwTimeSec,t),n.on(tm.Trigger.ON_END,t.gwTimeOut,t),tm.timer.add(n)}},o.gwTimeSec=function(e,t,i){var n=this,o=Date.newDate().getTime(),r=Date.newDate(i).getTime(),a=r-o;n.label_guwuLeftTime.text=mo.getTimeStr(a)},o.gwTimeOut=function(e,t,i){var n=this;n.grp_guwuLeftTime.visible=!1},o._tap_btn_guwu=function(){var e=this;gd.curBFECtrl.inspire(function(e){},e)},o._tap_btn_damageRank=function(){mo.moduleMgr.runModule(g_consts.moduleId.worldBossHurtList,{bossId:gd.curBFECtrl.getBossId()})},o._tap_ico_worldBoss=function(){mo.moduleMgr.runModule(g_consts.moduleId.bossWar)},o.onRedEnvelopeChanged=function(){this.btn_red.visible=gd.redEnvelopeCtrl.getCanGetList().length>0},o._tap_btn_red=function(){mo.moduleMgr.runModule(g_consts.moduleId.redPacketList)},o.onKingBuffChanged=function(){this.ico_expBuff.visible=gd.kingCtrl.isOpenBuff()},o._tap_btn_zhenQi=function(){var e=mo.getJSONWithFileNameAndID(gc.cfg_c_demonLotus,0);gd.userCtrl.getLvl()>=e[gc.c_demonLotus_treaNeedUserLvl]?g_base.ZhenQiDetail.create().show():mo.showMsg(gc.id_c_msgCode.gasNoOpen,e[gc.c_demonLotus_treaNeedUserLvl])},o._tap_btn_skip=function(){var t=mo.getJSONWithFileName(gc.cfg_c_vip),i=t[gd.userCtrl.getVip()];if(i[gc.c_vip_skipFight])e.mapView.skipFight();else{for(var n in t)if(t[n][gc.c_vip_skipFight])break;mo.showMsg(gc.id_c_msgCode.vipLess,n)}},o.showProfileInfo=function(){var t=this,i=mo.getJSONWithFileName(gc.cfg_c_open),n=gd.userCtrl.getLvl(),o=i[gc.id_c_open.expBox][gc.c_open_lvlRequired];o>n?e.FightProfitDlg.create().show():gd.demonLotusCtrl.getInfo(function(t){e.FightProfitDlg.create().show()},t)},o.quitOrRebuildTreasureView=function(e){var t=this;t.isTreasureViewsShowing&&!e?(t.isTreasureViewsNeedRebuild=t.treasureView.tab_btn.selectedIndex,t.showOrHideTreasureView(!1)):!t.isTreasureViewsShowing&&e&&t.isTreasureViewsNeedRebuild>=0&&(t.showOrHideTreasureView(!0),t.isTreasureViewsNeedRebuild=-1)},o.showOrHideTreasureView=function(t){var i=this;i.isTreasureViewsShowing!=t&&(i.isTreasureViewsShowing=t,t?i.treasureView=e.FightTreasure.create().setData({lm:i.getEnemyListLeftMillisecond,fl:i,index:i.isTreasureViewsNeedRebuild}).show().onClose(function(){i.isTreasureViewsShowing=!1},i):i.treasureView&&i.treasureView.close())},i}(mo.gui.Layer);e.FightLayer=t,egret.registerClass(t,"g_fight.FightLayer")}(g_fight||(g_fight={}));var g_fight;!function(e){logger.initLogger(e,"g-fight"),logger.setLvl("g-fight",4),e.stack=[];var t=function(t){function i(){t.apply(this,arguments)}__extends(i,t);var n=(__define,i);n.prototype;return i.show=function(t){var n=this;mo.moduleMgr.curModule.name==g_consts.moduleId.fight?(mo.gui.Dlg.show.apply(n,arguments),i.clearCbData()):e.stack.push([n,t])},i.showCallback=function(e){var t=this;i.cbData=e;var n=i.cbData.begTime-Date.newDate().getTime();i.cbTimeoutKey=egret.setTimeout(function(){null!=i.cbData.callback&&i.cbData.callback.call(i.cbData.target),i.clearCbData()},null,n),t.show(e)},i.clearCbData=function(){egret.clearTimeout(i.cbTimeoutKey);for(var t=0;t<e.stack.length;++t)if(e.stack[t][1]==i.cbData){e.stack.splice(t,1);break}i.cbData=null},i}(mo.gui.Dlg);e.FightDlg=t,egret.registerClass(t,"g_fight.FightDlg");var i=function(i){function n(){i.apply(this,arguments)}__extends(n,i);var o=(__define,n),r=o.prototype;return r.show=function(){var n=this;i.prototype.show.call(this),g_base.modIdx=0,n.layer=e.FightLayer.create().show();var o=g_mid.FightMidBar.create();for(o.moduleParam=n.moduleParam,o.show(),g_mid.FightBottomBar.create().show();e.stack.length;){var r=e.stack.pop();if(t.cbData&&r[1]==t.cbData){var a=t.cbData.begTime-Date.newDate().getTime();a>0&&(r[0].show(r[1]),t.clearCbData())}else r[0].show(r[1])}e.baseBottomBar=g_base.BaseBottomBar.create().show(),e.baseTopBar=g_base.BaseTopBar.create("FightScene").show()},r.onExit=function(){i.prototype.onExit.call(this),e.baseTopBar=null},r.openSubModule=function(e){switch(e){case g_consts.FS_SUBMID_SMELT:mo.moduleMgr.runModule(g_consts.moduleId.smelting);break;case g_consts.FS_SUBMID_PVP_OUT:break;case g_consts.FS_SUBMID_CHAT:g_mid.Chat.create().show()}},n}(mo.gui.UIScene);e.FightScene=i,egret.registerClass(i,"g_fight.FightScene"),egret.Boot.once(egret.Boot.AFTER_CONFIG,function(){var e=new mo.ModuleCfgItem;e.targetClass=i,mo.moduleMgr.registerModule(e),e.onPreAsync(function(e,t){var i=mo.getJSONWithFileNameAndID(gc.cfg_t_copy,gd.copyCtrl.getNormalCurCopyId()),n=i[gc.t_copy_displayID];mo.R.loadTo("mapview","dynamic2/map_"+n+"_small.jpg",function(){t()})})})}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(t,i){void 0===i&&(i=null),e.call(this,t),this.data=i}__extends(t,e);var i=(__define,t);i.prototype;return t}(egret.Event);e.CusEvent=t,egret.registerClass(t,"g_fight.CusEvent")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(){function e(){}var t=__define,i=e,n=i.prototype;return t(n,"cd",function(){return null==this._cd?this.tabInfo[gc.t_skill_cd]||0:this._cd},function(e){this._cd=e}),t(n,"id",function(){return this.tabInfo[gc.t_skill_id]||0}),t(n,"name",function(){return this.tabInfo[gc.t_skill_name]}),t(n,"desc",function(){return this.tabInfo[gc.t_skill_desc]}),t(n,"effect",function(){return this.tabInfo[gc.t_skill_effect]||0}),t(n,"attackDistance",function(){return this.tabInfo[gc.t_skill_attackDistance]||0}),t(n,"priority",function(){return this.tabInfo[gc.t_skill_priority]||0}),t(n,"targetType",function(){return this.tabInfo[gc.t_skill_targetType]||0}),t(n,"effectRadius",function(){return this.tabInfo[gc.t_skill_effectRadius]||0}),t(n,"damage",function(){return this.tabInfo[gc.t_skill_damage]||0}),t(n,"pushType",function(){return this.tabInfo[gc.t_skill_pushType]||0}),t(n,"pushDistance",function(){return this.tabInfo[gc.t_skill_pushDistance]||0}),t(n,"casterPositionType",function(){return this.tabInfo[gc.t_skill_casterPositionType]||0}),t(n,"buffID",function(){return this.tabInfo[gc.t_skill_buffID]||0}),t(n,"callMonsterID",function(){return this.tabInfo[gc.t_skill_callMonsterID]||0}),t(n,"callMonsterNum",function(){return this.tabInfo[gc.t_skill_callMonsterNum]||0}),t(n,"damageScale",function(){return this.tabInfo[gc.t_skill_damageScaleA]||0}),t(n,"castAction",function(){return this.tabInfo[gc.t_skill_castAction]||0}),t(n,"actionTime",function(){return this.tabInfo[gc.t_skill_actionTime]||0}),t(n,"casterEffect",function(){return this.tabInfo[gc.t_skill_casterEffect]||0}),t(n,"targetEffect",function(){return this.tabInfo[gc.t_skill_targetEffect]||0}),t(n,"flyEffect",function(){return this.tabInfo[gc.t_skill_flyEffect]||0}),t(n,"beHittedEffect",function(){return this.tabInfo[gc.t_skill_beHittedEffect]||0}),t(n,"firstCD",function(){return this.tabInfo[gc.t_skill_firstCD]||0}),t(n,"special",function(){return this.tabInfo[gc.t_skill_special]||0}),t(n,"canExtends",function(){return this.tabInfo[gc.t_skill_canExtends]||0}),e}();e.SkillInfo=t,egret.registerClass(t,"g_fight.SkillInfo")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(){function e(){this.attackTime=0}var t=__define,i=e,n=i.prototype;return t(n,"skillInfo",function(){return this._skillInfo},function(e){this._skillInfo=e}),n.reduceTime=function(e){this.attackTime>0&&(this.attackTime-=e)},n.resetCD=function(){this.attackTime+=10*this.skillInfo.cd},n.canExe=function(){return this.attackTime<=0},t(n,"hpCoefficient",function(){return(this._skillInfo.damage+this._skillInfo.damageScale*(this.level-1))/g_base.PropBase.Scale_Num}),e}();e.Skill=t,egret.registerClass(t,"g_fight.Skill")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.call(this),this.isPvPFight=!1,this.isWorldBossFight=!1}__extends(t,e);var i=__define,n=t,o=n.prototype;return o.setMonsterInfo=function(t){this.monsterInfo=t,e.prototype.setMonsterInfo.call(this,t),this.name=t[gc.t_monster_name],this.displayID=t[gc.t_monster_displayID]},i(o,"seeDistance",function(){return null!=this.monsterInfo?this.monsterInfo[gc.t_monster_seeDistance]||0:0}),t}(g_base.PropBase);e.RoleInfo=t,egret.registerClass(t,"g_fight.RoleInfo")}(g_fight||(g_fight={}));var g_fight;!function(e){e.ROLE_EVENT_POS_CHANGE="ROLE_EVENT_POS_CHANGE",e.ROLE_EVENT_HP_CHANGE="ROLE_EVENT_HP_CHANGE",e.ROLE_EVENT_AVATAR_CHANGE="ROLE_EVENT_AVATAR_CHANGE",e.ROLE_EVENT_MEDAL_CHANGE="ROLE_EVENT_MEDAL_CHANGE",e.ROLE_EVENT_ATTACK="ROLE_EVENT_ATTACK",e.ROLE_EVENT_HURT="ROLE_EVENT_HURT",e.ROLE_EVENT_DIE="ROLE_EVENT_DIE",e.ROLE_EVENT_REVIVE="ROLE_EVENT_REVIVE",e.ROLE_EVENT_ADD_BUFF="ROLE_EVENT_ADD_BUFF",e.ROLE_EVENT_REMOVE_BUFF="ROLE_EVENT_REMOVE_BUFF",e.ROLE_EVENT_BENUMB_CHANGED="ROLE_EVENT_BENUMB_CHANGED",e.ROLE_EVENT_CALL_PET="ROLE_EVENT_CALL_PET",e.ROLE_EVENT_GIFT_EQUIP_CHANGE="ROLE_EVENT_GIFT_EQUIP_CHANGE",e.ROLE_ACTION_STAND=1,e.ROLE_ACTION_MOVE=2,e.ROLE_ACTION_ATTACK=3,e.ROLE_ASPECT_UP=1,e.ROLE_ASPECT_UP_RIGHT=2,e.ROLE_ASPECT_RIGHT=3,e.ROLE_ASPECT_DOWN_RIGHT=4,e.ROLE_ASPECT_DOWN=5,e.ROLE_ASPECT_UP_LEFT=6,e.ROLE_ASPECT_LEFT=7,e.ROLE_ASPECT_DOWN_LEFT=8;var t=function(t){function i(){t.call(this),this._weaponID=-1,this._wingID=-1,this._hp=100,this.hp2=0,this.curState=i.STATE_NONE,this.lastExeAITime=0,this.skillActionTime=0,this.isPushing=!1,this.curPetNum=0,this.giftSkills=[],this.skills=[],this.buffs=[],this.benumbTime=0,this.curReviveCount=0,this.invincibleTime=0,this.isCheckTime=!0,this.isMain=!1,this._medalId=0}__extends(i,t);var n=__define,o=i,r=o.prototype;return n(r,"isBenumb",function(){for(var e=this,t=0;t<e.buffs.length;++t){var i=e.buffs[t];if(1==i.specialEffect)return!0}return e.benumbTime>0}),r.getAvatar=function(e,t){void 0===t&&(t="");var i=this,n=[null,"0","1","2","3","4"],o=[null,"s","r","a"];return t+e+"_"+n[i.aspect<6?i.aspect:i.aspect-4]+o[i.action]},n(r,"hp",function(){return this._hp},function(t){var i=this;i._hp=t,i.dispatchEvent(new egret.Event(e.ROLE_EVENT_HP_CHANGE))}),n(r,"mp",function(){return this.hp2}),n(r,"name",function(){var e=this;return null==e._name?e.roleInfo.name:e._name},function(e){this._name=e}),n(r,"clothesID",function(){return this._clothesID},function(t){var i=this;i._clothesID!=t&&(i._clothesID=t,i.dispatchEvent(new egret.Event(e.ROLE_EVENT_AVATAR_CHANGE)))}),n(r,"weaponID",function(){return this._weaponID},function(t){var i=this;i._weaponID!=t&&(i._weaponID=t,i.dispatchEvent(new egret.Event(e.ROLE_EVENT_AVATAR_CHANGE)))}),n(r,"wingID",function(){return this._wingID},function(t){var i=this;i._wingID!=t&&(i._wingID=t,i.dispatchEvent(new egret.Event(e.ROLE_EVENT_AVATAR_CHANGE)))}),n(r,"action",function(){return this._action},function(t){var i=this;i._action!=t&&(i._action=t,i.dispatchEvent(new egret.Event(e.ROLE_EVENT_AVATAR_CHANGE)))}),n(r,"aspect",function(){return this._aspect},function(t){var i=this;i._aspect!=t&&(i._aspect=t,i.dispatchEvent(new egret.Event(e.ROLE_EVENT_AVATAR_CHANGE)))}),n(r,"row",function(){return Math.floor(this.y/i.cellH)}),n(r,"col",function(){return Math.floor(this.x/i.cellW)}),r.isOnNodeCenter=function(){var e=this;return Math.abs(e.x-(e.col+.5)*i.cellW)<2&&Math.abs(e.y-(e.row+.5)*i.cellH)<2},n(r,"mtRow",function(){var e=this;return isNaN(e._mtRow)?e.row:e._mtRow}),n(r,"mtCol",function(){var e=this;return isNaN(e._mtCol)?e.col:e._mtCol}),n(r,"isBoss",function(){var e=this;return e.roleInfo.monsterInfo&&0!=e.roleInfo.monsterInfo[gc.t_monster_bossLevel]?!0:!1}),n(r,"medalId",function(){return this._medalId},function(t){var i=this;i._medalId!=t&&(i._medalId=t,i.dispatchEvent(new egret.Event(e.ROLE_EVENT_MEDAL_CHANGE)))}),n(r,"isKing",function(){return this._isKing},function(t){var i=this;i._isKing!=t&&(i._isKing=t,i.dispatchEvent(new egret.Event(e.ROLE_EVENT_AVATAR_CHANGE)))}),r.revive=function(){var e=this;e.hp=e.roleInfo.maxHpFight,e.hp2=e.roleInfo.maxHp2Fight,e.curReviveCount=0,e.invincibleTime=0,e.lastExeAITime=0},r.isDie=function(){return this.hp<=0},r.die=function(){var t=this;if(t.roleInfo)if(!t.roleInfo.isPvPFight||t.curReviveCount>=t.roleInfo.reviveCountFight){for(t.hp=0;t.buffs.length;){var i=t.buffs.pop();t.removeBuff(i)}t.dispatchEvent(new egret.Event(e.ROLE_EVENT_DIE))}else t.curReviveCount++,t.hp=Math.round(t.roleInfo.maxHpFight*t.roleInfo.reviveHPScaleFight),t.invincibleTime=10*t.roleInfo.invincibleTimeFight,t.dispatchEvent(new egret.Event(e.ROLE_EVENT_REVIVE))},r.aspectTo=function(t,n){var o=this,r=new egret.Point((n+.5)*i.cellW,(t+.5)*i.cellH),a=r.x-o.x,s=r.y-o.y;if(0!=a||0!=s){var l=a/Math.sqrt(a*a+s*s),g=Math.acos(l);g>=0&&g<Math.PI/6?o.aspect=e.ROLE_ASPECT_RIGHT:g>=Math.PI/6&&g<Math.PI/3?s>0?o.aspect=e.ROLE_ASPECT_DOWN_RIGHT:o.aspect=e.ROLE_ASPECT_UP_RIGHT:g>=Math.PI/3&&g<2*Math.PI/3?s>0?o.aspect=e.ROLE_ASPECT_DOWN:o.aspect=e.ROLE_ASPECT_UP:g>=2*Math.PI/3&&g<5*Math.PI/6?s>0?o.aspect=e.ROLE_ASPECT_DOWN_LEFT:o.aspect=e.ROLE_ASPECT_UP_LEFT:o.aspect=e.ROLE_ASPECT_LEFT}},r.moveTo=function(t,n){var o=this;0>t?t=0:t>i.maxRow-1&&(t=i.maxRow-1),0>n?n=0:n>i.maxCol-1&&(n=i.maxCol-1);var o=o;o.action=e.ROLE_ACTION_MOVE;var r=(o.owner?o.owner.roleInfo.moveSpeedFight:o.roleInfo.moveSpeedFight)/1e3,a=new egret.Point((n+.5)*i.cellW,(t+.5)*i.cellH),s=a.x-o.x,l=a.y-o.y,g=Math.sqrt(s*s+l*l)/r;o.aspectTo(t,n),o._mtRow=t,o._mtCol=n;var c=function(){o._mtRow=0/0,o._mtCol=0/0,o._action=e.ROLE_ACTION_STAND,o.isDie()||o.exeAI(o.isCheckTime),o.curState==i.STATE_NONE&&o.stand(),o.isFindingMonster&&(0==o.row||0==o.col||o.row==i.maxRow-1||o.col==i.maxCol-1)&&(o.aspect==e.ROLE_ASPECT_UP?o.aspect=e.ROLE_ASPECT_DOWN:o.aspect==e.ROLE_ASPECT_DOWN?o.aspect=e.ROLE_ASPECT_UP:o.aspect==e.ROLE_ASPECT_LEFT?o.aspect=e.ROLE_ASPECT_RIGHT:o.aspect==e.ROLE_ASPECT_RIGHT?o.aspect=e.ROLE_ASPECT_LEFT:o.aspect==e.ROLE_ASPECT_UP_LEFT?o.aspect=0==o.col?e.ROLE_ASPECT_UP_RIGHT:e.ROLE_ASPECT_DOWN_LEFT:o.aspect==e.ROLE_ASPECT_DOWN_RIGHT?o.aspect=o.col==i.maxCol-1?e.ROLE_ASPECT_DOWN_LEFT:e.ROLE_ASPECT_UP_RIGHT:o.aspect==e.ROLE_ASPECT_UP_RIGHT?o.aspect=o.col==i.maxCol-1?e.ROLE_ASPECT_UP_LEFT:e.ROLE_ASPECT_DOWN_RIGHT:o.aspect==e.ROLE_ASPECT_DOWN_LEFT&&(o.aspect=0==o.col?e.ROLE_ASPECT_DOWN_RIGHT:e.ROLE_ASPECT_UP_LEFT))};egret.Tween.removeTweens(o),o.isCheckTime?egret.Tween.get(o,{onChange:o.onChange,onChangeObj:o}).to({x:a.x,y:a.y},g).call(c):(o.x=a.x,o.y=a.y,c(),o.dispatchEvent(new egret.Event(e.ROLE_EVENT_POS_CHANGE)))},r.pushTo=function(t,n){var o=this;o.isPushing=!0;var o=o,r=.15,a=new egret.Point((n+.5)*i.cellW,(t+.5)*i.cellH),s=a.x-o.x,l=a.y-o.y,g=Math.sqrt(s*s+l*l)/r;o._mtRow=t,o._mtCol=n;var c=function(){o._mtRow=0/0,o._mtCol=0/0,o.isPushing=!1,o._action=e.ROLE_ACTION_STAND,o.isDie()||o.exeAI(o.isCheckTime),o.curState==i.STATE_NONE&&o.stand()};egret.Tween.removeTweens(o),o.isCheckTime?egret.Tween.get(o,{onChange:o.onChange,onChangeObj:o}).to({x:a.x,y:a.y},g).call(c):(o.x=a.x,o.y=a.y,c(),o.dispatchEvent(new egret.Event(e.ROLE_EVENT_POS_CHANGE)))},r.stand=function(){var t=this;t.curEnemy&&t.aspectTo(t.curEnemy.row,t.curEnemy.col),t.moveToAimEnemy&&t.aspectTo(t.moveToAimEnemy.row,t.moveToAimEnemy.col),egret.Tween.removeTweens(t),t.action=e.ROLE_ACTION_STAND},r.getPointByAspect=function(t,i){var n=this,o=[n.col,n.row];switch(n.aspect){case e.ROLE_ASPECT_DOWN:case e.ROLE_ASPECT_DOWN_LEFT:case e.ROLE_ASPECT_DOWN_RIGHT:o[1]+=t?i:-i;break;case e.ROLE_ASPECT_UP:case e.ROLE_ASPECT_UP_LEFT:case e.ROLE_ASPECT_UP_RIGHT:o[1]-=t?i:-i}switch(n.aspect){case e.ROLE_ASPECT_RIGHT:case e.ROLE_ASPECT_UP_RIGHT:case e.ROLE_ASPECT_DOWN_RIGHT:o[0]+=t?i:-i;break;case e.ROLE_ASPECT_LEFT:case e.ROLE_ASPECT_UP_LEFT:case e.ROLE_ASPECT_DOWN_LEFT:o[0]-=t?i:-i}return o},r.spellSkill=function(t){var n=this;n.action=e.ROLE_ACTION_ATTACK,n.curEnemy&&n.aspectTo(n.curEnemy.row,n.curEnemy.col),t.resetCD(),n.skillActionTime=10*t.skillInfo.actionTime;var o=new e.HurtData;o.attackRole=n,o.hurtRole=n.curEnemy,o.skill=t,n.dispatchEvent(new e.CusEvent(e.ROLE_EVENT_ATTACK,o));for(var r=n.getSkillTargets(t),a=0;a<r.length;++a)n.useSkillOn(t,r[a],0==a);if(t.skillInfo.casterPositionType>0&&null!=n.curEnemy&&!n.curEnemy.isDie()){var s=n.getPointByAspect(!0,t.skillInfo.pushDistance),l=s[0],g=s[1];1>g?g=1:g>i.maxRow-2&&(g=i.maxRow-2),1>l?l=1:l>i.maxCol-2&&(l=i.maxCol-2),n.moveTo(g,l)}0!=t.skillInfo.callMonsterID&&n.dispatchEvent(new e.CusEvent(e.ROLE_EVENT_CALL_PET,{petID:n.curPetId,owner:n,num:t.skillInfo.callMonsterNum}))},r.checkPetId=function(){for(var t=this,i=0;i<t.skills.length;++i){var n=t.skills[i];if(0!=n.skillInfo.callMonsterID){var o=n.skillInfo.callMonsterID+n.level+t.getGiftEffectValue(5);t.curPetId!=o&&(t.curPetId=o,t.dispatchEvent(new e.CusEvent(e.ROLE_EVENT_CALL_PET,{petID:t.curPetId,owner:t,num:n.skillInfo.callMonsterNum,isKillAll:!0})))}}},r.useSkillOn=function(e,t,n){var o=this;if(t.hurt(o,e,n),!t.isDie()){if(e.skillInfo.casterPositionType>0&&t.aspectTo(o.row,o.col),1==e.skillInfo.pushType&&e.skillInfo.pushDistance>0){if(t.roleInfo.monsterInfo&&t.roleInfo.monsterInfo[gc.t_monster_immunity]&&-1!=t.roleInfo.monsterInfo[gc.t_monster_immunity].indexOf(1))return;var r=t.getPointByAspect(!1,e.skillInfo.pushDistance),a=r[0],s=r[1];0>s?s=0:s>i.maxRow-1&&(s=i.maxRow-1),0>a?a=0:a>i.maxCol-1&&(a=i.maxCol-1),t.pushTo(s,a)}if(0!=e.skillInfo.buffID){if(3==e.skillInfo.buffID&&t.roleInfo.monsterInfo&&t.roleInfo.monsterInfo[gc.t_monster_immunity]&&-1!=t.roleInfo.monsterInfo[gc.t_monster_immunity].indexOf(2))return;t.addBuff(e.skillInfo.buffID,e.level)}}},r.hasBuff=function(e){for(var t=this,i=0;i<t.buffs.length;++i)if(t.buffs[i].id==e)return!0;return!1},r.addBuff=function(t,i){for(var n,o=this,r=0;r<o.buffs.length;++r)if(o.buffs[r].id==t){var a=o.buffs.splice(r,1)[0];0!=a.propertyID&&(n=o.roleInfo.getBuffPropByIndex(a.propertyID)-a.getAddPropValue(),o.roleInfo.setBuffPropByIndex(a.propertyID,n));break}var s=e.Buff.create(t,i);o.buffs.push(s),0!=s.propertyID&&(n=o.roleInfo.getBuffPropByIndex(s.propertyID)+s.getAddPropValue(),o.roleInfo.setBuffPropByIndex(s.propertyID,n)),o.dispatchEvent(new e.CusEvent(e.ROLE_EVENT_ADD_BUFF,s))},r.checkRemoveBuff=function(e){for(var t,i=this,n=0;n<i.buffs.length;++n){t=i.buffs[n];var o=t.totalTime-t.leftTime;t.reduceTime(e);var r=t.totalTime-t.leftTime;if(1e3*(t.exeCount+1)>o&&1e3*(t.exeCount+1)<=r){t.exe();var a=t.getHpValue();0!=a&&(i.roleInfo.isWorldBossFight||(i.hp+=a,i.hp<=0&&i.die()))}t.leftTime<=0&&(i.buffs.splice(n--,1)[0],i.removeBuff(t))}},r.removeBuff=function(t){var i=this;if(0!=t.propertyID){var n=i.roleInfo.getBuffPropByIndex(t.propertyID)-t.getAddPropValue();i.roleInfo.setBuffPropByIndex(t.propertyID,n)}i.dispatchEvent(new e.CusEvent(e.ROLE_EVENT_REMOVE_BUFF,t))},r.onChange=function(){this.dispatchEvent(new egret.Event(e.ROLE_EVENT_POS_CHANGE))},r.hurt=function(t,i,n){var o=this;if(o.roleInfo&&t.roleInfo){var r=new e.HurtData;if(r.attackRole=t,r.hurtRole=o,r.skill=i,r.isFirstAim=n,r.isHp2=!1,r.miss=!1,r.mb=!1,r.disMb=!1,r.invincible=!1,r.hp=0,1==i.skillInfo.special)o.hp=0,r.hp=-9999999999,o.dispatchEvent(new e.CusEvent(e.ROLE_EVENT_HURT,r)),o.hp<=0?o.die():o.hp>o.roleInfo.maxHpFight&&(o.hp=o.roleInfo.maxHpFight);else if(0!=i.hpCoefficient){var a=t.roleInfo.attackFight;if(i.hpCoefficient<0){if(o.invincibleTime>0)return r.invincible=!0,void o.dispatchEvent(new e.CusEvent(e.ROLE_EVENT_HURT,r));var s=t.roleInfo.isHitSucc(o.roleInfo.dodgeFight);if(r.miss=!s,s||i.skillInfo.pushDistance>0){var l,g=1,c=0;c=t.roleInfo.attackFight,t.entity?(l=t.entity.job,g=t.entity.lvl):(l=t.roleInfo.monsterInfo[gc.t_monster_attackType],g=t.roleInfo.monsterInfo[gc.t_monster_level]);
var _=o.roleInfo.getDefence(l,g,c);a*=1-_,0>=a&&(a=1);var h=t.roleInfo.isCritical(o.roleInfo.disCriticalFight);if(h){r.crit=!0;var f=t.roleInfo.getCritDamage(o.roleInfo.disCriticalFight);a*=1+f}a*=1+t.roleInfo.damageIncreaseFight-o.roleInfo.damageDecreaseFight,t.roleInfo.isBenumbProSucc(o.roleInfo.disBenumbProFight)?(o.benumbTime=10*t.roleInfo.benumbProSpanFight,r.mb=!0,o.dispatchEvent(new e.CusEvent(e.ROLE_EVENT_BENUMB_CHANGED))):t.roleInfo.benumbProFight>0&&o.roleInfo.disBenumbProFight>0}}else a=t.roleInfo.attackFight,a*=1+t.getGiftEffectValue(2)/1e4;if(!r.miss)if(o.roleInfo.isPvPFight&&i.hpCoefficient<0&&(a/=8),a*=i.hpCoefficient,a=Math.floor(a),!o.roleInfo.isPvPFight||o.hp2<=0||i.hpCoefficient>0)o.roleInfo.isWorldBossFight||(o.hp+=a),r.hp=a;else{var u=o.roleInfo.penetrateFight||0,m=a*u,d=a*(1-u);m=Math.floor(m),d=Math.floor(d),o.roleInfo.isWorldBossFight||(o.hp+=m),o.hp2+=d,r.isHp2=!0,o.hp2<0&&(o.hp2=0),r.hp=m}o.dispatchEvent(new e.CusEvent(e.ROLE_EVENT_HURT,r)),o.hp<=0?o.die():o.hp>o.roleInfo.maxHpFight&&(o.hp=o.roleInfo.maxHpFight)}else o.dispatchEvent(new e.CusEvent(e.ROLE_EVENT_HURT,r))}},r.distanceTo=function(e){var t=this,i=e.row-t.row,n=e.col-t.col;return Math.sqrt(i*i+n*n)},r.getSkillTargets=function(e){var t=this,i=[],n=e.skillInfo.targetType,o=(e.skillInfo.effect,e.skillInfo.effectRadius);if(0==e.skillInfo.attackDistance)return[];if(0==n)i.push(t.curEnemy);else if(1==n)i.push(t);else if(2==n){for(var r,a=0,s=0;s<t.selfs.length;++s)t.selfs[s].isDie()||t.selfs[s].roleInfo.maxHpFight-t.selfs[s].hp>a&&(a=t.selfs[s].roleInfo.maxHpFight-t.selfs[s].hp,r=t.selfs[s]);null!=r&&i.push(r)}else if(3==n)for(var s=0;s<t.enemys.length;++s)t.enemys[s].row>=t.curEnemy.row-o&&t.enemys[s].row<=t.curEnemy.row+o&&t.enemys[s].col>=t.curEnemy.col-o&&t.enemys[s].col<=t.curEnemy.col+o&&i.push(t.enemys[s]);else if(4==n)for(var s=0;s<t.enemys.length;++s)t.enemys[s].row>=t.row-o&&t.enemys[s].row<=t.row+o&&t.enemys[s].col>=t.col-o&&t.enemys[s].col<=t.col+o&&i.push(t.enemys[s]);else if(5==n)for(var s=0;s<t.selfs.length;++s)t.selfs[s].row>=t.row-o&&t.selfs[s].row<=t.row+o&&t.selfs[s].col>=t.col-o&&t.selfs[s].col<=t.col+o&&i.push(t.selfs[s]);return i},r.exeAI=function(t){void 0===t&&(t=!0);var n=this,o=new Date;if(n.isCheckTime=t,t)if(0==n.lastExeAITime)n.lastExeAITime=o.getTime();else{if(o.getTime()-n.lastExeAITime<e.MINI_SPACE_TIME)return;n.lastExeAITime=n.lastExeAITime+e.MINI_SPACE_TIME}for(var r=0;r<n.skills.length;++r)n.skills[r].reduceTime(e.MINI_SPACE_TIME);if(n.checkRemoveBuff(e.MINI_SPACE_TIME),n.benumbTime>0&&(n.benumbTime-=e.MINI_SPACE_TIME,n.benumbTime<=0&&n.dispatchEvent(new e.CusEvent(e.ROLE_EVENT_BENUMB_CHANGED))),n.invincibleTime>0&&(n.invincibleTime-=e.MINI_SPACE_TIME),n.skillActionTime>0&&(n.skillActionTime-=e.MINI_SPACE_TIME),!n.isBenumb){var a=n.getCurCanExeSkill();if(null!=a&&1==a.skillInfo.effect)return void(n.skillActionTime<=0&&n.spellSkill(a));if(n.action==e.ROLE_ACTION_MOVE)return void(n.curState==i.STATE_FOLLOW_MAIN&&n.mainRole&&n.mainRole!=n&&n.mainRole.curState!=i.STATE_ATTAK_AIM&&!n.mainRole.isBenumb&&Math.abs(n.row-n.mainRole.row)<=1&&Math.abs(n.col-n.mainRole.col)<=1&&(n.curState=i.STATE_NONE,n.stand()));if(n.isFindingMonster){var s=n.getPointByAspect(!0,1);return void n.moveTo(s[1],s[0])}if(!n.mainRole||n.mainRole==n||n.mainRole.curState==i.STATE_ATTAK_AIM||n.mainRole.isBenumb){if(null==n.enemys||0==n.enemys.length)return n.curState=i.STATE_NONE,void n.stand();for(var l,g,c=999999999,_=0,r=0;r<n.enemys.length;++r)g=n.enemys[r],_=n.distanceTo(g),c>_&&(c=_,l=g);if(n.curState==i.STATE_NONE||n.curState==i.STATE_FOLLOW_MAIN){if(null==n.mainRole&&0!=n.roleInfo.seeDistance&&c>n.roleInfo.seeDistance)return;var a=n.getCurCanExeSkill();null!=a&&0==a.skillInfo.effect&&(a.skillInfo.attackDistance>c-1?(n.curState=i.STATE_ATTAK_AIM,n.moveToAimEnemy=l,n.exeAttak()):(n.curState=i.STATE_MOVE_TO_AIM,n.moveToAimEnemy=l,n.moveToAim()))}else n.curState==i.STATE_MOVE_TO_AIM?(n.moveToAimEnemy=l,n.moveToAim()):n.curState==i.STATE_ATTAK_AIM&&n.exeAttak()}else if(n.curState=i.STATE_FOLLOW_MAIN,Math.abs(n.row-n.mainRole.row)<=1&&Math.abs(n.col-n.mainRole.col)<=1)n.curState=i.STATE_NONE,n.stand();else{var h;h=n.getNextNodeTo(n.mainRole.mtRow,n.mainRole.mtCol);var f=n.getRoleByRC(h[0],h[1]);if(null==f||f==n||f.curState!=i.STATE_FOLLOW_MAIN)n.moveTo(h[0],h[1]);else{var u=n.getEmptyPosRound(n.mainRole.mtRow,n.mainRole.mtCol,1);n.moveTo(u[0],u[1])}}}},r.getCurCanExeSkill=function(){for(var e,t=this,i=0;i<t.skills.length;++i)if(e=t.skills[i],(!e.skillInfo.canExtends||t.isMain)&&e.canExe())return t.skills[i];return null},r.exeAttak=function(){var t=this,n=t.getRoleByRC(t.row,t.col);if(!t.curEnemy&&null!=n&&n!=t||t.curEnemy&&t.curEnemy.row==t.row&&t.curEnemy.col==t.col){t.curEnemy&&(t.moveToAimEnemy=t.curEnemy),t.curState=i.STATE_MOVE_TO_AIM;var o=t.getCurCanExeSkill();if(o){var r=t.getEmptyPosRound(t.moveToAimEnemy.mtRow,t.moveToAimEnemy.mtCol,o.skillInfo.attackDistance);t.moveTo(r[0],r[1])}}else{t.moveToAimEnemy&&(t.curEnemy&&t.curEnemy.removeEventListener(e.ROLE_EVENT_DIE,t.onCurEnemyDie,t),t.curEnemy=t.moveToAimEnemy,t.curEnemy.addEventListener(e.ROLE_EVENT_DIE,t.onCurEnemyDie,t),t.moveToAimEnemy=null);var a=t.distanceTo(t.curEnemy),o=t.getCurCanExeSkill();null!=o&&(0!=a&&o.skillInfo.attackDistance>a-1?t.skillActionTime<=0&&t.spellSkill(o):(t.curState=i.STATE_MOVE_TO_AIM,t.moveToAim()))}},r.moveToAim=function(){var e=this;if(null==e.moveToAimEnemy)return e.curState=i.STATE_NONE,void e.stand();var t=e.distanceTo(e.moveToAimEnemy),n=e.getCurCanExeSkill();if(null!=n)if(0!=t&&n.skillInfo.attackDistance>t-1)e.curState=i.STATE_ATTAK_AIM,e.exeAttak();else{var o;o=e.getNextNodeTo(e.moveToAimEnemy.mtRow,e.moveToAimEnemy.mtCol);var r=e.getRoleByRC(o[0],o[1]);if(null!=r&&r!=e&&r.curState==i.STATE_ATTAK_AIM||e.row==o[0]&&e.col==o[1]){var a=e.getEmptyPosRound(e.moveToAimEnemy.mtRow,e.moveToAimEnemy.mtCol,n.skillInfo.attackDistance);e.moveTo(a[0],a[1])}else e.moveTo(o[0],o[1])}},r.getNextNodeTo=function(e,t){var i=this;return Math.abs(i.row-e)<=1&&Math.abs(i.col-t)<=1?[i.row,i.col]:i.row==e&&i.col==t?[i.row,i.col]:i.row==e?[e,i.col+(i.col>t?-1:1)]:i.col==t?[i.row+(i.row>e?-1:1),t]:[i.row+(i.row>e?-1:1),i.col+(i.col>t?-1:1)]},r.onCurEnemyDie=function(t){var n=this;n.curEnemy.removeEventListener(e.ROLE_EVENT_DIE,n.onCurEnemyDie,n),n.curState=i.STATE_NONE,n.curEnemy=null},r.getRoleByRC=function(e,t){for(var i=this,n=0;n<i.allRoles.length;++n)if(i.allRoles[n].mtRow==e&&i.allRoles[n].mtCol==t)return i.allRoles[n];return null},r.getEmptyPosRound=function(e,t,i){for(var n,o=this,r=9999999,a=[e,t],s=e-i;e+i>=s;++s)for(var l=t-i;t+i>=l;++l)if((s!=e||l!=t)&&(n=o.getRoleByRC(s,l),null==n)){var g=s-o.row,c=l-o.col,_=Math.sqrt(g*g+c*c);r>_?(r=_,a=[s,l]):_==r&&Math.random()<.5&&(r=_,a=[s,l])}return a},r.setEntity=function(t){var i=this;i.entity=t,i.entity.registerByKey(gd.HeroEntityCtrl.ON_EQUIP_CHANGED,i.onEquipOrWingChange,i),i.entity.registerByKey(gd.HeroEntityCtrl.ON_WING_CHANGED,i.onEquipOrWingChange,i),i.entity.registerByKey(gd.HeroEntityCtrl.ON_SKILL_CHANGED,i.onSkillChanged,i),i.entity.registerByKey(gd.HeroEntityCtrl.ON_GIFT_SKILL_CHANGED,i.onGiftSkillChanged,i),i.entity.registerByKey(gd.HeroTalismanCtrl.ON_GIFT_EQUIP_CHANGED,i.onGiftEquipChanged,i),i.uid=t.get(gc.dsConsts.HeroEntity.id);var n=new e.RoleInfo;n.setHeroProp(t.props),i.roleInfo=n,i.job=t.job,i.onSkillChanged(),i.onGiftSkillChanged(),i.onGiftEquipChanged()},r.getGiftEffectValue=function(e){for(var t=this,i=0,n=0;n<t.giftSkills.length;++n){var o=t.giftSkills[n];o[gc.t_talismanSkill_type]==e&&(2==e?i+=parseInt(o[gc.t_talismanSkill_effect]):5==e&&o[gc.t_talismanSkill_effect]>i&&(i=parseInt(o[gc.t_talismanSkill_effect])))}return i},r.onEquipOrWingChange=function(){var e=this;e.clothesID=e.entity.getClothDisplayID(),e.weaponID=e.entity.getWeaponDisplayID(),e.wingID=e.entity.getWingDisplayID()},r.onSkillChanged=function(){var t=this,i=t.entity;t.skills.length=0;for(var n=0;n<i.skillLevels.length;++n)if(0!=i.skillLevels[n]){var o=new e.Skill,r=new e.SkillInfo;r.tabInfo=mo.getJSONWithFileNameAndID(gc.cfg_t_skill,i.skillIds[n]),o.level=i.skillLevels[n],o.skillInfo=r,o.skillInfo.firstCD&&o.resetCD(),t.skills.push(o)}t.skills.sort(function(e,t){return t.skillInfo.priority-e.skillInfo.priority}),t.checkPetId()},r.onGiftSkillChanged=function(){var e=this,t=e.entity;e.giftSkills.length=0;for(var i=t.getTalismanSkill(),n=0;n<i.length;++n){var o=mo.getJSONWithFileNameAndID(gc.cfg_t_talismanSkill,i[n]);if(o){var r=o[gc.t_talismanSkill_type];(2==r||5==r)&&e.giftSkills.push(o)}}e.checkPetId()},r.onGiftEquipChanged=function(){var t=this,i=t.entity.getTalismanAdorn();0!=i?(t.gift=new e.Gift,t.gift.x=t.x,t.gift.y=t.y-30,t.gift.giftId=i,t.gift.role=t,t.dispatchEvent(new egret.Event(e.ROLE_EVENT_GIFT_EQUIP_CHANGE))):(t.gift=null,t.dispatchEvent(new egret.Event(e.ROLE_EVENT_GIFT_EQUIP_CHANGE)))},r.setMoster=function(t){var i=this,n=mo.getJSONWithFileNameAndID(gc.cfg_t_monster,t),o=new e.RoleInfo;o.setMonsterInfo(n),i.roleInfo=o,i.clothesID=n[gc.t_monster_displayID];var r=n[gc.t_monster_skillIds];i.skills.length=0;for(var a=0;a<r.length;++a){var s=new e.Skill,l=new e.SkillInfo;l.tabInfo=mo.getJSONWithFileNameAndID(gc.cfg_t_skill,r[a]),s.level=1,s.skillInfo=l,s.skillInfo.firstCD?s.resetCD():l.cd=n[gc.t_monster_attackTime],i.skills.push(s)}},r.dtor=function(){var t=this;t.entity&&(t.entity.unregisterByKey(gd.HeroEntityCtrl.ON_EQUIP_CHANGED,t.onEquipOrWingChange,t),t.entity.unregisterByKey(gd.HeroEntityCtrl.ON_WING_CHANGED,t.onEquipOrWingChange,t),t.entity.unregisterByKey(gd.HeroEntityCtrl.ON_SKILL_CHANGED,t.onSkillChanged,t),t.entity.unregisterByKey(gd.HeroEntityCtrl.ON_GIFT_SKILL_CHANGED,t.onGiftSkillChanged,t),t.entity.unregisterByKey(gd.HeroTalismanCtrl.ON_GIFT_EQUIP_CHANGED,t.onGiftEquipChanged,t)),t.curEnemy&&t.curEnemy.removeEventListener(e.ROLE_EVENT_DIE,t.onCurEnemyDie,t),t.selfs=null,t.enemys=null,t.allRoles=null,t.mainRole=null,t.moveToAimEnemy=null,t.roleInfo=null,t.skills.length=0,t.buffs.length=0},i.STATE_NONE=1,i.STATE_MOVE_TO_AIM=2,i.STATE_ATTAK_AIM=3,i.STATE_FOLLOW_MAIN=4,i.cellW=80,i.cellH=80,i.maxRow=0,i.maxCol=0,i}(egret.EventDispatcher);e.Role=t,egret.registerClass(t,"g_fight.Role")}(g_fight||(g_fight={}));var g_fight;!function(e){e.GIFT_EVENT_POS_CHANGE="GIFT_EVENT_POS_CHANGE";var t=function(t){function i(){t.call(this),this.aimDis=30,this.awayDis=60,this.action=i.ACTION_STAND}__extends(i,t);var n=(__define,i),o=n.prototype;return o.exeAI=function(){var t=this,n=t.role.x-t.x,o=t.role.y-t.y,r=Math.sqrt(n*n+o*o);if(this.action==i.ACTION_STAND)r>=t.awayDis&&(t.action=i.ACTION_MOVE);else if(this.action==i.ACTION_MOVE)if(r<=t.aimDis)t.action=i.ACTION_STAND;else{var a=n/r,s=o/r,l=r/10;this.x+=l*a,this.y+=l*s,this.dispatchEvent(new egret.Event(e.GIFT_EVENT_POS_CHANGE))}},o.dtor=function(){},i.ACTION_STAND=0,i.ACTION_MOVE=1,i}(egret.EventDispatcher);e.Gift=t,egret.registerClass(t,"g_fight.Gift")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(t){function i(){t.apply(this,arguments)}__extends(i,t);var n=__define,o=i,r=o.prototype;return n(r,"owner",function(){return this._owner},function(t){this._owner=t,this._owner.addEventListener(e.ROLE_EVENT_DIE,this.onOwnerDie,this)}),n(r,"hp",function(){return this._hp},function(t){this._hp=t,this.isDie()&&this._owner.curPetNum>0&&this._owner.curPetNum--,this.dispatchEvent(new egret.Event(e.ROLE_EVENT_HP_CHANGE)),this.isDie()&&this.dispatchEvent(new egret.Event(e.ROLE_EVENT_DIE))}),r.onOwnerDie=function(e){this.hp=0},i}(e.Role);e.Pet=t,egret.registerClass(t,"g_fight.Pet")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(){function e(){}var t=__define,i=e,n=i.prototype;return e.create=function(t,i){var n=new e,o=mo.getJSONWithFileNameAndID(gc.cfg_t_buff,t);return n.buffInfo=o,n.level=i,n.leftTime=n.totalTime,n.exeCount=0,n},n.reduceTime=function(e){this.leftTime>0&&(this.leftTime-=e)},n.getAddPropValue=function(){var e=this.baseValue1+this.linerScale*this.level;return e},n.getHpValue=function(){var e=this.effectValue+this.effectValeAdd*this.level;return e},n.exe=function(){this.exeCount++},t(n,"totalTime",function(){return 10*this.liftTime+this.level*this.lifeTimeAdd*10}),t(n,"id",function(){return this.buffInfo[gc.t_buff_id]||0}),t(n,"name",function(){return this.buffInfo[gc.t_buff_name]}),t(n,"liftTime",function(){return this.buffInfo[gc.t_buff_liftTime]||0}),t(n,"lifeTimeAdd",function(){return this.buffInfo[gc.t_buff_lifeTimeAdd]||0}),t(n,"effectValue",function(){return this.buffInfo[gc.t_buff_effectValue]||0}),t(n,"effectValeAdd",function(){return this.buffInfo[gc.t_buff_effectValeAdd]||0}),t(n,"propertyID",function(){return this.buffInfo[gc.t_buff_propertyID]||0}),t(n,"baseValue1",function(){return this.buffInfo[gc.t_buff_baseValue1]||0}),t(n,"linerScale",function(){return this.buffInfo[gc.t_buff_linerScale]||0}),t(n,"effectRes",function(){return this.buffInfo[gc.t_buff_effectRes]||0}),t(n,"specialEffect",function(){return this.buffInfo[gc.t_buff_specialEffect]||0}),e}();e.Buff=t,egret.registerClass(t,"g_fight.Buff")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(){function e(){}var t=(__define,e);t.prototype;return e}();e.HurtData=t,egret.registerClass(t,"g_fight.HurtData")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(t){function i(){t.apply(this,arguments)}__extends(i,t);var n=(__define,i),o=n.prototype;return o._initProp=function(){var e=this;t.prototype._initProp.call(this),e._comps=[]},o._childrenCreated=function(){t.prototype._childrenCreated.call(this);var i=this,n=i.data.index;i.tab_btn.selectedIndex=0>n?0:n,i._comps.push(e.PVPSelfInfo.create().setData({tray:i.container,extra:i.data}).show()),i._comps.push(e.FightTreasureOutside.create().setData({tray:i.container,extra:i.data}).show()),i._comps.push(e.FightTreasureList.create().setData({tray:i.container,extra:i.data}).show()),i._comps.push(e.FightTreasureChat.create().setData({tray:i.container,extra:i.data}).show()),process.nextTick(function(){i._tap_tab_btn()})},o.onExit=function(){t.prototype.onExit.call(this)},o._tap_tab_btn=function(){for(var e=this,t=e.tab_btn.selectedIndex,i=(e._comps[t],0),n=e._comps.length;n>i;i++)e._comps[i].visible=t==i},o._tap_btn_back=function(){var e=this;e.close()},o._tap_btn_help=function(){var e=this,t=e.tab_btn.selectedIndex;0==t?g_base.BaseShowTip.create().setData({id:208}).show():1==t?g_base.BaseShowTip.create().setData({id:209}).show():2==t?g_base.BaseShowTip.create().setData({id:210}).show():3==t&&g_base.BaseShowTip.create().setData({id:211}).show()},i}(mo.gui.Dlg);e.FightTreasure=t,egret.registerClass(t,"g_fight.FightTreasure")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(t){function i(){t.apply(this,arguments)}__extends(i,t);var n=(__define,i),o=n.prototype;return o._initProp=function(){var i=this;t.prototype._initProp.call(this),i._Item_list_items=e.FightTreasureChatItem},o.dataChanged=function(){t.prototype.dataChanged.call(this)},o.onEnter=function(){t.prototype.onEnter.call(this);var e=this,i=(mo.getJSONWithFileName(gc.cfg_t_treasure),mo.getJSONWithFileName(gc.cfg_t_item));gd.pkOutCtrl.getTreasurePkRecordList(function(t){if(t&&t.length>0){e.actItems=[],e.ico_nothing.visible=!1;for(var n=0;n<t.length;n++){var o=t[n],r=o[gc.dsConsts.TreasureRecordEntity.treasureId],a=[],s=o[gc.dsConsts.TreasureRecordEntity.items];for(var l in s){var g=s[l],c=i[l];a.push({id:l,count:g,item:c})}e.actItems.push({o:o,name:i[r][gc.t_item_name],color:i[r][gc.t_item_color],got:a})}e._reset()}else e.ico_nothing.visible=!0},e)},o._reset=function(){var e=this;e.refreshList("list_items")},o._childrenCreated=function(){t.prototype._childrenCreated.call(this)},o._data_list_items=function(){var e=this;return e.actItems},i}(mo.gui.Layer);e.FightTreasureChat=t,egret.registerClass(t,"g_fight.FightTreasureChat")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t);i.prototype;return t}(mo.gui.Layer);e.FightTreasureInfo=t,egret.registerClass(t,"g_fight.FightTreasureInfo")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(t){function i(){t.apply(this,arguments),this.hideLeftMillisecond=-1}__extends(i,t);var n=(__define,i),o=n.prototype;return o._initProp=function(){var i=this;t.prototype._initProp.call(this),i._Item_list_items=e.FightTreasureItem},o.dataChanged=function(){t.prototype.dataChanged.call(this)},o._childrenCreated=function(){t.prototype._childrenCreated.call(this);var e=this;e._resetInfo(),e._reset()},o._reset=function(){var e=this;gd.pkOutCtrl.getExPkOutInfo(function(t){var i=t[gc.dsConsts.ExPkOutInfo.openTime],n=t[gc.dsConsts.ExPkOutInfo.treasureInfo];i&&""!=i&&e._resetTime(i),n&&n.length>0?(e.ico_no_item.visible=!1,e.ico_item_hint.visible=!0):(e.ico_no_item.visible=!0,e.ico_item_hint.visible=!1),e._resetList(n)},e)},o._resetList=function(e){var t=this;t.actItems=[];for(var i=mo.getJSONWithFileName(gc.cfg_t_treasure),n=mo.getJSONWithFileName(gc.cfg_t_item),o=0;o<e.length;o++){var r=e[o],a=r[gc.dsConsts.TreasureInfo.itemId],s=[],l=r[gc.dsConsts.TreasureInfo.items];for(var g in l){var c=l[g],_=n[g];s.push({id:g,count:c,item:_})}t.actItems.push({o:r,t:i[a],got:s})}t.refreshList("list_items")},o._resetInfo=function(){var e=this,t=gd.userCtrl.get(gc.dsConsts.UserEntity.counts)[gc.c_prop.userRefreshCountKey.incognito];t=void 0==t?0:t,e.label_hidden_count.text="今日隐姓埋名次数:"+t,e.label_cost.text=gc.calIncognito(t)},o._data_list_items=function(){var e=this;return e.actItems},o._click_list_items=function(t){for(var i=this,n=t.item,o=0,r=0,a=0;a<i.actItems.length;a++){var s=i.actItems[a];s.t[gc.t_treasure_id]==n.t[gc.t_treasure_id]&&(o++,2==s.o[gc.dsConsts.TreasureInfo.status]&&r++)}e.FightTreasureCompose.create().setData({obj:n,lock:o-r,unlock:r,isfinished:2==n.o[gc.dsConsts.TreasureInfo.status]?1:0,parent:i}).show()},o._tap_btn_hidden=function(){var e=this;gd.pkOutCtrl.incognito(function(t){e._resetTime(t[2]),e._resetInfo()},e)},o._resetTime=function(e){var t=this,i=new Date(e),n=i.getSecondsBetween(Date.newDate()),o=mo.getJSONWithFileName(gc.cfg_c_game)[gc.id_c_game.treasure];n>=0&&n<o[1]&&t.setCDTime(o[1]-n)},o._timeInterval=function(){var e=this;e.label_time.text=mo.getTimeStr(e.hideLeftMillisecond)},o._timeFinish=function(){},o.setCDTime=function(e){var t=this;if(e>0){t.timeTrigger&&(tm.timer.remove(t.timeTrigger),t.timeTrigger=null);var i=Date.newDate(Date.newDate().getTime()+1e3*e),n=t.timeTrigger=new tm.Trigger(i);n.on(tm.Trigger.ON_SECOND,t.timeSec,t),n.on(tm.Trigger.ON_END,t.timeOut,t),tm.timer.add(n)}},o.cleanCDTime=function(){var e=this;e.timeTrigger&&(tm.timer.remove(e.timeTrigger),e.timeTrigger=null)},o.timeSec=function(e,t,i){var n=this,o=Date.newDate().getTime(),r=Date.newDate(i).getTime();n.hideLeftMillisecond=r-o,n.hideLeftMillisecond<0&&(n.hideLeftMillisecond=0),n._timeInterval()},o.timeOut=function(e,t,i){var n=this;n.hideLeftMillisecond=-1,n._timeFinish()},i}(mo.gui.Layer);e.FightTreasureList=t,egret.registerClass(t,"g_fight.FightTreasureList")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(t){function i(){t.apply(this,arguments),this.getEnemyListLeftMillisecond=-1,this.refreshLeftMillisecond=-1}__extends(i,t);var n=(__define,i),o=n.prototype;return o._initProp=function(){t.prototype._initProp.call(this)},o.dataChanged=function(){t.prototype.dataChanged.call(this)},o.onExit=function(){t.prototype.onExit.call(this),this.cleanCDTime()},o._childrenCreated=function(){t.prototype._childrenCreated.call(this);var e=this;gd.pkOutCtrl.getEnemyList(function(t){e.data.list=t,e._reset(),e._resetSearchBtn()},e)},o._setItem=function(e,t){var i=this,n=i["ico_role"+e],o=uiHelper.getHeroIcon(t[gc.dsConsts.PkOutUserData.iconId],0);mo.R.loadTo("FightScene",o,function(){}),n.source=o;var r=i["img_carry_treasure"+e],a=i["grp_name_container"+e];r.parent&&a.removeElement(r),t[gc.dsConsts.PkOutUserData.isTreasure]&&(r.parent||a.addElement(r))},o._setSearchCoolDown=function(e){var t=this,i=t.data.extra.lm;t.coolDownLabel=t["label_searching"+e],t.setCDTime(i/1e3)},o._reset=function(){for(var e=this,t=e.data,i=t.list,n=0;3>n;++n){var o=e["grp_enemy"+n],r=e["grp_searching"+n],a=e["grp_no_enemy"+n];n<i.length?(o.visible=!0,r.visible=!1,a.visible=!1,e._setItem(n,i[n])):n==i.length?(o.visible=!1,r.visible=!0,a.visible=!1,e._setSearchCoolDown(n)):(o.visible=!1,r.visible=!1,a.visible=!0)}},o._resetSearchBtn=function(){var e=this,t=gd.userCtrl.getTodayCount(gc.c_prop.userRefreshCountKey.spies);t=void 0==t?0:t,e.label_cost.text=gc.calSpies(t+1),e.label_search_count.text="高级探秘次数:"+t;var i=mo.getJSONWithFileNameAndID(gc.cfg_c_game,gc.id_c_game.treasure),n=i[4],o=i[5];if(0!=t&&t%n==0){var r=gd.userCtrl.getLastTime(gc.c_prop.userRefreshCountKey.spies),a=new Date(r),s=a.getSecondsBetween(Date.newDate());if(o>s)return e.grp_cost.visible=!1,void e.setCDTime2(o-s)}e.grp_cost.visible=!0,e.label_search_refresh.text=""},o._timeInterval=function(){var e=this;e.coolDownLabel&&(e.coolDownLabel.text="寻找对手中   "+mo.getTimeStr(e.getEnemyListLeftMillisecond))},o._timeFinish=function(){var e=this;e.coolDownLabel=void 0},o._timeInterval2=function(){var e=this;e.label_search_refresh&&(e.label_search_refresh.text="CD中 "+mo.getTimeStr(e.refreshLeftMillisecond)+"      ")},o._timeFinish2=function(){var e=this;e.grp_cost.visible=!0,e.label_search_refresh.text=""},o._challenge=function(t){var i=this;e.PVPBattle.create().setData({pkTarget:i.data.list[t]}).show()},o._search=function(e){var t=this;gd.pkOutCtrl.refreshEnemy(!0,function(e){t.data.list=e,t._reset(),t._callFightLayer()},t)},o._callFightLayer=function(){var e=this,t=e.data.extra.fl;t.resetPvpEnemyViewOnlyDraw(e.data.list)},o._tap_btn_p_search=function(){var e=this;return e.refreshLeftMillisecond>0?mo.showMsg("此功能正在CD中"):gd.userCtrl.getDiamond()<parseInt(e.label_cost.text)?mo.showMsg(gc.id_c_msgCode.noDiamond):(e.grp_searching.visible=!0,void gd.pkOutCtrl.treasureBiz(function(t){e.grp_searching.visible=!1,e.data.list=t,e._reset(),e._resetSearchBtn(),e._callFightLayer()},e))},o._tap_ico_challenge0=function(){var e=this;e._challenge(0)},o._tap_ico_challenge1=function(){var e=this;e._challenge(1)},o._tap_ico_challenge2=function(){var e=this;e._challenge(2)},o._tap_btn_search0=function(){var e=this;e._search(0)},o._tap_btn_search1=function(){var e=this;e._search(1)},o._tap_btn_search2=function(){var e=this;e._search(2)},o.setCDTime=function(e){var t=this;if(e>0){t.timeTrigger&&(tm.timer.remove(t.timeTrigger),t.timeTrigger=null);var i=Date.newDate(Date.newDate().getTime()+1e3*e),n=t.timeTrigger=new tm.Trigger(i);n.on(tm.Trigger.ON_SECOND,t.timeSec,t),n.on(tm.Trigger.ON_END,t.timeOut,t),tm.timer.add(n)}},o.cleanCDTime=function(){var e=this;e.timeTrigger&&(tm.timer.remove(e.timeTrigger),e.timeTrigger=null)},o.timeSec=function(e,t,i){var n=this,o=Date.newDate().getTime(),r=Date.newDate(i).getTime();n.getEnemyListLeftMillisecond=r-o,n.getEnemyListLeftMillisecond<0&&(n.getEnemyListLeftMillisecond=0),n._timeInterval()},o.timeOut=function(e,t,i){var n=this;n.getEnemyListLeftMillisecond=-1,n._timeFinish()},o.setCDTime2=function(e){var t=this;if(e>0){t.timeTrigger2&&(tm.timer.remove(t.timeTrigger2),t.timeTrigger2=null);var i=Date.newDate(Date.newDate().getTime()+1e3*e),n=t.timeTrigger2=new tm.Trigger(i);n.on(tm.Trigger.ON_SECOND,t.timeSec2,t),n.on(tm.Trigger.ON_END,t.timeOut2,t),tm.timer.add(n)}},o.cleanCDTime2=function(){var e=this;e.timeTrigger2&&(tm.timer.remove(e.timeTrigger2),e.timeTrigger2=null)},o.timeSec2=function(e,t,i){var n=this,o=Date.newDate().getTime(),r=Date.newDate(i).getTime();n.refreshLeftMillisecond=r-o,n.refreshLeftMillisecond<0&&(n.refreshLeftMillisecond=0),n._timeInterval2()},o.timeOut2=function(e,t,i){var n=this;n.refreshLeftMillisecond=-1,n._timeFinish2()},i}(mo.gui.Layer);e.FightTreasureOutside=t,egret.registerClass(t,"g_fight.FightTreasureOutside")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments),this.hideLeftMillisecond=-1}__extends(t,e);var i=(__define,t),n=i.prototype;return n._initProp=function(){e.prototype._initProp.call(this)},n._childrenCreated=function(){e.prototype._childrenCreated.call(this);var t=this;t.ico_item.onClick(function(e){})},n.dataChanged=function(){e.prototype.dataChanged.call(this);var t=this;t._reset()},n._reset=function(){var e=this,t=e.data,i=t.t,n=t.o;e.ico_item.setData({itemId:i[gc.t_treasure_id],count:1}),e.cleanCDTime(),0==n[gc.dsConsts.TreasureInfo.status]?e.label_time.visible=!1:1==n[gc.dsConsts.TreasureInfo.status]?(e.label_time.visible=!0,e._resetTime(n[gc.dsConsts.TreasureInfo.openTime])):2==n[gc.dsConsts.TreasureInfo.status]&&(e.label_time.visible=!0,e.label_time.text=mo.STR.format("[ubb color=#3AF5AA]%s[/ubb]","已解锁"))},n._resetTime=function(e){var t=this,i=new Date(e),n=i.getSecondsBetween(Date.newDate());t.setCDTime(t.data.t[gc.t_treasure_guardTime]-n)},n._timeInterval=function(){var e=this;e.label_time.text=mo.getTimeStr(e.hideLeftMillisecond)},n._timeFinish=function(){var e=this;e.label_time.text="已解锁"},n.setCDTime=function(e){var t=this;if(e>0){t.timeTrigger&&(tm.timer.remove(t.timeTrigger),t.timeTrigger=null);var i=Date.newDate(Date.newDate().getTime()+1e3*e),n=t.timeTrigger=new tm.Trigger(i);n.on(tm.Trigger.ON_SECOND,t.timeSec,t),n.on(tm.Trigger.ON_END,t.timeOut,t),tm.timer.add(n)}},n.cleanCDTime=function(){var e=this;e.timeTrigger&&(tm.timer.remove(e.timeTrigger),e.timeTrigger=null)},n.timeSec=function(e,t,i){var n=this,o=Date.newDate().getTime(),r=Date.newDate(i).getTime();n.hideLeftMillisecond=r-o,n.hideLeftMillisecond<0&&(n.hideLeftMillisecond=0),n._timeInterval()},n.timeOut=function(e,t,i){var n=this;n.hideLeftMillisecond=-1,n._timeFinish()},t}(mo.gui.ItemRenderer);e.FightTreasureItem=t,egret.registerClass(t,"g_fight.FightTreasureItem")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return n._initProp=function(){e.prototype._initProp.call(this)},n._childrenCreated=function(){e.prototype._childrenCreated.call(this)},n.dataChanged=function(){e.prototype.dataChanged.call(this);var t=this,i=t.data.o,n=i[gc.dsConsts.TreasureRecordEntity.recordType],o="";o=i[gc.dsConsts.TreasureRecordEntity.userVip]>0?mo.STR.format("[ubb color=#ffad00]VIP%s [/ubb][ubb color=#00cdff]%s[/ubb]",i[gc.dsConsts.TreasureRecordEntity.userVip],i[gc.dsConsts.TreasureRecordEntity.userName]):mo.STR.format("[ubb color=#00cdff]%s[/ubb]",i[gc.dsConsts.TreasureRecordEntity.userName]),i[gc.dsConsts.TreasureRecordEntity.guildName]&&(o=mo.STR.format("[ubb color=#e76df5][%s][/ubb]",i[gc.dsConsts.TreasureRecordEntity.guildName])+o);var r="",a=uiHelper.getColorByQuality(t.data.color);if(n==gc.c_prop.treasureRecordTypeKey.getTreasure)r=mo.STR.format("秘宝 [ubb color=%s]%s[/ubb] 刚刚被 %s 拾取,有实力的大侠赶紧去劫镖!",a,t.data.name,o);else if(n==gc.c_prop.treasureRecordTypeKey.pkTreasure)r=mo.STR.format("秘宝 [ubb color=%s]%s[/ubb] 刚刚被一名凶残的玩家 %s 夺取,有实力的大侠赶紧去劫镖!",a,t.data.name,o);else if(n==gc.c_prop.treasureRecordTypeKey.openTreasure){for(var s="",l=t.data.got,g=0;g<l.length;g++){var c=l[g],_=uiHelper.getColorByQuality(c.item[gc.t_item_color]);s=mo.STR.format("%s [ubb color=%s]%s[/ubb] x%s",s,_,c.item[gc.t_item_name],c.count)}r=mo.STR.format("秘宝 [ubb color=%s]%s[/ubb] 刚刚被 %s 成功打开!获得了%s",a,t.data.name,o,s)}else n==gc.c_prop.treasureRecordTypeKey.compose&&(r=mo.STR.format("玩家 %s 刚刚合成了 [ubb color=%s]%s[/ubb]",o,uiHelper.getColorByQuality(t.data.color),t.data.name));t.label_content.text=r,t.label_time.text=Date.newDate(i[gc.dsConsts.TreasureRecordEntity.recordDate]).toFormat("YYYY-MM-DD HH24:MI:SS")},t}(mo.gui.ItemRenderer);e.FightTreasureChatItem=t,egret.registerClass(t,"g_fight.FightTreasureChatItem")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(t){function i(){t.apply(this,arguments)}__extends(i,t);var n=(__define,i),o=n.prototype;return o._initProp=function(){var i=this;t.prototype._initProp.call(this),i._Item_list_items=e.FightTreasureComposeItem},o.dataChanged=function(){t.prototype.dataChanged.call(this)},o._childrenCreated=function(){t.prototype._childrenCreated.call(this);var e=this;e._reset(),e._resetDesc()},o._reset=function(){var e=this,t=mo.getJSONWithFileNameAndID(gc.cfg_t_treasure,e.data.obj.t[gc.t_treasure_id]),i=mo.getJSONWithFileName(gc.cfg_t_item),n=t[gc.t_treasure_items];e.actItems=[],e.curIndex=0;for(var o=0,r=0;r<n.length;r++){var a=n[r],s=a[0];e.data.unlock>=s&&s>o&&(e.curIndex=r,o=s),e.actItems.push({o:a,isNow:0,item:i[a[1]],current:e.data.unlock})}e.actItems[e.curIndex].isNow=1,e.refreshList("list_items")},o._resetDesc=function(){var e=this,t=mo.getJSONWithFileName(gc.cfg_t_item),i=e.data.obj.t,n=t[i[gc.t_treasure_id]],o=uiHelper.getColorByQuality(n[gc.t_item_color]),r=(mo.getJSONWithFileNameAndID(gc.cfg_t_treasure,i[gc.t_treasure_id]),e.actItems[e.curIndex].o),a=t[r[1]],s=mo.STR.format("您当前选择[ubb color=%s] %s [/ubb]进行合成[/br]同类碎片已解锁 %s 个[/br]还有 %s 个正在解锁中[/br]当前合成后可获得 [ubb color=%s]%s[/ubb](消耗%s碎片)[/br]",o,n[gc.t_item_name],e.data.unlock,e.data.lock,uiHelper.getColorByQuality(a[gc.t_item_color]),a[gc.t_item_name],r[0]);e.label_desc.text=s,e.label_compose_hint.visible=1==e.data.isfinished?!1:!0,e.btn_compose.visible=1==e.data.isfinished?!0:!1},o._data_list_items=function(){var e=this;return e.actItems},o._tap_btn_info=function(){g_base.BaseShowTip.create().setData({id:213}).show()},o._tap_btn_compose=function(){var e=this;e.data.isfinished&&gd.pkOutCtrl.compose(e.data.obj.t[gc.t_treasure_id],function(t){mo.showMsg("合成成功,请至邮箱查收物品!");var i=e.data.parent;i._reset(),e.close()},e)},i}(mo.gui.Dlg);e.FightTreasureCompose=t,egret.registerClass(t,"g_fight.FightTreasureCompose")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return n._initProp=function(){e.prototype._initProp.call(this)},n._childrenCreated=function(){e.prototype._childrenCreated.call(this);var t=this;t.ico_item.onClick(function(){g_base.BaseItemDetail.create().setData({bdc:gd.BagDataCtrl.create(this.get("itemId"),null)}).show()},t.ico_item)},n.dataChanged=function(){e.prototype.dataChanged.call(this);var t=this;t._reset()},n._reset=function(){var e=this;e.ico_item.setData({itemId:e.data.item[gc.t_item_id],count:1}),e.ico_item.label_text.visible=!1;var t=e.data.current<e.data.o[0]?"0xff0000":"0xffffff";e.label_name.text=mo.STR.format("[ubb color=%s]%s[/ubb]",uiHelper.getColorByQuality(e.data.item[gc.t_item_color]),e.data.item[gc.t_item_name]),e.label_count.text=mo.STR.format("([ubb color=%s]%s[/ubb]/%s)",t,e.data.current,e.data.o[0]),1==e.data.isNow?e.ico_bg.source="ico_treasure_bg_s":e.ico_bg.source="ico_treasure_bg",e.label_open_hint.text="开出红色秘宝概率 "+e.data.o[2]+"%"},t}(mo.gui.ItemRenderer);e.FightTreasureComposeItem=t,egret.registerClass(t,"g_fight.FightTreasureComposeItem")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return t.getFightEffect=function(e,i){var n=100*e+i,o=t._effects[n]||new t;return t._effects[n]=null,o},t.removeFightEffect=function(e){var i=100*e.key+e.aspect;t._effects[i]=e},n.getEffectUrl=function(e,t,i){var n=[null,"A","B","C","D","E"],o="e"+e+n[6>t?t:t-4];return i&&(o=mo.STR.format("resource/dynamic2/%s.%s",o,i)),o},n.startLoadByKey=function(e,t){if(this.key!=e||this.aspect!=t){this.key=e,this.aspect=t;var i=this;i.loadRes(i.getEffectUrl(e,t),i.getEffectUrl(e,t,"png"))}},n.loadRes=function(e,t,i,n){void 0===i&&(i=null),void 0===n&&(n=null);var o=this;o.jsonData=mo.getData("mc",e),o.texture=null,RES.getResByUrl(t,function(e){o.texture=e,o.initMc(),o.jsonData&&o.texture&&i&&i.call(n)},o)},t._effects={},t}(g_base.Effect);e.FightEffect=t,egret.registerClass(t,"g_fight.FightEffect")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return n._initProp=function(){e.prototype._initProp.call(this);
var t=this;t._penetrable=!0,t._layerOpt.shownWithAction=!1},n.dataChanged=function(){e.prototype.dataChanged.call(this);var t=this,i=t.data.copyId,n=t.data.monsterId,o=mo.getJSONWithFileNameAndID(gc.cfg_t_copy,i),r=mo.getJSONWithFileName(gc.cfg_t_monster),a=r[n],s=t.grp_copy.y;null!=a&&0!=a[gc.t_monster_bossLevel]?t.label_copy.text=a[gc.t_monster_name]:t.label_copy.text=o[gc.t_copy_name],t.grp_copy.scaleX=t.grp_copy.scaleY=1.2,t.grp_copy.alpha=0,t.grp_copy.x=-48,t.grp_copy.y=s-13.9,egret.Tween.get(t.grp_copy).to({scaleX:1,scaleY:1,alpha:1,x:0,y:s},500).wait(900).to({scaleX:1.2,scaleY:1.2,alpha:0,x:-48,y:s-13.9},500).call(function(){t.close()})},t}(g_base.BaseFightDlg);e.EnterCopyEffect=t,egret.registerClass(t,"g_fight.EnterCopyEffect")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(t){function i(){t.apply(this,arguments)}__extends(i,t);var n=__define,o=i,r=o.prototype;return n(r,"buff",function(){return this._buff},function(t){this._buff=t,this.startLoadByKey(this.buff.effectRes,e.ROLE_ASPECT_UP)}),i}(e.FightEffect);e.BuffEffect=t,egret.registerClass(t,"g_fight.BuffEffect")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return n._initProp=function(){e.prototype._initProp.call(this)},n._childrenCreated=function(){e.prototype._childrenCreated.call(this)},n.onEnter=function(){e.prototype.onEnter.call(this);var t=this,i=t.data.isWin,n=t.data.isTimeout,o=t.data.fightResult,r=t.data.begTime,a=t.data.fightType;t.ico_win.visible=i,t.grp_winRank.visible=i,t.ico_fail.visible=!i&&!n,t.ico_timeout.visible=n,t.grp_failRank.visible=!i,t.upWarn.visible=!i,t.label_myName.text=o[gc.dsConsts.FightResult.attackMember][0],t.label_myCombat.text=o[gc.dsConsts.FightResult.attackMember][1].toString(),t.label_enemyName.text=o[gc.dsConsts.FightResult.beAttackMember][0],t.label_enemyCombat.text=o[gc.dsConsts.FightResult.beAttackMember][1].toString(),t.ico_myRole.source=uiHelper.getHeroIcon(o[gc.dsConsts.FightResult.attackMember][2]),t.ico_enemyRole.source=uiHelper.getHeroIcon(o[gc.dsConsts.FightResult.beAttackMember][2]),a==gc.c_prop.fightTypeKey.challengeCupPk?(t.grp_winRank.visible=!1,t.grp_failRank.visible=!1,t.grp_res.visible=!1):(t.label_gold.text=o[gc.dsConsts.FightResult.gold].toString(),t.label_sw.text=o[gc.dsConsts.FightResult.prestige].toString(),i?t.label_winRank.text=o[gc.dsConsts.FightResult.curRank].toString():t.label_failRank.text="竞技场排名"+o[gc.dsConsts.FightResult.curRank]);var s=Math.ceil((r-Date.newDate().getTime())/1e3);t.setCDTime(s)},n.onExit=function(){e.prototype.onExit.call(this);var t=this;null!=t.data.callback&&t.data.callback.call(t.data.target),t.timeTrigger&&(tm.timer.remove(t.timeTrigger),t.timeTrigger=null)},n.setCDTime=function(e){var t=this;if(e>0){t.timeTrigger&&(tm.timer.remove(t.timeTrigger),t.timeTrigger=null);var i=Date.newDate(Date.newDate().getTime()+1e3*e),n=t.timeTrigger=new tm.Trigger(i);n.on(tm.Trigger.ON_SECOND,t.timeSec,t),n.on(tm.Trigger.ON_END,t.timeOut,t),tm.timer.add(n),t.btn_back.label=mo.STR.format("返回(%s)",e.toString())}},n.timeSec=function(e,t,i){var n=this,o=Date.newDate().getTime(),r=Date.newDate(i).getTime(),a=r-o;n.btn_back.label=mo.STR.format("返回(%s)",Math.floor(a/1e3).toString())},n.timeOut=function(e,t,i){var n=this;n._tap_btn_back()},n._tap_btn_back=function(){var e=this;e.close()},t}(e.FightDlg);e.FightArenaWinOrFail=t,egret.registerClass(t,"g_fight.FightArenaWinOrFail")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return n._initProp=function(){e.prototype._initProp.call(this)},n._childrenCreated=function(){e.prototype._childrenCreated.call(this)},n.onEnter=function(){e.prototype.onEnter.call(this);var t=this,i=t.data.isWin,n=t.data.isTimeout,o=t.data.fightResult,r=t.data.begTime;t.data.fightType;t.ico_win.visible=i,t.ico_fail.visible=!i&&!n,t.ico_timeout.visible=n,t.upWarn.visible=!i,t.label_myName.text=o[gc.dsConsts.FightResult.attackMember][0],t.label_enemyName.text=o[gc.dsConsts.FightResult.beAttackMember][0],t.ico_myRole.source=uiHelper.getHeroIcon(o[gc.dsConsts.FightResult.attackMember][2]),t.ico_enemyRole.source=uiHelper.getHeroIcon(o[gc.dsConsts.FightResult.beAttackMember][2]),t.grp_res.visible=i;var a=o[gc.dsConsts.FightResult.coffersPoints]||0;if(t.label_score.text=a,i)if(0==o[gc.dsConsts.FightResult.coffersStatus]){var s=mo.getJSONWithFileNameAndID(gc.cfg_c_game,gc.id_c_game.coffers);t.label_ap.text="-"+s[8],t.label_noRob.visible=!1;var s=mo.getJSONWithFileNameAndID(gc.cfg_c_game,gc.id_c_game.coffers3),l=s[4].split(",");t.ico_item.source=resHelper.getItemIconPath(l[0]),t.label_item.text=l[1]}else t.label_ap.text="-0",t.label_noRob.visible=!0,t.grp_res.visible=!1;else{var s=mo.getJSONWithFileNameAndID(gc.cfg_c_game,gc.id_c_game.coffers);t.label_ap.text="-"+s[8],t.label_noRob.visible=!1;var g=t.grp_enemyFace.y;t.grp_enemyFace.y=t.grp_myFace.y,t.grp_myFace.y=g,g=t.label_enemyName.y,t.label_enemyName.y=t.label_myName.y,t.label_myName.y=g}var c=Math.ceil((r-Date.newDate().getTime())/1e3);t.setCDTime(c)},n.onExit=function(){e.prototype.onExit.call(this);var t=this;null!=t.data.callback&&t.data.callback.call(t.data.target),t.timeTrigger&&(tm.timer.remove(t.timeTrigger),t.timeTrigger=null)},n.setCDTime=function(e){var t=this;if(e>0){t.timeTrigger&&(tm.timer.remove(t.timeTrigger),t.timeTrigger=null);var i=Date.newDate(Date.newDate().getTime()+1e3*e),n=t.timeTrigger=new tm.Trigger(i);n.on(tm.Trigger.ON_SECOND,t.timeSec,t),n.on(tm.Trigger.ON_END,t.timeOut,t),tm.timer.add(n),t.btn_back.label=mo.STR.format("返回(%s)",e.toString())}},n.timeSec=function(e,t,i){var n=this,o=Date.newDate().getTime(),r=Date.newDate(i).getTime(),a=r-o;n.btn_back.label=mo.STR.format("返回(%s)",Math.floor(a/1e3).toString())},n.timeOut=function(e,t,i){var n=this;n._tap_btn_back()},n._tap_btn_back=function(){var e=this;e.close(),gd.coffersCtrl.getLastEnemyDefeseData(function(e){mo.moduleMgr.runModule(g_consts.moduleId.home,{subModuleId:g_consts.HS_SUBMID_COFFERS_SERVER,defData:e,page:1})},e)},t}(e.FightDlg);e.FightCoffersWinOrFail=t,egret.registerClass(t,"g_fight.FightCoffersWinOrFail")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return n._initProp=function(){e.prototype._initProp.call(this)},n._childrenCreated=function(){e.prototype._childrenCreated.call(this)},n.onEnter=function(){e.prototype.onEnter.call(this);var t=this,i=t.data.isWin,n=t.data.isTimeout,o=t.data.fightResult,r=t.data.begTime;t.data.fightType;if(t.ico_win.visible=i,t.ico_timeout.visible=n,t.grp_res.visible=i,0==o[gc.dsConsts.FightResult.coffersStatus]){t.label_gold.text="+"+o[gc.dsConsts.FightResult.coffersPerson].toString(),t.label_gold2.text="+"+o[gc.dsConsts.FightResult.coffersCommon].toString();var a=mo.getJSONWithFileNameAndID(gc.cfg_c_game,gc.id_c_game.coffers3);t.label_ap.text="-"+a[6],t.label_noRob.visible=!1,t.label_hurt.text=""+o[gc.dsConsts.FightResult.coffersHurt]}else t.label_noRob.visible=!0,t.grp_res.visible=!1,t.label_ap.text="-0";var s=Math.ceil((r-Date.newDate().getTime())/1e3);t.setCDTime(s)},n.onExit=function(){e.prototype.onExit.call(this);var t=this;null!=t.data.callback&&t.data.callback.call(t.data.target),t.timeTrigger&&(tm.timer.remove(t.timeTrigger),t.timeTrigger=null),gd.coffersCtrl.getLastEnemyDefeseData(function(e){mo.moduleMgr.runModule(g_consts.moduleId.home,{subModuleId:g_consts.HS_SUBMID_COFFERS_SERVER,defData:e,page:2})},t)},n.setCDTime=function(e){var t=this;if(e>0){t.timeTrigger&&(tm.timer.remove(t.timeTrigger),t.timeTrigger=null);var i=Date.newDate(Date.newDate().getTime()+1e3*e),n=t.timeTrigger=new tm.Trigger(i);n.on(tm.Trigger.ON_SECOND,t.timeSec,t),n.on(tm.Trigger.ON_END,t.timeOut,t),tm.timer.add(n),t.btn_back.label=mo.STR.format("返回(%s)",e.toString())}},n.timeSec=function(e,t,i){var n=this,o=Date.newDate().getTime(),r=Date.newDate(i).getTime(),a=r-o;n.btn_back.label=mo.STR.format("返回(%s)",Math.floor(a/1e3).toString())},n.timeOut=function(e,t,i){var n=this;n._tap_btn_back()},n._tap_btn_back=function(){var e=this;e.close()},t}(e.FightDlg);e.FightCoffersBoss=t,egret.registerClass(t,"g_fight.FightCoffersBoss")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return n._initProp=function(){e.prototype._initProp.call(this)},n._childrenCreated=function(){e.prototype._childrenCreated.call(this)},n.onEnter=function(){e.prototype.onEnter.call(this);var t=this,i=t.data.isWin,n=t.data.isTimeout,o=t.data.fightResult,r=t.data.begTime;t.data.fightType;t.ico_win.visible=i,t.ico_fail.visible=!i&&!n,t.ico_timeout.visible=n,t.upWarn.visible=!i,t.label_myName.text=o[gc.dsConsts.FightResult.attackMember][0],t.label_enemyName.text=o[gc.dsConsts.FightResult.beAttackMember][0],t.label_myServer.text=o[gc.dsConsts.FightResult.attackMember][3],t.label_enemyServer.text=o[gc.dsConsts.FightResult.beAttackMember][3],t.label_myGuild.text=o[gc.dsConsts.FightResult.attackMember][4],t.label_enemyGuild.text=o[gc.dsConsts.FightResult.beAttackMember][4],t.ico_myRole.source=uiHelper.getHeroIcon(o[gc.dsConsts.FightResult.attackMember][2]),t.ico_enemyRole.source=uiHelper.getHeroIcon(o[gc.dsConsts.FightResult.beAttackMember][2]);var a=o[gc.dsConsts.FightResult.guildWarStatus],s=o[gc.dsConsts.FightResult.guildWarPoints]||0;t.label_score.text=t.label_damage.text=s,2==a?(t.label_end.visible=!0,t.label_noRob.visible=!1):(t.label_end.visible=!1,0!=s?t.label_noRob.visible=!1:t.label_noRob.visible=!0);var l=Math.ceil((r-Date.newDate().getTime())/1e3);t.setCDTime(l)},n.onExit=function(){e.prototype.onExit.call(this);var t=this;null!=t.data.callback&&t.data.callback.call(t.data.target),t.timeTrigger&&(tm.timer.remove(t.timeTrigger),t.timeTrigger=null)},n.setCDTime=function(e){var t=this;if(e>0){t.timeTrigger&&(tm.timer.remove(t.timeTrigger),t.timeTrigger=null);var i=Date.newDate(Date.newDate().getTime()+1e3*e),n=t.timeTrigger=new tm.Trigger(i);n.on(tm.Trigger.ON_SECOND,t.timeSec,t),n.on(tm.Trigger.ON_END,t.timeOut,t),tm.timer.add(n),t.btn_back.label=mo.STR.format("返回(%s)",e.toString())}},n.timeSec=function(e,t,i){var n=this,o=Date.newDate().getTime(),r=Date.newDate(i).getTime(),a=r-o;n.btn_back.label=mo.STR.format("返回(%s)",Math.floor(a/1e3).toString())},n.timeOut=function(e,t,i){var n=this;n._tap_btn_back()},n._tap_btn_back=function(){var e=this;e.close();var t=gd.guildWarCtrl.curGuildServer;gd.guildWarCtrl.getWarAttackData(t[gc.dsConsts.GuildServer.serverId],t[gc.dsConsts.GuildServer.guildId],function(e){mo.moduleMgr.runModule(g_consts.moduleId.guildwar,{atkData:e})},e)},t}(e.FightDlg);e.FightGuildWarWinOrFail=t,egret.registerClass(t,"g_fight.FightGuildWarWinOrFail")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return n._initProp=function(){var t=this;e.prototype._initProp.call(this),t._Item_list_items=g_base.BaseItemCell},n._childrenCreated=function(){e.prototype._childrenCreated.call(this)},n.onEnter=function(){e.prototype.onEnter.call(this);var t=this,i=t.data.isWin,n=(t.data.fightResult,t.data.begTime);t.ico_win.visible=i,t.ico_fail.visible=!i,t.upWarn.visible=!i,t.ico_winStar.visible=t.data.isWin,t.ico_noDieStar.visible=t.data.noDie,t.ico_timeLmtStar.visible=t.data.timeLmt,t.list_items.visible=i;var o=Math.ceil((n-Date.newDate().getTime())/1e3);t.setCDTime(o)},n._data_list_items=function(){var e=this;return e.data.items},n.onExit=function(){e.prototype.onExit.call(this);var t=this;null!=t.data.callback&&t.data.callback.call(t.data.target),t.timeTrigger&&(tm.timer.remove(t.timeTrigger),t.timeTrigger=null)},n.setCDTime=function(e){var t=this;if(e>0){t.timeTrigger&&(tm.timer.remove(t.timeTrigger),t.timeTrigger=null);var i=Date.newDate(Date.newDate().getTime()+1e3*e),n=t.timeTrigger=new tm.Trigger(i);n.on(tm.Trigger.ON_SECOND,t.timeSec,t),n.on(tm.Trigger.ON_END,t.timeOut,t),tm.timer.add(n),t.btn_ok.label=mo.STR.format("确定(%s)",e.toString())}},n.timeSec=function(e,t,i){var n=this,o=Date.newDate().getTime(),r=Date.newDate(i).getTime(),a=r-o;n.btn_ok.label=mo.STR.format("确定(%s)",Math.floor(a/1e3).toString())},n.timeOut=function(e,t,i){var n=this;n._tap_btn_ok()},n._tap_btn_ok=function(){var e=this;e.close()},t}(e.FightDlg);e.FightCopyWinOrFail=t,egret.registerClass(t,"g_fight.FightCopyWinOrFail")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return n._initProp=function(){e.prototype._initProp.call(this)},n._childrenCreated=function(){e.prototype._childrenCreated.call(this)},n.onEnter=function(){e.prototype.onEnter.call(this);var t=this,i=t.data.begTime,n=Math.ceil((i-Date.newDate().getTime())/1e3);t.setCDTime(n)},n.onExit=function(){e.prototype.onExit.call(this);var t=this;null!=t.data.callback&&t.data.callback.call(t.data.target),t.timeTrigger&&(tm.timer.remove(t.timeTrigger),t.timeTrigger=null)},n.setCDTime=function(e){var t=this;if(e>0){t.timeTrigger&&(tm.timer.remove(t.timeTrigger),t.timeTrigger=null);var i=Date.newDate(Date.newDate().getTime()+1e3*e),n=t.timeTrigger=new tm.Trigger(i);n.on(tm.Trigger.ON_SECOND,t.timeSec,t),n.on(tm.Trigger.ON_END,t.timeOut,t),tm.timer.add(n),t.btn_ok.label=mo.STR.format("确定(%s)",e.toString())}},n.timeSec=function(e,t,i){var n=this,o=Date.newDate().getTime(),r=Date.newDate(i).getTime(),a=r-o;n.btn_ok.label=mo.STR.format("确定(%s)",Math.floor(a/1e3).toString())},n.timeOut=function(e,t,i){var n=this;n._tap_btn_ok()},n._tap_btn_ok=function(){var e=this;e.close()},t}(e.FightDlg);e.FightRevive=t,egret.registerClass(t,"g_fight.FightRevive")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return n._tap_btn_star=function(){mo.moduleMgr.runModule(g_consts.moduleId.forge,{subModuleId:1})},n._tap_btn_stone=function(){mo.moduleMgr.runModule(g_consts.moduleId.forge,{subModuleId:2})},n._tap_btn_wing=function(){mo.moduleMgr.runModule(g_consts.moduleId.role,{subModuleId:3})},n._tap_btn_equip=function(){mo.moduleMgr.runModule(g_consts.moduleId.home,{subModuleId:0})},t}(mo.gui.Comp);e.FightUpWarn=t,egret.registerClass(t,"g_fight.FightUpWarn")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return n._initProp=function(){e.prototype._initProp.call(this);var t=this;t._Item_list_items=g_base.BaseItemCell},n._childrenCreated=function(){e.prototype._childrenCreated.call(this)},n.onEnter=function(){e.prototype.onEnter.call(this);var t=this,i=t.data.isWin,n=t.data.isTimeout,o=t.data.fightResult,r=t.data.begTime;t.ico_win.visible=i,t.label_winPkValue.visible=i,t.ico_fail.visible=!i&&!n,t.ico_timeout.visible=n,t.label_failPkValue.visible=!i,t.label_myRank.text=o[gc.dsConsts.FightResult.curRank],t.label_gold.text=o[gc.dsConsts.FightResult.gold],t.label_exp.text=o[gc.dsConsts.FightResult.expc],i?t.label_winPkValue.text=o[gc.dsConsts.FightResult.killValue]:t.label_failPkValue.text=o[gc.dsConsts.FightResult.killValue];var a=Math.ceil((r-Date.newDate().getTime())/1e3);t.setCDTime(a)},n.onExit=function(){e.prototype.onExit.call(this);var t=this;null!=t.data.callback&&t.data.callback.call(t.data.target),t.timeTrigger&&(tm.timer.remove(t.timeTrigger),t.timeTrigger=null)},n.setCDTime=function(e){var t=this;if(e>0){t.timeTrigger&&(tm.timer.remove(t.timeTrigger),t.timeTrigger=null);var i=Date.newDate(Date.newDate().getTime()+1e3*e),n=t.timeTrigger=new tm.Trigger(i);n.on(tm.Trigger.ON_SECOND,t.timeSec,t),n.on(tm.Trigger.ON_END,t.timeOut,t),tm.timer.add(n),t.btn_ok.label=mo.STR.format("确定(%s)",e.toString())}},n.timeSec=function(e,t,i){var n=this,o=Date.newDate().getTime(),r=Date.newDate(i).getTime(),a=r-o;n.btn_ok.label=mo.STR.format("确定(%s)",Math.floor(a/1e3).toString())},n.timeOut=function(e,t,i){var n=this;n._tap_btn_ok()},n._tap_btn_ok=function(){var e=this;e.close()},n._data_list_items=function(){var e=this;return utils.itemObj2ObjArr(e.data.fightResult[gc.dsConsts.FightResult.items])},t}(e.FightDlg);e.FightPKWinOrFail=t,egret.registerClass(t,"g_fight.FightPKWinOrFail")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddedToStage,this)}__extends(t,e);var i=(__define,t),n=i.prototype;return n.onAddedToStage=function(e){},t}(egret.Sprite);e.MapEleView=t,egret.registerClass(t,"g_fight.MapEleView")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments),this.begTime=0,this.itemIcon=new egret.Bitmap,this.textField=new egret.TextField}__extends(t,e);var i=(__define,t),n=i.prototype;return n.updateView=function(){var e=mo.getJSONWithFileNameAndID(gc.cfg_t_item,this.itemID),t=e[gc.t_item_type],i=uiHelper.getColorByQuality(e[gc.t_item_color]);this.textField.strokeColor=0,this.textField.stroke=.5,this.textField.textColor=i,this.textField.size=14;var n="";if(t==gc.c_prop.itemTypeKey.gold)this.textField.text=this.itemNum.toString(),n="resource/dynamic2/icon_100.png";else{var o=e[gc.t_item_name];n="resource/"+resHelper.getItemIconPath(this.itemID),this.itemID==gc.c_prop.spItemIdKey.diamond?this.textField.text=this.itemNum.toString():this.textField.text=o}process.nextTick(function(){this.textField&&(this.textField.x=this.x-this.textField.width/2)},this),RES.getResByUrl(n,function(e){this.itemIcon.texture=e,this.itemIcon.scaleX=this.itemIcon.scaleY=.5,this.itemIcon.x=-this.itemIcon.width*this.itemIcon.scaleX/2,this.addChild(this.itemIcon)},this,RES.ResourceItem.TYPE_IMAGE),this.cacheAsBitmap=!0},n.pickUp=function(){this.parent&&this.parent.removeChild(this),this.textField.parent&&this.textField.parent.removeChild(this.textField)},n.canAutoPickUp=function(){return 0!=this.begTime&&Date.newDate().getTime()-this.begTime>=3e3?!0:!1},t}(e.MapEleView);e.LootView=t,egret.registerClass(t,"g_fight.LootView")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(t){function i(){t.call(this),this.hideHp=9e15,this.hpBarBg=new egret.Bitmap,this.hpBar=new egret.Bitmap,this.addChild(this.hpBarBg),this.addChild(this.hpBar),this.hpTxt=new egret.TextField,this.hpTxt.width=100,this.hpTxt.size=12,this.hpTxt.textAlign=egret.HorizontalAlign.CENTER,this.addChild(this.hpTxt),this.hpTxt.x=-this.hpTxt.width/2,this.hpTxt.y=-12,this.nameTxt=new egret.TextField,this.nameTxt.width=100,this.nameTxt.size=12,this.nameTxt.textAlign=egret.HorizontalAlign.CENTER,this.addChild(this.nameTxt),this.nameTxt.x=-this.nameTxt.width/2,this.nameTxt.y=-24}__extends(i,t);var n=(__define,i),o=n.prototype;return o.dtor=function(){this.role.removeEventListener(e.ROLE_EVENT_HP_CHANGE,this.onRoleHpChange,this),this.role.removeEventListener(e.ROLE_EVENT_POS_CHANGE,this.onRolePosChange,this),this.role=null},o.setRole=function(t){var i=this;this.role=t,this.role.addEventListener(e.ROLE_EVENT_HP_CHANGE,this.onRoleHpChange,this),this.role.addEventListener(e.ROLE_EVENT_POS_CHANGE,this.onRolePosChange,this);var n=0;n=this.role.roleInfo.monsterInfo?this.role.roleInfo.monsterInfo[gc.t_monster_level]:this.role.entity.lvl,this.role.name&&""!=this.role.name?this.nameTxt.text=mo.STR.format("Lv.%s %s",n,this.role.name):this.nameTxt.text="",i.hpTxt.visible=i.role.roleInfo.maxHpFight!=i.hideHp,this.updateHp(),this.onRolePosChange(),!this.role.roleInfo.monsterInfo||this.role instanceof e.Pet?this.role.isSelf?(this.hpSrc="hp_green",this.hpBgSrc="hp_green_bg"):(this.hpSrc="hp_red",this.hpBgSrc="hp_red_bg"):this.role.isBoss?(this.hpSrc="hp_red",this.hpBgSrc="hp_red_bg"):(this.hpSrc="hp_red2",this.hpBgSrc="hp_red2_bg"),this.checkHPBitmapData(),this.checkHPBgBitmapData()},o.checkHPBitmapData=function(){var e=i.bitmapDataObj[this.hpSrc];e?(this.hpBar.bitmapData=e,this.hpBar.x=-this.hpBar.width/2):RES.getResAsync(this.hpSrc,function(){i.bitmapDataObj[this.hpSrc]=RES.getRes(this.hpSrc).bitmapData,this.checkHPBitmapData()},this)},o.checkHPBgBitmapData=function(){var e=i.bitmapDataObj[this.hpBgSrc];e?(this.hpBarBg.bitmapData=e,this.hpBarBg.x=-this.hpBarBg.width/2):RES.getResAsync(this.hpBgSrc,function(){i.bitmapDataObj[this.hpBgSrc]=RES.getRes(this.hpBgSrc).bitmapData,this.checkHPBgBitmapData()},this)},o.updateHp=function(){var e=this;this.hpBar.scaleX=this.role.hp/this.role.roleInfo.maxHpFight,e.role.roleInfo.maxHpFight!=e.hideHp&&this.role.hp<this.role.roleInfo.maxHpFight?(this.hpTxt.visible=!0,this.hpTxt.text=this.role.hp.toString()):this.hpTxt.visible=!1},o.onRoleHpChange=function(e){this.updateHp()},o.onRolePosChange=function(e){void 0===e&&(e=null),this.x=this.role.x,this.role.isBoss?this.y=this.role.y-100:this.y=this.role.y-85},i.bitmapDataObj={hp_red:null,hp_red_bg:null,hp_green:null,hp_green_bg:null,hp_red2:null,hp_red2_bg:null},i}(e.MapEleView);e.RoleNameView=t,egret.registerClass(t,"g_fight.RoleNameView")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(t){function i(){t.call(this),this.shadow=new egret.Bitmap,this.addChild(this.shadow),this.cacheAsBitmap=!0}__extends(i,t);var n=(__define,i),o=n.prototype;return o.dtor=function(){this.role.removeEventListener(e.ROLE_EVENT_POS_CHANGE,this.onRolePosChange,this),this.role=null},o.setRole=function(t){this.role=t,this.role.addEventListener(e.ROLE_EVENT_POS_CHANGE,this.onRolePosChange,this),this.onRolePosChange(),RES.getResAsync("fight_shadow",function(){this.shadow.texture=RES.getRes("fight_shadow"),this.shadow.x=-this.shadow.width/2,this.shadow.y=-this.shadow.height/2},this)},o.onRolePosChange=function(e){void 0===e&&(e=null),this.x=this.role.x,this.y=this.role.y},i}(e.MapEleView);e.RoleShadowView=t,egret.registerClass(t,"g_fight.RoleShadowView")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(t){function i(){t.call(this),this.scale=1;var e=this;e.apCon=new egret.Sprite,e.addChild(e.apCon),e.roleAP=new g_base.ActionPlayer,e.apCon.addChild(e.roleAP),e.medalCon=new egret.gui.UIAsset,e.medalCon.scaleX=e.medalCon.scaleY=.8,e.roleAP.addEventListener(egret.Event.COMPLETE,e.onRoleComplete,e)}__extends(i,t);var n=(__define,i),o=n.prototype;return o.setRole=function(t){var i=this;if(i.role=t,i.role.addEventListener(e.ROLE_EVENT_AVATAR_CHANGE,i.onRoleAvatarChange,i),i.role.addEventListener(e.ROLE_EVENT_MEDAL_CHANGE,i.onRoleMedalChange,i),i.role.addEventListener(e.ROLE_EVENT_POS_CHANGE,i.onRolePosChange,i),i.role.addEventListener(e.ROLE_EVENT_ATTACK,i.onRoleAttack,i),i.role.addEventListener(e.ROLE_EVENT_ADD_BUFF,i.onRoleAddBuff,i),i.role.addEventListener(e.ROLE_EVENT_REMOVE_BUFF,i.onRoleRemoveBuff,i),i.role.addEventListener(e.ROLE_EVENT_BENUMB_CHANGED,i.onRoleBenumb,i),null!=i.role.weaponID&&-1!=i.role.weaponID&&null==i.weaponAP&&(i.weaponAP=new g_base.ActionPlayer,i.apCon.addChild(i.weaponAP)),null!=i.role.wingID&&-1!=i.role.wingID&&null==i.wingAP&&(i.wingAP=new g_base.ActionPlayer,i.apCon.addChild(i.wingAP)),i.onRoleAvatarChange(),i.onRolePosChange(),null!=i.role.roleInfo.monsterInfo){var n=i.role.roleInfo.monsterInfo[gc.t_monster_scale]/1e4;0!=n&&(i.scale=n,i.scaleX=i.scaleY=n,i.medalEffect&&(i.medalEffect.scaleX=i.scaleX<0?-1:1)),i.role.isBoss&&(i.bossBgEffect||(i.bossBgEffect=new e.FightEffect,i.addChildAt(i.bossBgEffect,0),i.bossBgEffect.play(-1),i.bossBgEffect.scaleX=i.bossBgEffect.scaleY=1/i.scaleX),i.bossBgEffect.startLoadByKey(27,e.ROLE_ASPECT_UP))}else i.onRoleMedalChange()},o.stop=function(){var e=this;e.roleAP.stop(),null!=e.weaponAP&&e.weaponAP.stop(),null!=e.wingAP&&e.wingAP.stop()},o.playAction=function(){var e=this;e.roleAP.playAction(),null!=e.weaponAP&&e.weaponAP.playAction(),null!=e.wingAP&&e.wingAP.playAction()},o.dtor=function(){var t=this;t.roleAP.removeEventListener(egret.Event.COMPLETE,t.onRoleComplete,t),t.role&&(t.role.removeEventListener(e.ROLE_EVENT_AVATAR_CHANGE,t.onRoleAvatarChange,t),t.role.removeEventListener(e.ROLE_EVENT_MEDAL_CHANGE,t.onRoleMedalChange,t),t.role.removeEventListener(e.ROLE_EVENT_POS_CHANGE,t.onRolePosChange,t),t.role.removeEventListener(e.ROLE_EVENT_ATTACK,t.onRoleAttack,t),t.role.removeEventListener(e.ROLE_EVENT_ADD_BUFF,t.onRoleAddBuff,t),t.role.removeEventListener(e.ROLE_EVENT_REMOVE_BUFF,t.onRoleRemoveBuff,t),t.role.removeEventListener(e.ROLE_EVENT_BENUMB_CHANGED,t.onRoleBenumb,t),t.role=null)},o.onRoleComplete=function(t){var i=this;i.role.action==e.ROLE_ACTION_ATTACK&&i.role.stand()},o.onRoleAvatarChange=function(t){void 0===t&&(t=null);var i=this,n=i.role.action!=e.ROLE_ACTION_ATTACK;i.role.roleInfo.monsterInfo?i.roleAP.loadRes(i.role.getAvatar(i.role.clothesID,"m"),n):i.roleAP.loadRes(i.role.getAvatar(i.role.clothesID,"r"),n),null!=i.role.weaponID&&-1!=i.role.weaponID&&null==i.weaponAP&&(i.weaponAP=new g_base.ActionPlayer,i.apCon.addChild(i.weaponAP)),null!=i.weaponAP&&i.weaponAP.loadRes(i.role.getAvatar(i.role.weaponID,"i"),n),null!=i.role.wingID&&-1!=i.role.wingID&&null==i.wingAP&&(i.wingAP=new g_base.ActionPlayer,i.apCon.addChild(i.wingAP)),null!=i.wingAP&&(i.wingAP.loadRes(i.role.getAvatar(i.role.wingID,"w"),n),i.role.aspect==e.ROLE_ASPECT_UP||i.role.aspect==e.ROLE_ASPECT_UP_LEFT||i.role.aspect==e.ROLE_ASPECT_UP_RIGHT?i.apCon.setChildIndex(i.wingAP,i.apCon.numChildren-1):i.role.aspect==e.ROLE_ASPECT_LEFT||i.role.aspect==e.ROLE_ASPECT_RIGHT?i.apCon.setChildIndex(i.wingAP,i.apCon.numChildren-1):i.apCon.setChildIndex(i.wingAP,0)),i.scaleX=(i.role.aspect<6?1:-1)*i.scale,i.medalEffect&&(i.medalEffect.scaleX=i.scaleX<0?-1:1)},o.onRoleMedalChange=function(e){void 0===e&&(e=null);var t=this;t.role.medalId?(t.medalEffect||(t.medalEffect=g_comp.Ico_Medal.create(),t.medalCon.y=-116,t.addChild(t.medalCon),t.medalCon.source=t.medalEffect,t.medalEffect.scaleX=t.scaleX<0?-1:1,t.medalEffect.x=-75.5,t.medalEffect.y=-60),mo.R.loadTo("FightScene",resHelper.getWarPrintIconPath(t.role.medalId),function(){}),t.medalEffect.setData({itemId:t.role.medalId})):t.medalEffect&&(t.medalCon.source=null,t.medalEffect=null)},o.onRolePosChange=function(e){void 0===e&&(e=null);var t=this;t.x=t.role.x,t.y=t.role.y},o.onRoleAttack=function(e){void 0===e&&(e=null);var t=this;t.roleAP.playAction(),null!=t.weaponAP&&t.weaponAP.playAction(),null!=t.wingAP&&t.wingAP.playAction()},o.onRoleAddBuff=function(t){var i=this,n=t.data;if(0!=n.effectRes){for(var o=!1,r=0;r<i.numChildren;++r){var a=i.getChildAt(r);if(a instanceof e.BuffEffect&&a.buff.id==n.id){o=!0;break}}if(!o){var a=new e.BuffEffect;a.scaleX=a.scaleY=1.1,a.y=-10,a.buff=n,i.addChild(a),a.play(-1)}}i.onRoleBenumb()},o.onRoleRemoveBuff=function(t){for(var i=this,n=t.data,o=0;o<i.numChildren;++o){var r=i.getChildAt(o);if(r instanceof e.BuffEffect&&r.buff==n){i.parent&&i.removeChildAt(o);break}}i.onRoleBenumb()},o.onRoleBenumb=function(e){void 0===e&&(e=null);var t=this;t.role.isBenumb?t.roleAP.isPlaying&&t.stop():t.roleAP.isPlaying||t.playAction()},i}(e.MapEleView);e.RoleView=t,egret.registerClass(t,"g_fight.RoleView")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(t){function i(){t.call(this);this.uiEffect=new g_comp.UIEffect,this.uiEffect.autoPlay=!0;var e=new egret.gui.UIAsset;e.source=this.uiEffect,e.y=-80,this.addChild(e)}__extends(i,t);var n=(__define,i),o=n.prototype;return o.setGift=function(t){var i=this;i.gift=t,i.gift.addEventListener(e.GIFT_EVENT_POS_CHANGE,i.onGiftPosChange,i),i.onGiftPosChange(),this.uiEffect.effectId=mo.getJSONWithFileNameAndID(gc.cfg_t_talisman,i.gift.giftId)[gc.t_talisman_sEffect]},o.stop=function(){},o.playAction=function(){},o.onGiftPosChange=function(){this.x=this.gift.x,this.y=this.gift.y},o.dtor=function(){var t=this;t.gift&&t.gift.removeEventListener(e.GIFT_EVENT_POS_CHANGE,t.onGiftPosChange,t)},i}(e.MapEleView);e.GiftView=t,egret.registerClass(t,"g_fight.GiftView")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return t.createTileView=function(e,i,n){var o=t.getTileView(i,n);return o||(o=new t,o.setTile(e,i,n)),e!=o.mapID&&(o.texture=null,o.bitmapData=null,o.dtor(),o.setTile(e,i,n)),o},t.removeTileView=function(e){-1==t._tiles.indexOf(e)&&t._tiles.push(e)},t.getTileView=function(e,i){for(var n=0;n<t._tiles.length;++n){var o=t._tiles[n];if(o.row==e&&o.col==i)return o}return null},t.getPath=function(e,t,i){return"resource/dynamic2/map_"+e+"_"+i+"_"+t+".jpg"},n.setTile=function(e,i,n){this.mapID=e,this.row=i,this.col=n,RES.getResByUrl(t.getPath(this.mapID,this.row,this.col),function(t){e==this.mapID&&i==this.row&&n==this.col&&t&&(this.bitmapData=t.bitmapData)},this,RES.ResourceItem.TYPE_IMAGE)},n.dtor=function(){RES.destroyRes(t.getPath(this.mapID,this.row,this.col))},t.TILE_W=240,t.TILE_H=256,t._tiles=[],t}(egret.Bitmap);e.MapTileView=t,egret.registerClass(t,"g_fight.MapTileView")}(g_fight||(g_fight={}));var g_fight;!function(e){e.MAP_EVENT_HPMP_CHANGE="MAP_EVENT_HP_CHANGE",e.MAP_EVENT_WINCOUNT_CHANGE="MAP_EVENT_WINCOUNT_CHANGE",e.MAP_EVENT_IS_FINDING_MONSTER_CHANGE="MAP_EVENT_IS_FINDING_MONSTER_CHANGE",e.MAP_EVENT_TOTAL_HURT_CHANGE="MAP_EVENT_TOTAL_HURT_CHANGE",e.MINI_SPACE_TIME=100;var t=function(t){function i(){t.call(this),this.mapW=480,this.mapH=680,this.mapTW=960,this.mapTH=1280,this._allRoles=[],this._selfRoles=[],this._enemyRoles=[],this._isPicking=!1,this._pvpType=-1,this._pveType=-1,this.loots=[],this._isEnterMap=!0,this._totalHurt=0,this.needEnterEffect=!0,this.fightStartTime=0,this._labelCaches=[],this.lastExeAITime=0;var i=this;i.touchChildren=i.touchEnabled=!1,e.Role.maxCol=Math.floor(this.mapTW/e.Role.cellW),e.Role.maxRow=Math.floor(this.mapTH/e.Role.cellH),i._pvpTimeout=mo.getJSONWithFileNameAndID(gc.cfg_c_game,gc.id_c_game.battleSet)[0],i._thumbCon=new egret.Sprite,i._bgCon=new egret.Sprite,i._shadowCon=new egret.Sprite,i._itemCon=new egret.Sprite,i._roleCon=new egret.Sprite,i._effectCon=new egret.Sprite,i.addChild(i._thumbCon),i.addChild(i._bgCon),i.addChild(i._shadowCon),i.addChild(i._itemCon),i.addChild(i._roleCon),i.addChild(i._effectCon),i.addEventListener(egret.Event.ADDED_TO_STAGE,i.onAddedToStage,i),i.addEventListener(egret.Event.REMOVED_FROM_STAGE,i.onRemovedFromStage,i)}__extends(i,t);var n=__define,o=i,r=o.prototype;return n(r,"isNormalCopy",function(){return-1==this._pvpType&&-1==this._pveType}),r.getEnemyRoleAt=function(e){return this._enemyRoles[e]},n(r,"pveType",function(){return this._pveType}),n(r,"pvpType",function(){return this._pvpType}),n(r,"isFindingMonster",function(){return this._isFindingMonster},function(t){this._isFindingMonster=t,this.dispatchEvent(new egret.Event(e.MAP_EVENT_IS_FINDING_MONSTER_CHANGE))}),n(r,"totalHurt",function(){return this._totalHurt},function(t){this._totalHurt=t,this.dispatchEvent(new egret.Event(e.MAP_EVENT_TOTAL_HURT_CHANGE))}),n(r,"isEnterMap",function(){return this._isEnterMap}),r.onAddedToStage=function(t){for(var i=this,n=0;n<i._allRoles.length;++n){var o=i._allRoles[n],r=new e.RoleView;if(r.setRole(o),i._roleCon.addChild(r),o.gift){var a=new e.GiftView;a.setGift(o.gift),i._roleCon.addChild(a)}var s=new e.RoleNameView;s.setRole(o),i._effectCon.addChild(s);var l=new e.RoleShadowView;l.setRole(o),i._shadowCon.addChild(l)}},r.onRemovedFromStage=function(e){for(var t=this;t._roleCon.numChildren;){var i=t._roleCon.removeChildAt(0);null!=i.dtor&&i.dtor()}for(;t._effectCon.numChildren;){var i=t._effectCon.removeChildAt(0);null!=i.dtor&&i.dtor()}for(;t._shadowCon.numChildren;){var i=t._shadowCon.removeChildAt(0);null!=i.dtor&&i.dtor()}},n(r,"mainRole",function(){return this._selfRoles[0]}),n(r,"copyId",function(){return this._copyId},function(e){var t=this;t._copyId!=e&&(t.needEnterCopyEffect=!0),t._copyId=e}),r.enterMap=function(e,t){var i=this;if(i.fightStartTime=Date.newDate().getTime(),i._isEnterMap=!0,i.removeEventListener(egret.Event.ENTER_FRAME,i.onEnterFrame,i),i.mapID!=e){for(;i._thumbCon.numChildren;)i._thumbCon.removeChildAt(0);mo.R.unload("mapview","dynamic2/map_"+i.mapID+"_small.jpg"),mo.R.loadTo("mapview","dynamic2/map_"+e+"_small.jpg",function(){var t=new egret.Bitmap,n=RES.getRes("dynamic2/map_"+e+"_small.jpg");
if(n){for(t.bitmapData=n.bitmapData,t.width=i.mapTW,t.height=i.mapTH;i._thumbCon.numChildren;)i._thumbCon.removeChildAt(0);i._thumbCon.addChild(t)}},i)}i.mapID=e,i.needEnterEffect=t,i.clearFight(),clearInterval(i.enterTimerOut),clearInterval(i.exitTimerOut),i.enterTimerOut=setInterval(function(){i.removeEventListener(egret.Event.ENTER_FRAME,i.onEnterFrame,i),i.addEventListener(egret.Event.ENTER_FRAME,i.onEnterFrame,i),i.lastExeAITime=0,i.fightStartTime=Date.newDate().getTime(),clearInterval(i.enterTimerOut)},1e3)},r.exitMap=function(t,i){var n=this;n._isEnterMap=!1,n.removeAllRoleEvent(),n.clearFinding(),n.fightStartTime-=15e4,n.removeEventListener(egret.Event.ENTER_FRAME,n.onEnterFrame,n);for(var o=!1,r=0;r<n._roleCon.numChildren;++r){var a=n._roleCon.getChildAt(r);a.stop(),a.role&&egret.Tween.removeTweens(a.role),-1!=n._selfRoles.indexOf(a.role)&&(n.createFightEffect(26,a.x,a.y-10,e.ROLE_ASPECT_UP),o=!0)}for(var s,l,g,r=0;r<n._bgCon.numChildren;++r){var c=n._bgCon.getChildAt(r);s=c.mapID,s!=t&&(l=c.row,g=c.col,c.mapID=-1,c.row=-99999,c.col=-99999,RES.destroyRes(e.MapTileView.getPath(s,l,g)))}clearInterval(n.enterTimerOut),clearInterval(n.exitTimerOut);var _=0;_=o?1e3:200,n.exitTimerOut=setInterval(function(){i.call(n),clearInterval(n.exitTimerOut)},_)},r.playEnterEffect=function(){var t=this;if(t.needEnterEffect)for(var i=0;i<t._roleCon.numChildren;++i){var n=t._roleCon.getChildAt(i);n.stop(),-1!=t._selfRoles.indexOf(n.role)&&t.createFightEffect(26,n.x,n.y-10,e.ROLE_ASPECT_UP)}},r.removeAllRoleEvent=function(){for(var t=this,i=0;i<t._allRoles.length;++i){var n=t._allRoles[i];n.removeEventListener(e.ROLE_EVENT_ATTACK,t.onRoleAttack,t),n.removeEventListener(e.ROLE_EVENT_HURT,t.onRoleHurt,t),n.removeEventListener(e.ROLE_EVENT_HURT,t.onRoleHurtNoView,t),n.removeEventListener(e.ROLE_EVENT_REVIVE,t.onRoleRevive,t),n.removeEventListener(e.ROLE_EVENT_DIE,t.onRoleDie,t),n.removeEventListener(e.ROLE_EVENT_CALL_PET,t.onRoleCallPet,t),n.removeEventListener(e.ROLE_EVENT_GIFT_EQUIP_CHANGE,t.onRoleGiftEquipChange,t)}},r.clearFight=function(){var t=this;for(null!=t.mainRole&&t.mainRole.removeEventListener(e.ROLE_EVENT_POS_CHANGE,t.onMainRolePosChange,t),t.removeAllRoleEvent();t._allRoles.length;){var i=t._allRoles.pop();i.dtor()}for(t._selfRoles.length=0,t._enemyRoles.length=0,t._isPicking=!1;t._bgCon.numChildren;)t._bgCon.removeChildAt(0);for(;t._itemCon.numChildren;)t._itemCon.removeChildAt(0);for(;t._roleCon.numChildren;){var n=t._roleCon.removeChildAt(0);null!=n.dtor&&n.dtor()}for(;t._effectCon.numChildren;){var n=t._effectCon.removeChildAt(0);null!=n.dtor&&n.dtor()}for(;t._shadowCon.numChildren;){var n=t._shadowCon.removeChildAt(0);null!=n.dtor&&n.dtor()}},r.changeMainRole=function(){var t=this;if(null!=t.mainRole){t.mainRole.addEventListener(e.ROLE_EVENT_POS_CHANGE,t.onMainRolePosChange,t);for(var i=0;i<t._selfRoles.length;++i)t._selfRoles[i].mainRole=t.mainRole}},r.forceNormalCopy=function(){var e=this;gd.fightCtrl.isSpFighting=!1,e.clearFight(),e._pvpType=-1,e._pveType=-1,e.loots=[];var t=mo.getJSONWithFileNameAndID(gc.cfg_t_copy,gd.copyCtrl.getNormalCurCopyId()),i=t[gc.t_copy_displayID];e.exitMap(i,function(){e.enterMap(i,!0),e.checkNextWave()})},r.startPvpFight=function(t,i,n,o){void 0===o&&(o=null);var r=this;r.needEnterCopyEffect=!0,r._pveType=-1,r._pvpType=n,r._goingNext=!1,r._roleAllDie=!1;var a;r._pvpType==gc.c_prop.fightTypeKey.pk?a=mo.getJSONWithFileNameAndID(gc.cfg_t_copy,r._copyId):r._pvpType==gc.c_prop.fightTypeKey.guildWar?(r.copyId=4003,a=mo.getJSONWithFileNameAndID(gc.cfg_t_copy,r.copyId)):(r.copyId=4002,a=mo.getJSONWithFileNameAndID(gc.cfg_t_copy,r.copyId));var s=a[gc.t_copy_displayID];r.exitMap(s,function(){r.enterMap(s,!0);for(var n,a=0;a<t.length;++a)n=r.createRole(t[a],!0,a),n.roleInfo.isPvPFight=!0;for(var a=0;a<i.length;++a)n=r.createRole(i[a],!1,a,o),n.roleInfo.isPvPFight=!0;for(var a=0;a<r._allRoles.length;++a)r._allRoles[a].revive();gd.fightCtrl.isDie=!1,r.needEnterCopyEffect&&(r.needEnterCopyEffect=!1,e.EnterCopyEffect.create().setData({copyId:r.copyId,monsterId:-1}).show()),e.baseTopBar&&e.baseTopBar.showCopyName(r.copyId,-1),r.playEnterEffect(),r.changeMainRole(),r.onMainRolePosChange()})},r.enterCopy=function(e,t,i,n){void 0===n&&(n=0);var o=this;if(o._pvpType=-1,o._pveType=e,o.loots=i||[null],o._goingNext=!1,o.needEnterCopyEffect=!0,o._roleAllDie=!1,o.totalHurt=0,o._pveType==gc.c_prop.fightTypeKey.worldBoss){var r;gd.bossCtrl.isGuildBoss(n)?(r=mo.getJSONWithFileNameAndID(gc.cfg_c_bossParameter,n),t=r[gc.c_bossParameter_copyId]):(r=mo.getJSONWithFileNameAndID(gc.cfg_c_bossWorld,n),t=r[gc.c_bossWorld_copyId])}o.copyId=t;var a=mo.getJSONWithFileNameAndID(gc.cfg_t_copy,t),s=a[gc.t_copy_bossSpace];o.exitMap(s,function(){var e=o._pveType==gc.c_prop.fightTypeKey.worldBoss;o.enterMap(s,!0);for(var t=gd.heroCtrl.getFightList(),i=0;i<t.length;++i){o.createRole(t[i],!0,i,null)}gd.fightCtrl.isDie=!1,o.playEnterEffect(),o.createMonsterByLoots(n||a[gc.t_copy_bossID],o.loots,e),o.changeMainRole(),o.onMainRolePosChange(),o._pveType==gc.c_prop.fightTypeKey.worldBoss&&o.worldBossHpChange()})},r.worldBossHpChange=function(){var e=this;if(e._pveType==gc.c_prop.fightTypeKey.worldBoss){var t=e._enemyRoles[0];t&&(t.hp=gd.curBFECtrl.getCurHp(),t.hp<=0&&t.die())}},r.roleListChange=function(){for(var t=this,i=gd.heroCtrl.getFightList(),n=[],o=[],r=0;r<t._selfRoles.length;++r){var a=t._selfRoles[r];a.medalId=0,a.removeEventListener(e.ROLE_EVENT_POS_CHANGE,t.onMainRolePosChange,t);for(var s=0;s<i.length;++s){var l=i[s];if(a.entity&&a.entity.job==l.job){n[s]=a;break}}s==i.length&&o.push(a)}t._selfRoles=n.concat(o),t.changeMainRole()},r.createRole=function(t,i,n,o){void 0===o&&(o=null);for(var r=this,a=0,s=0;s<r._selfRoles.length;++s)if(r._selfRoles[s]instanceof e.Pet){a++;break}if(!i||r._selfRoles.length-a!=gd.heroCtrl.getList().length){var l=new e.Role;l.name=o,l.isSelf=i,l.isMain=0==n,i?(l.x=r.mapTW/2,l.y=r.mapTH/2,null!=r.mainRole&&(l.x=r.mainRole.x-120+120*Math.random(),l.y=r.mainRole.y-120+120*Math.random()),0==n&&(l.isKing=gd.userCtrl.getIsKing(),l.medalId=gd.medalCtrl.getMedalTitle())):(l.x=r.mapTW/2-250+100*Math.random(),l.y=r.mapTH/2-250+100*Math.random(),0==n&&(l.isKing=t.fightData[3],l.medalId=t.fightData[6])),l.setEntity(t);var g=t.getClothDisplayID(),c=t.getWeaponDisplayID(),_=t.getWingDisplayID();return l.clothesID=g,l.weaponID=c,l.wingID=_,l.action=e.ROLE_ACTION_STAND,l.aspect=e.ROLE_ASPECT_DOWN,l.allRoles=r._allRoles,l.revive(),i?(l.selfs=r._selfRoles,l.enemys=r._enemyRoles,r._selfRoles.push(l)):(l.selfs=r._enemyRoles,l.enemys=r._selfRoles,r._enemyRoles.push(l)),l.addEventListener(e.ROLE_EVENT_ATTACK,r.onRoleAttack,r),l.addEventListener(e.ROLE_EVENT_HURT,r.onRoleHurt,r),l.addEventListener(e.ROLE_EVENT_HURT,r.onRoleHurtNoView,r),l.addEventListener(e.ROLE_EVENT_REVIVE,r.onRoleRevive,r),l.addEventListener(e.ROLE_EVENT_DIE,r.onRoleDie,r),l.addEventListener(e.ROLE_EVENT_CALL_PET,r.onRoleCallPet,r),l.addEventListener(e.ROLE_EVENT_GIFT_EQUIP_CHANGE,r.onRoleGiftEquipChange,r),i&&l.addEventListener(e.ROLE_EVENT_HP_CHANGE,r.onMyRoleHpChange,r),r.addRoleToMap(l),l}},r.createMonster=function(t,i,n,o,r){var a=this,s=new e.Role;return s.setMoster(t),s.action=e.ROLE_ACTION_STAND,s.aspect=e.ROLE_ASPECT_DOWN,s.allRoles=a._allRoles,s.loot=i,r?Math.random()<.5?(s.x=Math.random()<.5?n-200+75*Math.random():n+200-75*Math.random(),s.y=o-175+350*Math.random()):(s.x=n-175+350*Math.random(),s.y=Math.random()<.5?o-200+75*Math.random():o+200-75*Math.random()):(s.x=n-175+350*Math.random(),s.y=o-175+350*Math.random()),s.selfs=a._enemyRoles,s.enemys=a._selfRoles,a._enemyRoles.push(s),s.revive(),s.addEventListener(e.ROLE_EVENT_ATTACK,a.onRoleAttack,a),s.addEventListener(e.ROLE_EVENT_HURT,a.onRoleHurt,a),s.addEventListener(e.ROLE_EVENT_HURT,a.onRoleHurtNoView,a),s.addEventListener(e.ROLE_EVENT_DIE,a.onRoleDie,a),a.addRoleToMap(s),s},r.callPet=function(t,i){var n=this;i.curPetNum++;var o=new e.Pet;o.setMoster(t),o.owner=i,o.isSelf=i.isSelf,o.action=e.ROLE_ACTION_STAND,o.aspect=e.ROLE_ASPECT_DOWN,o.allRoles=n._allRoles,o.x=i.x+90*Math.random(),o.y=i.y+50*Math.random(),o.isSelf?(o.selfs=n._selfRoles,o.enemys=n._enemyRoles,o.mainRole=n.mainRole,n._selfRoles.push(o)):(o.selfs=n._enemyRoles,o.enemys=n._selfRoles,n._enemyRoles.push(o)),o.revive(),o.addEventListener(e.ROLE_EVENT_ATTACK,n.onRoleAttack,n),o.addEventListener(e.ROLE_EVENT_HURT,n.onRoleHurt,n),o.addEventListener(e.ROLE_EVENT_HURT,n.onRoleHurtNoView,n),o.addEventListener(e.ROLE_EVENT_DIE,n.onRoleDie,n),n.addRoleToMap(o)},r.onRoleDie=function(t){var i=this,n=t.currentTarget,o=i._allRoles.indexOf(n),r=i.getRoleView(n),a=i.getGiftView(n),s=i.getRoleNameView(n),l=i.getRoleShadowView(n),g=n.loot;r&&r.parent&&(r.parent.removeChild(r),r.dtor()),s&&s.parent&&(s.parent.removeChild(s),s.dtor()),l&&l.parent&&(l.parent.removeChild(l),l.dtor()),a&&a.parent&&(a.parent.removeChild(a),a.dtor()),n.removeEventListener(e.ROLE_EVENT_ATTACK,i.onRoleAttack,i),n.removeEventListener(e.ROLE_EVENT_HURT,i.onRoleHurt,i),n.removeEventListener(e.ROLE_EVENT_HURT,i.onRoleHurtNoView,i),n.removeEventListener(e.ROLE_EVENT_REVIVE,i.onRoleRevive,i),n.removeEventListener(e.ROLE_EVENT_DIE,i.onRoleDie,i),n.removeEventListener(e.ROLE_EVENT_CALL_PET,i.onRoleCallPet,i),n.removeEventListener(e.ROLE_EVENT_GIFT_EQUIP_CHANGE,i.onRoleGiftEquipChange,i),n.dtor();var c=i.mainRole;if(i._allRoles.splice(o,1),o=i._enemyRoles.indexOf(n),-1!=o&&i._enemyRoles.splice(o,1),o=i._selfRoles.indexOf(n),-1!=o&&i._selfRoles.splice(o,1),n==c&&(n.removeEventListener(e.ROLE_EVENT_POS_CHANGE,i.onMainRolePosChange,i),i.changeMainRole()),null!=g){var _=g[1].length;if(_>0)for(var h=Math.ceil(_/4),f=_>=4?4:_,u=0;_>u;++u){var m=g[1][u],d=new e.LootView;d.itemID=m[0],d.itemNum=m[1],d.row=n.row+Math.floor(u/f)-Math.floor(h/2),d.col=n.col+Math.floor(u%f)-Math.floor(f/2),d.row<0?d.row=0:d.row>e.Role.maxRow-1&&(d.row=e.Role.maxRow-1),d.col<0?d.col=0:d.col>e.Role.maxCol-1&&(d.col=e.Role.maxCol-1),d.x=(d.col+.5)*e.Role.cellW,d.y=(d.row+.5)*e.Role.cellH,d.updateView(),i._itemCon.addChild(d),d.textField.y=d.y-25,i._effectCon.addChild(d.textField)}}gd.fightCtrl.isSpFighting&&(i._roleAllDie=i.isFightOver()),i.checkNextWave(!0)},r.onRoleCallPet=function(t){var i=this,n=t.data.petID,o=t.data.num,r=t.data.owner,a=t.data.isKillAll;if(a)for(var s=0;s<i._allRoles.length;++s){var l=i._allRoles[s];l instanceof e.Pet&&l.owner==r&&(l.hp=0)}for(var s=0;s<o-r.curPetNum;++s)i.callPet(n,r)},r.onRoleGiftEquipChange=function(e){this.checkRoleGift(e.currentTarget)},r.checkRoleGift=function(t){var i=this,n=i.getGiftView(t);if(t.gift)n||(n=new e.GiftView,i._roleCon.addChild(n)),n.setGift(t.gift);else{var n=i.getGiftView(t);n&&n.parent&&(n.parent.removeChild(n),n.dtor())}},r.clearFinding=function(){var e=this;e.isFindingMonster=!1,e.mainRole&&(e.mainRole.isFindingMonster=!1),clearInterval(e._findTimeId)},r.checkNextWave=function(t){void 0===t&&(t=!1);var i=this;if(i._isEnterMap){var n=!1;if(gd.fightCtrl.isSpFighting){if(i._roleAllDie){n=0==i._enemyRoles.length,gd.fightCtrl.isDie=!n;var o=mo.getJSONWithFileNameAndID(gc.cfg_t_copy,gd.copyCtrl.getNormalCurCopyId()),r=o[gc.t_copy_displayID];if(i._itemCon.numChildren>0){i._isPicking=!0;var a=i._itemCon.getChildAt(i._itemCon.numChildren-1);i.mainRole.moveTo(a.row,a.col)}else{i._roleAllDie=!1,i.removeEventListener(egret.Event.ENTER_FRAME,i.onEnterFrame,i);var s=gd.heroCtrl.getFightList();if(i._pvpType==gc.c_prop.fightTypeKey.pk||i._pvpType==gc.c_prop.fightTypeKey.rankPk)gd.pkOutCtrl.end(n,{},function(t){e.FightPKWinOrFail.showCallback({isWin:n,fightResult:t,callback:function(){gd.fightCtrl.isSpFighting=!1,i.loots=[],i.exitMap(r,function(){i.enterMap(r,!0),i.checkNextWave(),i._pvpType==gc.c_prop.fightTypeKey.rankPk&&gd.pkOutCtrl.getRankList(function(t){e.PVPRank.create().setData({rankData:t}).show()},i),i._pvpType=-1})},target:i,begTime:Date.newDate().getTime()+1e4})},i);else if(i._pvpType==gc.c_prop.fightTypeKey.challengeCupPk)gd.challengeCupCtrl.endFight(n,function(t){e.FightArenaWinOrFail.showCallback({isWin:n,fightResult:t,fightType:i._pvpType,callback:function(){gd.fightCtrl.isSpFighting=!1,i.loots=[],i.exitMap(r,function(){i.enterMap(r,!0),i.checkNextWave(),i._pvpType==gc.c_prop.fightTypeKey.rankPk&&gd.pkOutCtrl.getRankList(function(t){e.PVPRank.create().setData({rankData:t}).show()},i),i._pvpType=-1})},target:i,begTime:Date.newDate().getTime()+1e4})},i);else if(i._pvpType==gc.c_prop.fightTypeKey.coffers)gd.coffersCtrl.fightEnd(n,function(t){e.FightCoffersWinOrFail.showCallback({isWin:n,fightResult:t,callback:function(){gd.fightCtrl.isSpFighting=!1,i.loots=[],i.exitMap(r,function(){i.enterMap(r,!0),i.checkNextWave(),i._pvpType=-1})},target:i,begTime:Date.newDate().getTime()+1e4})},i);else if(i._pvpType==gc.c_prop.fightTypeKey.guildWar)gd.guildWarCtrl.fightEndDoor(n,function(t){e.FightGuildWarWinOrFail.showCallback({isWin:n,fightResult:t,callback:function(){gd.fightCtrl.isSpFighting=!1,i.loots=[],i.exitMap(r,function(){i.enterMap(r,!0),i.checkNextWave(),i._pvpType=-1})},target:i,begTime:Date.newDate().getTime()+1e4})},i);else if(i._pveType==gc.c_prop.fightTypeKey.coffersBoss)gd.coffersCtrl.fightCoffersEnd(i.totalHurt,function(t){e.FightCoffersBoss.showCallback({isWin:!0,fightResult:t,callback:function(){gd.fightCtrl.isSpFighting=!1,i.loots=[],i.exitMap(r,function(){i.enterMap(r,!0),i.checkNextWave(),i._pveType=-1})},target:i,begTime:Date.newDate().getTime()+1e4})},i);else if(i._pveType==gc.c_prop.fightTypeKey.guildCopy)gd.guildCtrl.getInfo(function(){gd.guildCopyCtrl.guildEnd(n,function(t){e.GuildCopyBossWinOrFail.showCallback({result:t,callback:function(){gd.fightCtrl.isSpFighting=!1,i.loots=[],i.exitMap(r,function(){i.enterMap(r,!0),i.checkNextWave(),i._pveType=-1})},target:i,begTime:Date.newDate().getTime()+1e4})},i)},i);else if(i._pveType==gc.c_prop.fightTypeKey.copy){var l={},g=(gd.copyCtrl.getCopyStar(i.copyId),0),c=!1,_=!1;n&&(g++,i._selfRoles.length>=gd.heroCtrl.getFightList().length&&(c=!0,g++),Date.newDate().getTime()-i.fightStartTime<32e3&&(_=!0,g++)),l[gc.dsConsts.FightData.isWin]=n,l[gc.dsConsts.FightData.star]=g,l[gc.dsConsts.FightData.vData]={},gd.copyCtrl.end(n,l,function(t){i._pveType=-1;var o,a=mo.getJSONWithFileNameAndID(gc.cfg_t_copy,i.copyId),s=a[gc.t_copy_type],l=-1;if(s==gc.c_prop.copyTypeKey.equip?l=g_consts.HS_SUBMID_EQUIP_COPY:s==gc.c_prop.copyTypeKey.hell?l=g_consts.HS_SUBMID_BOSS_COPY:s==gc.c_prop.copyTypeKey.state?l=g_consts.HS_SUBMID_STATE_COPY:s==gc.c_prop.copyTypeKey.vip?(l=g_consts.HS_SUBMID_VIP_COPY,o=gd.copyCtrl.getCopyVip(i.copyId)):s==gc.c_prop.copyTypeKey.normal?n||gd.userCtrl.setAutoFight(0):s==gc.c_prop.copyTypeKey.paTa&&(l=g_consts.HS_SUBMID_TOWER),-1!=l){for(var g=[],h=0;h<i.loots.length;++h)for(var f=0;f<i.loots[h][1].length;++f)g.push({itemId:i.loots[h][1][f][0],count:i.loots[h][1][f][1]});e.FightCopyWinOrFail.showCallback({isWin:n,noDie:c,timeLmt:_,fightResult:t,items:g,callback:function(){gd.fightCtrl.isSpFighting=!1,i.loots=[],i.exitMap(r,function(){if(mo.moduleMgr.curModule.name==g_consts.moduleId.fight){var e={subModuleId:l};o&&(e.vip=o),mo.moduleMgr.runModule(g_consts.moduleId.home,e)}i.enterMap(r,!0),i.checkNextWave()})},target:i,begTime:Date.newDate().getTime()+1e4})}else n?(gd.fightCtrl.isSpFighting=!1,i.loots=[],i.exitMap(r,function(){i.enterMap(r,!0),i.checkNextWave()})):e.FightRevive.showCallback({callback:function(){gd.fightCtrl.isSpFighting=!1,i.loots=[],i.exitMap(r,function(){i.needEnterEffect=!0,i.enterMap(r,!0),i.checkNextWave()})},target:i,begTime:Date.newDate().getTime()+5e3})},i)}else if(i._pvpType==gc.c_prop.fightTypeKey.arena){var l={};l[gc.dsConsts.FightData.isWin]=n,l[gc.dsConsts.FightData.star]=0,l[gc.dsConsts.FightData.vData]={},gd.arenaCtrl.fightEnd(n,l,function(t){e.FightArenaWinOrFail.showCallback({isWin:n,fightResult:t,fightType:i._pvpType,callback:function(){gd.fightCtrl.isSpFighting=!1,i.loots=[],i.exitMap(i.mapID,function(){i.enterMap(i.mapID,!1),i.checkNextWave(),mo.moduleMgr.curModule.name==g_consts.moduleId.fight&&mo.moduleMgr.runModule(g_consts.moduleId.home,{subModuleId:g_consts.HS_SUBMID_ARENA}),i._pvpType=-1})},target:i,begTime:Date.newDate().getTime()+1e4})},i)}else i._pveType==gc.c_prop.fightTypeKey.worldBoss&&(n?(gd.fightCtrl.isSpFighting=!1,i._pveType=-1,i.loots=[],i.exitMap(r,function(){i.needEnterEffect=!0,i.enterMap(r,!0),i.checkNextWave()})):gd.curBFECtrl.exitFight(function(){e.FightRevive.showCallback({callback:function(){i._pveType=-1,gd.fightCtrl.isSpFighting=!1,i.loots=[],i.exitMap(r,function(){i.needEnterEffect=!0,i.enterMap(r,!0),i.checkNextWave()}),mo.moduleMgr.curModule.name!=g_consts.moduleId.fight||gd.bossFightCtrl.isAutoFight()||mo.moduleMgr.runModule(g_consts.moduleId.worldBoss,{bossId:i.monsterId})},target:i,begTime:Date.newDate().getTime()+5e3})},i))}}}else{if(i._goingNext)return;if(i.isFightOver()){n=0==i._enemyRoles.length,gd.fightCtrl.isDie=!n,i.copyId=gd.copyCtrl.getNormalCurCopyId();var o=mo.getJSONWithFileNameAndID(gc.cfg_t_copy,i.copyId),r=o[gc.t_copy_displayID];if(!n)return void e.FightRevive.showCallback({callback:function(){i.enterMap(r,!0),i.checkNextWave()},target:i,begTime:Date.newDate().getTime()+5e3});if(i.isNormalCopy&&i._itemCon.numChildren>0){i._isPicking=!0;var a=i._itemCon.getChildAt(i._itemCon.numChildren-1);i.mainRole.moveTo(a.row,a.col)}else{i._isPicking=!1;for(var s=gd.heroCtrl.getFightList(),h=0;h<s.length;++h){for(var f=!1,u=0;u<i._selfRoles.length;++u)if(i._selfRoles[u].uid==s[h].get(gc.dsConsts.HeroEntity.id)){f=!0,i._selfRoles[u].roleInfo.setHeroProp(s[h].props);break}f||i.createRole(s[h],!0,h)}gd.fightCtrl.isDie=!1,i.playEnterEffect(),i.changeMainRole(),i.onMainRolePosChange();for(var h=0;h<i._selfRoles.length;++h)i._selfRoles[h].revive();if(n&&t&&gd.copyCtrl.updateWinningStreak(function(){},i),i.loots.length>0){for(var m=[],h=0;h<i.loots.length;++h)m.push(i.loots[h][0]);gd.fightCtrl.pickLoot(m,{},function(){},i),i.loots=[]}var d=mo.getJSONWithFileNameAndID(gc.cfg_c_game,gc.id_c_game.battleSet),p=1e3*d[1]-(Date.newDate().getTime()-i.fightStartTime);p>0&&!i._isFindingMonster?(i.clearFinding(),i.isFindingMonster=!0,i.mainRole&&(i.mainRole.isFindingMonster=!0),i._findTimeId=setInterval(function(){i.checkNextWave(),i.clearFinding()},p)):i.getNextLoot()}}}}},r.isFightOver=function(){var e=this;return 0==e._enemyRoles.length||0==e._selfRoles.length?!0:!1},r.skipFight=function(){var t,i=this;if(!i.isFightOver()){i.removeAllRoleEvent();for(var n=0;n<i._allRoles.length;++n){var t=i._allRoles[n];t.addEventListener(e.ROLE_EVENT_DIE,i.onRoleDie,i),t.addEventListener(e.ROLE_EVENT_CALL_PET,i.onRoleCallPet,i),t.addEventListener(e.ROLE_EVENT_HURT,i.onRoleHurtNoView,i),t.stand(),egret.Tween.removeTweens(t)}for(;!i.isFightOver();)for(var n=0;n<i._allRoles.length;++n)t=i._allRoles[n],t.exeAI(!1);for(var n=0;n<i._itemCon.numChildren;++n){var o=i._itemCon.getChildAt(n);o.pickUp(),n--}i.checkNextWave(i.isNormalCopy?!0:!1)}},r.getNextLoot=function(){var e=this;e._goingNext=!0,clearInterval(e.delayRequestId),e.delayRequestId=setInterval(function(){e.getNextLoot()},5e3),gd.fightCtrl.getNextLoot(gd.copyCtrl.getNormalCurCopyId(),!1,function(t){if(clearInterval(e.delayRequestId),!gd.fightCtrl.isSpFighting&&0==e._enemyRoles.length){e.needEnterEffect=!1,e.copyId=gd.copyCtrl.getNormalCurCopyId();var i=mo.getJSONWithFileNameAndID(gc.cfg_t_copy,e.copyId);e.createMonsterByLoots(i[gc.t_copy_randMonsters][0],t),e._goingNext=!1,e.fightStartTime=Date.newDate().getTime()}},e)},r.createMonsterByLoots=function(t,i,n){void 0===n&&(n=!1);var o=this;o.monsterId=t,o.loots=i,o.needEnterCopyEffect&&(o.needEnterCopyEffect=!1,e.EnterCopyEffect.create().setData({copyId:o.copyId,monsterId:t}).show()),e.baseTopBar&&o.copyId&&e.baseTopBar.showCopyName(o.copyId,o.monsterId);var r=0,a=0;o.mainRole&&(r=o.mainRole.x>o.mapTW/2?o.mainRole.x-400+50*Math.random():o.mainRole.x+300+50*Math.random(),a=o.mainRole.y>o.mapTH/2?o.mainRole.y-300+50*Math.random():o.mainRole.y+200+50*Math.random());var s=mo.getJSONWithFileNameAndID(gc.cfg_t_monster,t),l=0!=s[gc.t_monster_bossLevel];l&&(r=o.mapTW/2,a=o.mapTH/2);for(var g=0;g<i.length;++g){var c=o.createMonster(t,i[g],r,a,l);c.roleInfo.isWorldBossFight=n}},r.onRoleAttack=function(t){var i=this;if(i.stage){var n=t.data,o=n.attackRole,r=n.hurtRole,a=n.skill,s=i.getRoleView(o),l=i.getRoleView(r);if(0!=a.skillInfo.casterEffect){var g=e.ROLE_ASPECT_UP;1==a.skillInfo.attackDistance&&(g=o.aspect),null==o.roleInfo.monsterInfo&&i.createFightEffect(a.skillInfo.casterEffect,s.x,s.y-10,g)}if(0!=a.skillInfo.flyEffect&&null!=i.stage){var c=e.FightEffect.getFightEffect(a.skillInfo.flyEffect,e.ROLE_ASPECT_UP);c.startLoadByKey(a.skillInfo.flyEffect,e.ROLE_ASPECT_UP);var _=s.x,h=s.y-30,f=l.x,u=l.y-30;c.x=_,c.y=h;var m=f-_,d=u-h,p=m/Math.sqrt(m*m+d*d),v=Math.acos(p);d>0?c.rotation=v/Math.PI*180:c.rotation=-v/Math.PI*180,i._effectCon.addChild(c),c.play(-1),egret.Tween.get(c).to({x:f,y:u},3*Math.sqrt(m*m+d*d)).call(function(){this.parent&&this.parent.removeChild(this)},c)}}},r.createFightEffect=function(t,i,n,o){var r=this;if(r.stage){var a=e.FightEffect.getFightEffect(t,o);a.startLoadByKey(t,o),a.scaleX=a.scaleY=1.1,a.x=i,a.y=n,r._effectCon.addChild(a),a.addEventListener(egret.Event.COMPLETE,function(){this.parent&&this.parent.removeChild(this)},a),a.play(1),a.scaleX=6>o?1:-1}},r.getLabel=function(){var e=this;if(e._labelCaches.length>0)return e._labelCaches.pop();var t=new egret.TextField;return t.stroke=1,t.strokeColor=0,t},r.removeLabel=function(e){this._labelCaches.push(e)},r.onRoleRevive=function(e){var t=this;if(t.stage){var i=e.currentTarget,n=t.getLabel(),o=t.getRoleView(i);n.size=27,n.textColor=16773120,t._effectCon.addChild(n),n.text="复活",n.textColor=16761088,n.x=o.x-n.width/2,n.y=o.y-60,egret.Tween.get(n).to({y:n.y-60},500).call(function(){n.parent&&n.parent.removeChild(n)})}},r.onRoleHurtNoView=function(e){var t=this,i=e.data,n=i.hurtRole,o=i.attackRole;if(t._pveType!=gc.c_prop.fightTypeKey.coffersBoss||n.isSelf||(t.totalHurt+=-i.hp),0!=i.hp&&i.hp<0&&t._pveType==gc.c_prop.fightTypeKey.worldBoss&&!n.isSelf){gd.curBFECtrl.isLimitHp()&&!n.hasBuff(12)&&n.addBuff(12,1);var r=i.hp*(1+gd.curBFECtrl.getInspireHurt()/1e4);r=Math.ceil(r);var a=-1;o.entity&&(a=o.entity.get(gc.dsConsts.HeroEntity.id)),gd.curBFECtrl.hurt(-r,a)}},r.onRoleHurt=function(t){var i=this,n=t.data,o=n.hurtRole;if(i.stage){var r=n.attackRole,a=n.skill,s=i.getRoleView(o);if(0!=n.hp){var l=i.getLabel();l.size=18,l.textColor=16773120,i._effectCon.addChild(l),l.text=n.hp.toString(),l.x=s.x-l.width/2,l.y=s.y-50;var g,c,_,h,f=1,u=1;if(n.hp<0){if(r.col==o.col?g=_=l.x:r.col>o.col?(g=l.x-80,_=g-70):r.col<o.col&&(g=l.x+80,_=g+70),r.row==o.row?c=h=l.y:r.row>o.row?(c=l.y-80,h=c-70):r.row<o.row&&(c=l.y+80,h=c+70),i._pveType==gc.c_prop.fightTypeKey.worldBoss&&!o.isSelf){var m=n.hp*(1+gd.curBFECtrl.getInspireHurt()/1e4);m=Math.ceil(m),l.text=m.toString()}}else l.textColor=65280,l.text="+"+l.text,g=l.x,c=l.y-100;n.crit?(f=1.2,u=1.2,l.textColor=16711680,l.text="暴 "+l.text):(f=1,u=1);var d=egret.Tween.get(l).to({x:g,y:c,scaleX:f,scaleY:u},600);(g!=_||c!=h)&&(d=d.to({x:_,y:h},200)),d.call(function(){l.parent&&(l.parent.removeChild(l),i.removeLabel(l))},i)}if(n.invincible){var p=i.getLabel();i._effectCon.addChild(p),p.size=27,p.text="无敌",p.textColor=12648448,p.x=s.x-p.width/2,p.y=s.y-60,egret.Tween.get(p).to({y:p.y-60},500).call(function(){p.parent&&p.parent.removeChild(p)})}else if(n.miss){var v=i.getLabel();i._effectCon.addChild(v),v.size=18,v.text="闪避",v.textColor=65280,v.x=s.x-v.width/2,v.y=s.y-60,egret.Tween.get(v).to({y:v.y-60},500).call(function(){v.parent&&v.parent.removeChild(v)})}else if(n.isHp2){var C=i.getLabel();i._effectCon.addChild(C),C.text="护身",C.size=27,C.textColor=28865,C.x=s.x-C.width/2,C.y=s.y-60,egret.Tween.get(C).to({y:C.y-60},500).call(function(){C.parent&&C.parent.removeChild(C)}),0!=n.hp}else if(0!=a.skillInfo.targetEffect&&n.isFirstAim&&i.createFightEffect(a.skillInfo.targetEffect,s.x,s.y-10,e.ROLE_ASPECT_UP),n.mb){var E=i.getLabel();E.text="麻痹",E.textColor=14969863,E.x=s.x-E.width/2,E.y=s.y-60,E.size=27,i._effectCon.addChild(E),egret.Tween.get(E).to({y:E.y-60},500).call(function(){E.parent&&E.parent.removeChild(E)})}else if(n.disMb){var T=i.getLabel();T.text="抗麻痹",T.textColor=7352481,T.x=s.x-T.width/2,T.y=s.y-60,T.size=27,i._effectCon.addChild(T),egret.Tween.get(T).to({y:T.y-60},500).call(function(){T.parent&&T.parent.removeChild(T)})}}},r.moveToLT=function(t,i){var n=this;0>t?t=0:t>n.mapTW-n.mapW&&(t=n.mapTW-n.mapW),0>i?i=0:i>n.mapTH-n.mapH&&(i=n.mapTH-n.mapH),n._thumbCon.x=n._bgCon.x=n._shadowCon.x=n._itemCon.x=n._roleCon.x=n._effectCon.x=-t,n._thumbCon.y=n._bgCon.y=n._shadowCon.y=n._itemCon.y=n._roleCon.y=n._effectCon.y=-i,n.checkRemoveTileView();for(var o=Math.floor(t/e.MapTileView.TILE_W),r=Math.floor((t+n.mapW)/e.MapTileView.TILE_W),a=Math.floor(i/e.MapTileView.TILE_H),s=Math.floor((i+n.mapH)/e.MapTileView.TILE_H),l=o;r>=l;++l)for(var g=a;s>=g;++g)n.addTileView(g,l)},r.moveToCenter=function(e,t){var i=this;i.moveToLT(e-i.mapW/2,t-i.mapH/2-80)},r.addTileView=function(t,i,n){void 0===n&&(n=-1);var o=this;if(!(0>t||t>Math.ceil(o.mapTH/e.MapTileView.TILE_H)-1||0>i||i>Math.ceil(o.mapTW/e.MapTileView.TILE_W)-1)){var r=o.getTileView(t,i);r&&r.mapID==o.mapID||(r=e.MapTileView.createTileView(o.mapID,t,i),r.x=e.MapTileView.TILE_W*i,r.y=e.MapTileView.TILE_H*t,o._bgCon.addChild(r))}},r.getTileView=function(e,t){for(var i,n=this,o=0;o<n._bgCon.numChildren;++o)if(i=n._bgCon.getChildAt(o),i.row==e&&i.col==t)return i;return null},r.checkRemoveTileView=function(){for(var t,i=this,n=0;n<i._bgCon.numChildren;++n)t=i._bgCon.getChildAt(n),(t.x+t.width<-i._bgCon.x||t.x>-i._bgCon.x+i.mapW||t.y+t.height<-i._bgCon.y||t.y>-i._bgCon.y+i.mapH)&&t.parent&&(t.parent.removeChild(t),e.MapTileView.removeTileView(t))},r.addRoleToMap=function(t){var i=this;if(i.stage){var n=new e.RoleView;n.setRole(t),i._roleCon.addChild(n),i.checkRoleGift(t);var o=new e.RoleNameView;o.setRole(t),i._effectCon.addChild(o);var r=new e.RoleShadowView;r.setRole(t),i._shadowCon.addChild(r)}i._allRoles.push(t)},r.getRoleView=function(t){for(var i=this,n=0;n<i._roleCon.numChildren;++n){var o=i._roleCon.getChildAt(n);if(o instanceof e.RoleView&&o.role==t)return o}return null},r.getGiftView=function(t){for(var i=this,n=0;n<i._roleCon.numChildren;++n){var o=i._roleCon.getChildAt(n);if(o instanceof e.GiftView&&o.gift.role==t)return o}return null},r.getRoleNameView=function(t){for(var i=this,n=0;n<i._effectCon.numChildren;++n){var o=i._effectCon.getChildAt(n);if(o instanceof e.RoleNameView&&o.role==t)return o}return null},r.getRoleShadowView=function(t){for(var i=this,n=0;n<i._shadowCon.numChildren;++n){var o=i._shadowCon.getChildAt(n);if(o instanceof e.RoleShadowView&&o.role==t)return o}return null},r.onMainRolePosChange=function(e){void 0===e&&(e=null);var t=this;if(t.moveToCenter(t.mainRole.x,t.mainRole.y),t.mainRole.isOnNodeCenter())for(var i=0;i<t._itemCon.numChildren;++i){var n=t._itemCon.getChildAt(i);n.x==t.mainRole.x&&n.y==t.mainRole.y&&(n.pickUp(),t.checkNextWave(!0))}},r.onMedalChange=function(){var e=this;e.mainRole&&(e.mainRole.medalId=gd.medalCtrl.getMedalTitle())},r.onEnterFrame=function(t){for(var i=this,n=0;n<i._allRoles.length;++n)l=i._allRoles[n],l.gift&&l.gift.exeAI();var o=new Date;if(0==i.lastExeAITime)i.lastExeAITime=o.getTime();else{if(o.getTime()-i.lastExeAITime<e.MINI_SPACE_TIME)return;i.lastExeAITime=i.lastExeAITime+e.MINI_SPACE_TIME}if(Date.newDate().getTime()-i.fightStartTime>=1e3*i._pvpTimeout){if(i._pvpType==gc.c_prop.fightTypeKey.arena){i.removeEventListener(egret.Event.ENTER_FRAME,i.onEnterFrame,i);var r={};return r[gc.dsConsts.FightData.isWin]=!1,r[gc.dsConsts.FightData.star]=0,r[gc.dsConsts.FightData.vData]={},void gd.arenaCtrl.fightEnd(!1,r,function(t){e.FightArenaWinOrFail.showCallback({isWin:!1,isTimeout:!0,fightResult:t,callback:function(){gd.fightCtrl.isSpFighting=!1,i.exitMap(i.mapID,function(){i.enterMap(i.mapID,!1),i.checkNextWave(),mo.moduleMgr.curModule.name==g_consts.moduleId.fight&&mo.moduleMgr.runModule(g_consts.moduleId.home,{subModuleId:g_consts.HS_SUBMID_ARENA}),i._pvpType=-1})},target:i,begTime:Date.newDate().getTime()+1e4})},i)}if(i._pvpType==gc.c_prop.fightTypeKey.pk||i._pvpType==gc.c_prop.fightTypeKey.rankPk){i.removeEventListener(egret.Event.ENTER_FRAME,i.onEnterFrame,i);var a=mo.getJSONWithFileNameAndID(gc.cfg_t_copy,gd.copyCtrl.getNormalCurCopyId()),s=a[gc.t_copy_displayID];return void gd.pkOutCtrl.end(!1,{},function(t){e.FightPKWinOrFail.showCallback({isWin:!1,isTimeout:!0,fightResult:t,callback:function(){gd.fightCtrl.isSpFighting=!1,i.exitMap(s,function(){i.enterMap(s,!0),i.checkNextWave(),i._pvpType==gc.c_prop.fightTypeKey.rankPk&&gd.pkOutCtrl.getRankList(function(t){e.PVPRank.create().setData({rankData:t}).show()},i),i._pvpType=-1})},target:i,begTime:Date.newDate().getTime()+1e4})},i)}i._pvpType==gc.c_prop.fightTypeKey.coffers&&gd.coffersCtrl.fightEnd(!1,function(t){e.FightCoffersWinOrFail.showCallback({isWin:!1,isTimeout:!0,fightResult:t,callback:function(){gd.fightCtrl.isSpFighting=!1,i.loots=[],i.exitMap(s,function(){i.enterMap(s,!0),i.checkNextWave(),i._pvpType=-1})},target:i,begTime:Date.newDate().getTime()+1e4})},i)}for(var l,n=0;n<i._allRoles.length;++n)if(l=i._allRoles[n],l==i.mainRole)if(i._isPicking){if(l.curState=e.Role.STATE_MOVE_TO_AIM,l.action==e.ROLE_ACTION_STAND&&i._itemCon.numChildren>0){i._isPicking=!0;var g=i._itemCon.getChildAt(i._itemCon.numChildren-1);i.mainRole.moveTo(g.row,g.col)}}else l.exeAI();else l.exeAI();for(var n=0;n<i._itemCon.numChildren;++n){var g=i._itemCon.getChildAt(n);g.canAutoPickUp()&&(g.pickUp(),n--)}for(var c=[],n=0;n<i._roleCon.numChildren;++n)c.push(i._roleCon.getChildAt(n));c.sort(function(e,t){return e.y-t.y});for(var n=0;n<c.length;++n)i._roleCon.setChildIndex(c[n],n)},r.myRoles=function(){return this._selfRoles},r.getHpInfos=function(){for(var e=this,t=0,i=0,n=0,o=0,r=0;r<e._selfRoles.length;r++){var a=e._selfRoles[r];t+=a.hp,i+=a.roleInfo.maxHpFight,n+=a.mp,o+=a.roleInfo.maxHp2Fight}return[t,i,n,o]},r.onMyRoleHpChange=function(t){this.dispatchEvent(new egret.Event(e.MAP_EVENT_HPMP_CHANGE))},i}(egret.Sprite);e.MapView=t,egret.registerClass(t,"g_fight.MapView")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return n._childrenCreated=function(){e.prototype._childrenCreated.call(this),this.outsideClosable=!0;var t=this;t.ico_avatar.setData({clothesID:null,weaponID:null,wingID:null,sex:0,isKing:!1})},n.dataChanged=function(){e.prototype.dataChanged.call(this);var t=this;t.pkUser=t.data.pkTarget||t.data.enemy,t.ico_title.source=t.data.pkTarget?"tit_txt_g_funjin":"tit_txt_g_wdcr"},n.onEnter=function(){var t=this;e.prototype.onEnter.call(this),t.invalidateSkinState();var i,n,o,r,a,s,l,g=t.pkUser;i=g[gc.dsConsts.PkOutUserData.name],n=g[gc.dsConsts.PkOutUserData.gold],o=g[gc.dsConsts.PkOutUserData.expc],r=g[gc.dsConsts.PkOutUserData.lvl],a=g[gc.dsConsts.PkOutUserData.pkValue],s=g[gc.dsConsts.PkOutUserData.vip],l=g[gc.dsConsts.PkOutUserData.userId];var c=t.getNameTxt(i);t.label_name.text=c,t.label_jb.text=n,t.label_exp.text=o,t.label_level.text=mo.STR.format("lv.%s",r);var a=a,_=mo.getJSONWithFileNameAndID(gc.cfg_c_game,gc.id_c_game.pkOutCfg),h=_[5],f=_[6];a>=f?(t.label_name.textColor=16711680,t.label_name.text=t.label_name.text):a>=h?(t.label_name.textColor=16773120,t.label_name.text=t.label_name.text):(t.label_name.textColor=16777215,t.label_name.text=t.label_name.text);var u=g[gc.dsConsts.PkOutUserData.guildName]?g[gc.dsConsts.PkOutUserData.guildName]:"";t.label_guild.text=""==u?"":mo.STR.format("[%s]",u);var m=78,d=mo.getJSONWithFileNameAndID(gc.cfg_t_item,m);t.ico_item.source=resHelper.getItemIconPath(m),t.label_item.text=d[gc.t_item_name],s>0?(t.label_vipLv.text=s.toString(),t.label_name.parent.addElementAt(t.grp_vip,0)):t.grp_vip.parent&&t.grp_vip.parent.removeElement(t.grp_vip),gd.heroCtrl.getHeroDisplayByTempId(l,0,function(e){t.ico_avatar.setData({clothesID:e[0],weaponID:e[1],wingID:e[2],sex:e[3],isKing:e[4]})
},this)},n.getCurrentSkinState=function(){var e=this;e.pkUser=e.data.pkTarget||e.data.enemy;var t=e.pkUser[gc.dsConsts.PkOutUserData.pkValue],i=mo.getJSONWithFileNameAndID(gc.cfg_c_game,gc.id_c_game.pkOutCfg),n=(i[5],i[6]);return t>=n?"red":"white"},n._tap_btn_attack=function(){var e=this,t=e.pkUser[gc.dsConsts.PkOutUserData.name],i=gd.pkOutCtrl.getPkValue(),n=mo.getJSONWithFileNameAndID(gc.cfg_c_game,gc.id_c_game.pkOutCfg),o=n[6];o>i&&i+n[1]>=o?mo.showMsg(gc.id_c_msgCode.nameToRedIfGo,function(){e.startPvp(t)}):e.startPvp(t)},n.startPvp=function(e){var t=this;gd.pkOutCtrl.start(this.pkUser[gc.dsConsts.PkOutUserData.userId],gc.c_prop.fightTypeKey.pk,t.data.pkTarget?0:1,function(t){var i=gd.heroCtrl.getFightList();gd.fightCtrl.startPvpFight(i,t,gc.c_prop.fightTypeKey.pk,e)},this),t.close()},n.getNameTxt=function(e){var t="",i=e.split(".");return i&&i.length>0&&(t=i[0]),t+".神秘玩家"},t}(mo.gui.Dlg);e.PVPBattle=t,egret.registerClass(t,"g_fight.PVPBattle")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return n._initProp=function(){e.prototype._initProp.call(this);var t=this;t._Item_list_items=g_base.BaseItemCell},n._childrenCreated=function(){e.prototype._childrenCreated.call(this);var t=this;t.ico_chou.visible=!1},n.dataChanged=function(){e.prototype.dataChanged.call(this);var t=this,i=t.data[gc.dsConsts.ArenaRecordEntity.enemyName],n=t.data[gc.dsConsts.ArenaRecordEntity.fightTime],o=t.data[gc.dsConsts.ArenaRecordEntity.fightData],r=t.data[gc.dsConsts.ArenaRecordEntity.isWin],a=t.data[gc.dsConsts.ArenaRecordEntity.enemyId]!=t.data[gc.dsConsts.ArenaRecordEntity.userId];t.ico_chou.visible=t.data[gc.dsConsts.ArenaRecordEntity.isRevenge],a?t.ico_pkState.source=r?"ico_pvp_atk_win":"ico_pvp_atk_fail":t.ico_pkState.source=r?"ico_pvp_win":"ico_pvp_fail",t.label_time.text=mo.getBetweenTimeString(Date.newDate(),Date.newDate(n)),t.label_name.text=i,t.label_killValue.text=o.killValue>0?"+"+o.killValue:o.killValue,t.label_exp.text=o.expc,t.label_jb.text=o.gold,t.label_gain.visible=t.label_lose.visible=!1;var s=utils.itemObj2ObjArr(o.items);r&&s.length>0&&(t.label_gain.visible=!0),!r&&s.length>0&&(t.label_lose.visible=!0),t.list_items.dataProvider=new egret.gui.ArrayCollection(s)},t}(mo.gui.ItemRenderer);e.PVPLogItem=t,egret.registerClass(t,"g_fight.PVPLogItem")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(t){function i(){t.apply(this,arguments)}__extends(i,t);var n=(__define,i),o=n.prototype;return o._initProp=function(){var i=this;t.prototype._initProp.call(this),i._Item_list_log=e.PVPLogItem},o._childrenCreated=function(){t.prototype._childrenCreated.call(this),this.outsideClosable=!0},o.onEnter=function(){t.prototype.onEnter.call(this)},o._data_list_log=function(){var e=this;return e.data.logData},i}(mo.gui.Dlg);e.PVPLog=t,egret.registerClass(t,"g_fight.PVPLog")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(t){function i(){t.apply(this,arguments)}__extends(i,t);var n=(__define,i),o=n.prototype;return o._initProp=function(){var e=this;t.prototype._initProp.call(this),e.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTap,this)},o.onEnter=function(){t.prototype.onEnter.call(this)},o._childrenCreated=function(){t.prototype._childrenCreated.call(this);var e=this,i=uiHelper.getHeroIcon(e.data[gc.dsConsts.PkOutUserData.iconId],0);mo.R.loadTo("FightScene",i,function(){}),e.ico_role.source=i},o.onTap=function(t){var i=this;e.PVPBattle.create().setData({pkTarget:i.data}).show()},i}(mo.gui.Comp);e.FightEnemyCell=t,egret.registerClass(t,"g_fight.FightEnemyCell")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return n._childrenCreated=function(){e.prototype._childrenCreated.call(this)},n.dataChanged=function(){e.prototype.dataChanged.call(this);var t=this,i=t.data,n=i[gc.dsConsts.Rank.rank],o=gd.pkOutCtrl.getRankAward(n),r=["1st","2nd","3rd"];t.label_name.text=i[gc.dsConsts.Rank.name],t.label_name.textColor=uiHelper.getUserNameColor(i[gc.dsConsts.Rank.pkValue]),t.label_lvl.text=i[gc.dsConsts.Rank.lvl].toString(),t.label_combat.text=i[gc.dsConsts.Rank.combat].toString(),t.label_killValue.text=i[gc.dsConsts.Rank.killValue].toString();var a=i[gc.dsConsts.Rank.guildName]?i[gc.dsConsts.Rank.guildName]:"";t.label_guild.text=""==a?"":mo.STR.format("[%s]",a),3>=n?(t.ico_rank.source="ico_arena_"+r[n-1],t.ico_rank.visible=!0,t.label_rank.visible=!1,gd.userCtrl.getId()==i[gc.dsConsts.Rank.userId]||gd.pkOutCtrl.isTodayRankWin(i[gc.dsConsts.Rank.userId])?t.btn_challenge.visible=!1:t.btn_challenge.visible=!0):(t.label_rank.text=n,t.ico_rank.visible=!1,t.label_rank.visible=!0,t.btn_challenge.visible=!1),t.ico_head.setData({icoId:i[gc.dsConsts.Rank.iconId],vip:i[gc.dsConsts.Rank.vip]}),uiHelper.setResGrp(t.grp_res0,gc.c_prop.spItemIdKey.gold,o[1]),uiHelper.setResGrp(t.grp_res1,gc.c_prop.spItemIdKey.starStone,o[0])},n._tap_btn_challenge=function(){var e=this,t=e.data;gd.pkOutCtrl.start(t[gc.dsConsts.Rank.userId],gc.c_prop.fightTypeKey.rankPk,0,function(i){var n=gd.heroCtrl.getFightList();gd.fightCtrl.startPvpFight(n,i,gc.c_prop.fightTypeKey.rankPk,t[gc.dsConsts.Rank.name]),e.delegate.close()},e)},t}(mo.gui.ItemRenderer);e.PVPRankItem=t,egret.registerClass(t,"g_fight.PVPRankItem")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(t){function i(){t.apply(this,arguments)}__extends(i,t);var n=(__define,i),o=n.prototype;return o._initProp=function(){t.prototype._initProp.call(this);var e=this;e.registerClassByKey(gd.PkOutCtrl,gc.dsConsts.PkOutEntity.pkValue.toString(),e.reset),e.registerClassByKey(gd.UserCtrl,gc.dsConsts.UserEntity.redPointData.toString(),e.checkRedPoint)},o.checkRedPoint=function(){this.ico_red.visible=gd.pointCtrl.isShow(gc.c_prop.pointRedKey.pkout1)},o._childrenCreated=function(){t.prototype._childrenCreated.call(this);var e=this;e.ico_role.source=uiHelper.getHeroIcon(gd.userCtrl.getIconId(),0),e.checkRedPoint(),this.bar_pk.labelFunction=function(e,t){return""},this.bar_pk.value=0;var i=this.bar_pk.slideDuration;this.bar_pk.slideDuration=0,this.bar_pk.validateDisplayList(),this.bar_pk.slideDuration=i,e.reset()},o._tap_btn_rank=function(){gd.pkOutCtrl.getRankList(function(t){e.PVPRank.create().setData({rankData:t}).show()},this)},o._tap_btn_log=function(){gd.pkOutCtrl.getPkRecordList(function(t){e.PVPLog.create().setData({logData:t}).show()},this),gd.pkOutCtrl.setNewDeal(!1)},o.onEnter=function(){var e=this;t.prototype.onEnter.call(this),e.reset()},o.reset=function(){var e=this,t=gd.pkOutCtrl.getPkValue(),i=gd.pkOutCtrl.getKillValue(),n=mo.getJSONWithFileNameAndID(gc.cfg_c_game,gc.id_c_game.pkOutCfg),o=n[5],r=n[6];t>=r?(e.ico_light.x=306,e.label_name.textColor=e.label_pkAddDesc.textColor=16711680,e.label_pkAddDesc.text="红名会被掠夺金币和背包物品"):t>=o?(e.ico_light.x=203,e.label_name.textColor=e.label_pkAddDesc.textColor=16773120,e.label_pkAddDesc.text="黄名保护：被击杀不受损失。"):(e.ico_light.x=54,e.label_name.textColor=e.label_pkAddDesc.textColor=16777215,e.label_pkAddDesc.text="白名保护：被击杀不受损失。"),e.label_name.text=gd.userCtrl.getName();var n=mo.getJSONWithFileNameAndID(gc.cfg_c_game,gc.id_c_game.pkCfg1);e.label_noExpTip.text=mo.STR.format("每天主动寻找对手%s次后将不再获得经验奖励",n[0]),e.label_myKillValue.text=i.toString(),e.label_pk.text=t.toString(),e.label_pkYellow.text=o.toString(),e.label_pkRed.text=r.toString(),e.bar_pk.maximum=100,e.bar_pk.value=t,e.grp_pk&&(t<=e.bar_pk.maximum?e.grp_pk.x=65+e.bar_pk.width*(e.bar_pk.value/e.bar_pk.maximum):e.grp_pk.x=405)},o._tap_btn_help=function(){var e=mo.getJSONWithFileNameAndID(gc.cfg_c_game,gc.id_c_game.pkCfg1),t=mo.getJSONWithFileNameAndID(gc.cfg_c_game,gc.id_c_game.pkOutCfg),i=e[0],n=t[0],o=t[11];g_base.BaseShowTip.create().setData({id:2,param1:i,param2:n,param3:o}).show()},o._tap_btn_clearRedPoint=function(){var e=this;gd.pkOutCtrl.clearPkValue(function(){e.reset()},e)},i}(mo.gui.Layer);e.PVPSelfInfo=t,egret.registerClass(t,"g_fight.PVPSelfInfo")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return n.dataChanged=function(){e.prototype.dataChanged.call(this);var t=this;null!=t.data[gc.c_pvpRankReward_id]&&(t.data[gc.c_pvpRankReward_id]>20&&(t.label_rank.size=18),t.label_rank.text=t.data[gc.c_pvpRankReward_name],uiHelper.setResGrp(t.grp_res0,gc.c_prop.spItemIdKey.gold,t.data[gc.c_pvpRankReward_gold]),uiHelper.setResGrp(t.grp_res1,gc.c_prop.spItemIdKey.starStone,t.data[gc.c_pvpRankReward_starStone]))},t}(mo.gui.ItemRenderer);e.PvpRankRewardCell=t,egret.registerClass(t,"g_fight.PvpRankRewardCell")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(t){function i(){t.apply(this,arguments)}__extends(i,t);var n=(__define,i),o=n.prototype;return o._childrenCreated=function(){t.prototype._childrenCreated.call(this),this.outsideClosable=!0},o._initProp=function(){t.prototype._initProp.call(this);var i=this;i._Item_list_items=e.PvpRankRewardCell},o._data_list_items=function(){var e=mo.getJSONWithFileName(gc.cfg_c_pvpRankReward),t=[];for(var i in e)t.push(e[i]);return t},i}(mo.gui.Dlg);e.PvpRankReward=t,egret.registerClass(t,"g_fight.PvpRankReward")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(t){function i(){t.apply(this,arguments)}__extends(i,t);var n=(__define,i),o=n.prototype;return o._childrenCreated=function(){t.prototype._childrenCreated.call(this);var e=this;this.outsideClosable=!0,e.checkRedPoint()},o._initProp=function(){var i=this;t.prototype._initProp.call(this),i._Item_list_rank=e.PVPRankItem,i.registerClassByKey(gd.UserCtrl,gc.dsConsts.UserEntity.redPointData.toString(),this.checkRedPoint)},o.onEnter=function(){t.prototype.onEnter.call(this);var e=this,i=gd.pkOutCtrl.getKillValue();e.label_myKillValue.text=i.toString(),gd.pkOutCtrl.getMyRank(function(t){e.label_myRank.text=t.toString();var i=gd.pkOutCtrl.getRankAward(t);uiHelper.setResGrp(e.grp_res0,gc.c_prop.spItemIdKey.gold,i[1]),uiHelper.setResGrp(e.grp_res1,gc.c_prop.spItemIdKey.starStone,i[0])},e)},o.dataChanged=function(){t.prototype.dataChanged.call(this)},o.checkRedPoint=function(){this.ico_red.visible=gd.pointCtrl.isShow(gc.c_prop.pointRedKey.rankPk)},o._data_list_rank=function(){var e=this;return e.data.rankData},o._tap_btn_info=function(){e.PvpRankReward.create().show()},o._tap_btn_challengeLog=function(){gd.pkOutCtrl.getRankPkRecordList(function(t){e.ChallengeLog.create().setData({logData:t}).show()},this),gd.pkOutCtrl.setRankPkNewDeal(!1)},i}(g_base.CloseInfoDlg);e.PVPRank=t,egret.registerClass(t,"g_fight.PVPRank")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments),this.outsideClosable=!0}__extends(t,e);var i=(__define,t),n=i.prototype;return n._initProp=function(){e.prototype._initProp.call(this);var t=this;t.registerClassByKey(gd.UserCtrl,gc.dsConsts.UserEntity.expc.toString(),t._updateExp),t.registerClassByKey(gd.CopyCtrl,gd.CopyCtrl.ON_COPY_CHANGE,t._updateProfit)},n._childrenCreated=function(){e.prototype._childrenCreated.call(this);var t=this;this._updateExp(),this._updateProfit();var i=mo.getJSONWithFileNameAndID(gc.cfg_c_open,gc.id_c_open.expBox),n=i[gc.c_open_lvlRequired];if(gd.userCtrl.getLvl()>=n){var o=gd.demonLotusCtrl.getData(),r=o[gc.dsConsts.DemonLotusEntity.lvl],a=mo.getJSONWithFileNameAndID(gc.cfg_c_lvl,r),s=o[gc.dsConsts.DemonLotusEntity.advanceLvl]||0,l=mo.getJSONWithFileNameAndID(gc.cfg_c_demonLotus,s);t.label_curExpLv.text=r.toString(),t.label_expTotal.text=utils.formatByWan(gd.demonLotusCtrl.calNowGet()>>0,1)+"/"+utils.formatByWan(a[gc.c_lvl_storeLimit]+l[gc.c_demonLotus_expcAccLimit],1),t.label_expPer.text=utils.formatByWan(60*a[gc.c_lvl_expOutput],0)+"/分钟",t.grp_expOpen.visible=!0,t.grp_expNoOpen.visible=!1}else t.label_expOpenLv.text=n,t.grp_expOpen.visible=!1,t.grp_expNoOpen.visible=!0},n._updateProfit=function(){var e=this,t=gd.copyCtrl.getNormalCopyProfit(),i=gd.fightCtrl.getExpcRate(),n="";i>1&&(n="[ubb color=green](×"+i+")[/ubb]"),e.label_profit_gold.text=utils.formatByWan(t[0]),e.label_profit_exp.text=utils.formatByWan(t[7]+n)},n._updateExp=function(){var e=this,t=gd.fightCtrl.getExpcRate(),i=gd.copyCtrl.getNormalCopyProfit(),n="人物已达最高等级",o="人物升级至[ubb color=yellow]Lv.%s[/ubb]还需经验[ubb color=yellow]%s[/ubb]，约需要[ubb color=yellow]%s[/ubb]",r="杀怪统计：%s波怪/小时 \n每小时掉落统计：\n    装备：%s件[/br]",a="",s=i[8],l=i[9],g=i[6];if("--"!=g?g=utils.formatHour(g/t):g+="小时",s.length>0){for(var c=0;c<s.length;++c){var _=mo.getJSONWithFileNameAndID(gc.cfg_t_item,s[c][0]);if(a+="    "+_[gc.t_item_name]+": 约"+s[c][1]+"个",l[c]){var h=mo.getJSONWithFileNameAndID(gc.cfg_t_item,l[c][0]);a+="		"+h[gc.t_item_name]+": 约"+l[c][1]+"个"}a+="\n"}r+=a}gd.userCtrl.isMaxLvl()?e.label_tips.text=mo.STR.format(r,i[2],i[3])+n:(r+=o,e.label_tips.text=mo.STR.format(r,i[2],i[3],i[4],utils.formatByWan(i[5]),g)),e.label_noExp.text=mo.STR.format("若人物等级高于小怪等级%s级，则打小怪不获得任何收益",mo.getJSONWithFileNameAndID(gc.cfg_c_game,gc.id_c_game.lootLimit))},n._tap_btn_get=function(){mo.moduleMgr.runModule(g_consts.moduleId.lotus)},t}(mo.gui.Dlg);e.FightProfitDlg=t,egret.registerClass(t,"g_fight.FightProfitDlg")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(t){function i(){t.apply(this,arguments)}__extends(i,t);var n=(__define,i),o=n.prototype;return o._initProp=function(){t.prototype._initProp.call(this)},o._childrenCreated=function(){t.prototype._childrenCreated.call(this)},o.setVisible=function(e){var t=this;t.img_detail.visible=e},o._tap_img_detail=function(){var t=this,i=mo.getJSONWithFileName(gc.cfg_c_open),n=gd.userCtrl.getLvl(),o=i[gc.id_c_open.expBox][gc.c_open_lvlRequired];o>n?e.FightProfitDlg.create().show():gd.demonLotusCtrl.getInfo(function(t){e.FightProfitDlg.create().show()},t)},i}(mo.gui.Layer);e.FightProfit=t,egret.registerClass(t,"g_fight.FightProfit")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(t){function i(){t.apply(this,arguments)}__extends(i,t);var n=(__define,i),o=n.prototype;return o._childrenCreated=function(){t.prototype._childrenCreated.call(this),this.outsideClosable=!0},o._initProp=function(){var i=this;t.prototype._initProp.call(this),i._helpDataId=15,i._Item_list_enemies=e.EnemyItem},o.dataChanged=function(){t.prototype.dataChanged.call(this);var e=this;e.ico_none.visible=!e.data.list||0==e.data.list.length},o._data_list_enemies=function(){var e=this;return e.data.list},i}(g_base.CloseInfoDlg);e.EnemyList=t,egret.registerClass(t,"g_fight.EnemyList")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(t){function i(){t.apply(this,arguments)}__extends(i,t);var n=(__define,i),o=n.prototype;return o.dataChanged=function(){t.prototype.dataChanged.call(this);var e=this,i=e.data;if(!i.hasOwnProperty("label")){e.label_name.text=i[gc.dsConsts.PkOutUserData.name],e.label_name.textColor=uiHelper.getUserNameColor(i[gc.dsConsts.PkOutUserData.pkValue]),e.label_lv.text=mo.STR.format("Lv.%s",i[gc.dsConsts.PkOutUserData.lvl]),e.label_combat.text=mo.STR.format("战斗力：%s",i[gc.dsConsts.PkOutUserData.combat]),e.ico_head.setData({icoId:i[gc.dsConsts.PkOutUserData.iconId],vip:i[gc.dsConsts.PkOutUserData.vip]});var n=i[gc.dsConsts.PkOutUserData.guildName]?i[gc.dsConsts.PkOutUserData.guildName]:"";e.label_guild.text=""==n?"":mo.STR.format("[%s]",n)}},o._tap_btn_fight=function(){var t=this;e.PVPBattle.create().setData({enemy:t.data}).show(),t.delegate.close()},i}(mo.gui.ItemRenderer);e.EnemyItem=t,egret.registerClass(t,"g_fight.EnemyItem")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return n._initProp=function(){e.prototype._initProp.call(this);var t=this;t._Item_list_items=g_base.BaseItemCell},n._childrenCreated=function(){e.prototype._childrenCreated.call(this)},n.dataChanged=function(){e.prototype.dataChanged.call(this);var t=this,i=t.data[gc.dsConsts.ArenaRecordEntity.enemyName],n=t.data[gc.dsConsts.ArenaRecordEntity.fightTime],o=t.data[gc.dsConsts.ArenaRecordEntity.fightData],r=t.data[gc.dsConsts.ArenaRecordEntity.isWin],a=t.data[gc.dsConsts.ArenaRecordEntity.enemyId]!=t.data[gc.dsConsts.ArenaRecordEntity.userId];a?t.ico_pkState.source=r?"ico_pvp_atk_win":"ico_pvp_atk_fail":t.ico_pkState.source=r?"ico_pvp_win":"ico_pvp_fail",t.label_time.text=mo.getBetweenTimeString(Date.newDate(),Date.newDate(n)),t.label_name.text=i,t.label_killValue.text=o.killValue>0?"+"+o.killValue:o.killValue,t.label_exp.text=o.expc,t.label_jb.text=o.gold,t.label_gain.visible=t.label_lose.visible=!1;var s=utils.itemObj2ObjArr(o.items);r&&s.length>0&&(t.label_gain.visible=!0),!r&&s.length>0&&(t.label_lose.visible=!0),t.list_items.dataProvider=new egret.gui.ArrayCollection(s)},t}(mo.gui.ItemRenderer);e.ChallengeLogItem=t,egret.registerClass(t,"g_fight.ChallengeLogItem")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(t){function i(){t.apply(this,arguments)}__extends(i,t);var n=(__define,i),o=n.prototype;return o._initProp=function(){var i=this;t.prototype._initProp.call(this),i._Item_list_log=e.ChallengeLogItem},o._childrenCreated=function(){t.prototype._childrenCreated.call(this),this.outsideClosable=!0},o.onEnter=function(){t.prototype.onEnter.call(this)},o._data_list_log=function(){var e=this;return e.data.logData},i}(mo.gui.Dlg);e.ChallengeLog=t,egret.registerClass(t,"g_fight.ChallengeLog")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return n._childrenCreated=function(){e.prototype._childrenCreated.call(this)},n.dataChanged=function(){e.prototype.dataChanged.call(this);var t=this,i=t.data.result,n=(t.data.fec,i[gc.dsConsts.BossResult.bossId]),o=i[gc.dsConsts.BossResult.items],r=i[gc.dsConsts.BossResult.myHurtRank];if(3>=r){var a=["1st","2nd","3rd"];t.ico_rank.source="ico_arena_"+a[r-1],t.ico_rank.visible=!0,t.label_rank.visible=!1}else t.label_rank.text=r,t.ico_rank.visible=!1,t.label_rank.visible=!0;uiHelper.setItemsGrp(t.grp_rankReward,utils.itemObj2ObjArr(o));var s=i[gc.dsConsts.BossResult.killUserName],l=s==gd.userCtrl.getName();if(t.grp_killReward.visible=l,t.img_killReward.visible=l,l){var g=mo.getJSONWithFileNameAndID(gc.cfg_c_bossWorld,n),c=g[gc.c_bossWorld_lastShotAward];c.push(g[gc.c_bossWorld_treasureAward]),uiHelper.setItemsGrp(t.grp_killReward,utils.kvArrItems2ObjArr(c))}t.label_damage.text=i[gc.dsConsts.BossResult.totalHurt],t.label_first.text=i[gc.dsConsts.BossResult.firstHurtName],t.label_last.text=i[gc.dsConsts.BossResult.killUserName],t.label_time.text=mo.getTimeStr(1e3*i[gc.dsConsts.BossResult.killTotalTime])},t}(e.FightDlg);e.WBossWin=t,egret.registerClass(t,"g_fight.WBossWin")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return n._childrenCreated=function(){e.prototype._childrenCreated.call(this)},n.dataChanged=function(){e.prototype.dataChanged.call(this);var t=this,i=t.data.result,n=t.data.fec,o=i[gc.dsConsts.BossResult.myHurtRank];t.label_rank.text=o;var r=i[gc.dsConsts.BossResult.items];uiHelper.setItemsGrp(t.grp_reward,utils.itemObj2ObjArr(r)),t.label_damage.text=i[gc.dsConsts.BossResult.totalHurt],t.label_first.text=i[gc.dsConsts.BossResult.firstHurtName],t.label_leftHp.text=utils.formatByWan(n.getCurHp())},t}(e.FightDlg);e.WBossFail=t,egret.registerClass(t,"g_fight.WBossFail")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return n._childrenCreated=function(){e.prototype._childrenCreated.call(this);var t=this;t.ico_item.label_text.visible=!1,t.ico_item.onClick(function(){g_base.BaseItemDetail.create().setData({bdc:gd.BagDataCtrl.create(this.get("itemId"),null)}).show()},t.ico_item)},n.dataChanged=function(){e.prototype.dataChanged.call(this);var t=this,i=t.data.result,n=(t.data.fec,i[gc.dsConsts.BossResult.bossId]),o=i[gc.dsConsts.BossResult.myHurtRank];if(3>=o){var r=["1st","2nd","3rd"];t.ico_rank.source="ico_arena_"+r[o-1],t.ico_rank.visible=!0,t.label_rank.visible=!1}else t.label_rank.text=o,t.ico_rank.visible=!1,t.label_rank.visible=!0;var a,s=mo.getJSONWithFileNameAndID(gc.cfg_c_bossParameter,n);1==o?a=s[gc.c_bossParameter_rankAward1][0]:o>=2&&5>=o?a=s[gc.c_bossParameter_rankAward2][0]:o>=6&&10>=o&&(a=s[gc.c_bossParameter_rankAward3][0]),a?(t.ico_item.visible=!0,t.ico_item.setData({itemId:a[0],count:a[1]})):t.ico_item.visible=!1,t.label_damage.text=i[gc.dsConsts.BossResult.totalHurt],t.label_reward.text=i[gc.dsConsts.BossResult.hurtGold],t.label_time.text=mo.getTimeStr(1e3*i[gc.dsConsts.BossResult.killTotalTime]),t.label_first.text=i[gc.dsConsts.BossResult.firstHurtName],t.label_last.text=i[gc.dsConsts.BossResult.killUserName]},n._tap_btn_close=function(){},n.onExit=function(){e.prototype.onExit.call(this);var t=this;null!=t.data.callback&&t.data.callback.call(t.data.target),t.timeTrigger&&(tm.timer.remove(t.timeTrigger),t.timeTrigger=null)},n.setCDTime=function(e){var t=this;if(e>0){t.timeTrigger&&(tm.timer.remove(t.timeTrigger),t.timeTrigger=null);var i=Date.newDate(Date.newDate().getTime()+1e3*e),n=t.timeTrigger=new tm.Trigger(i);n.on(tm.Trigger.ON_SECOND,t.timeSec,t),n.on(tm.Trigger.ON_END,t.timeOut,t),tm.timer.add(n),t.btn_close.label=mo.STR.format("返回(%s)",e.toString())}},n.timeSec=function(e,t,i){var n=this,o=Date.newDate().getTime(),r=Date.newDate(i).getTime(),a=r-o;n.btn_close.label=mo.STR.format("返回(%s)",Math.floor(a/1e3).toString())},n.timeOut=function(e,t,i){var n=this;n.close()},t}(e.FightDlg);e.GuildBossWin=t,egret.registerClass(t,"g_fight.GuildBossWin")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return n.dataChanged=function(){e.prototype.dataChanged.call(this);var t=this,i=t.data.result,n=t.data.fec;t.label_damage.text=i[gc.dsConsts.BossResult.totalHurt],t.label_leftHp.text=n.getCurHp()},n._tap_btn_forge=function(){mo.moduleMgr.runModule(g_consts.moduleId.forge)},n._tap_btn_shop=function(){mo.moduleMgr.runModule(g_consts.moduleId.shop)},n._tap_btn_close=function(){},t}(e.FightDlg);e.GuildBossFail=t,egret.registerClass(t,"g_fight.GuildBossFail")}(g_fight||(g_fight={}));var g_fight;!function(e){var t=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return n._initProp=function(){e.prototype._initProp.call(this)},n._childrenCreated=function(){e.prototype._childrenCreated.call(this)},n.dataChanged=function(){var t=this,i=t.data.begTime;e.prototype.dataChanged.call(this);var n=t.data.result;uiHelper.setItemsGrp(t.grp_rankReward,utils.itemObj2ObjArr(n[2])),t.invalidateSkinState();var o=Math.ceil((i-Date.newDate().getTime())/1e3);t.setCDTime(o)},n.getCurrentSkinState=function(){var e=this,t=!0;return e.data&&(t=e.data.result[0]),t?"win":"fail"},n.onExit=function(){e.prototype.onExit.call(this);var t=this;null!=t.data.callback&&t.data.callback.call(t.data.target),t.timeTrigger&&(tm.timer.remove(t.timeTrigger),t.timeTrigger=null)},n.setCDTime=function(e){var t=this;if(e>0){t.timeTrigger&&(tm.timer.remove(t.timeTrigger),t.timeTrigger=null);var i=Date.newDate(Date.newDate().getTime()+1e3*e),n=t.timeTrigger=new tm.Trigger(i);n.on(tm.Trigger.ON_SECOND,t.timeSec,t),n.on(tm.Trigger.ON_END,t.timeOut,t),tm.timer.add(n),t.btn_back.label=mo.STR.format("确定(%s)",e.toString())}},n.timeSec=function(e,t,i){var n=this,o=Date.newDate().getTime(),r=Date.newDate(i).getTime(),a=r-o;n.btn_back.label=mo.STR.format("确定(%s)",Math.floor(a/1e3).toString())},n.timeOut=function(e,t,i){var n=this;n._tap_btn_back()},n._tap_btn_back=function(){var e=this;e.close();var t=gd.guildCopyCtrl.curFightGuildBossId,i=gd.guildCopyCtrl.getSectionIdByBossId(t);mo.moduleMgr.runModule(g_consts.moduleId.home,{subModuleId:g_consts.HS_SUBMID_GUILD_COPY_BOSS,section:mo.getJSONWithFileNameAndID(gc.cfg_t_guildCopy,i)})},n._tap_btn_forge=function(){mo.moduleMgr.runModule(g_consts.moduleId.forge)},n._tap_btn_shop=function(){mo.moduleMgr.runModule(g_consts.moduleId.shop)},t}(e.FightDlg);e.GuildCopyBossWinOrFail=t,egret.registerClass(t,"g_fight.GuildCopyBossWinOrFail")}(g_fight||(g_fight={}));